// =============================================================================
// SCRIPT NODE.JS : Diagnostic rapide de l'erreur companyId
// Usage : node diagnostic.js
// =============================================================================

const fs = require('fs');
const path = require('path');

console.log('\n================================================');
console.log('üîç DIAGNOSTIC ERREUR COMPANYID');
console.log('================================================\n');

// 1. V√©rifier ocrController.js
console.log('1Ô∏è‚É£ V√©rification de ocrController.js...');
console.log('================================================');

const ocrPath = path.join(process.cwd(), 'controllers', 'ocrController.js');

if (fs.existsSync(ocrPath)) {
    console.log('‚úÖ Fichier existe:', ocrPath);
    
    const content = fs.readFileSync(ocrPath, 'utf8');
    const lines = content.split('\n');
    
    console.log('   üìä Nombre de lignes:', lines.length);
    
    // Chercher les validations
    if (content.includes('VALIDATION 1 : UTILISATEUR')) {
        console.log('   ‚úÖ Contient les validations corrig√©es');
    } else {
        console.log('   ‚ùå NE CONTIENT PAS les validations corrig√©es');
        console.log('   ‚ö†Ô∏è  Le fichier n\'a PAS √©t√© remplac√© correctement !');
    }
    
    // Trouver la ligne avec companyId
    const companyIdLine = lines.findIndex(line => 
        line.includes('const companyId') && 
        line.includes('req.validatedCompanyId') &&
        !line.includes('//')
    );
    
    if (companyIdLine !== -1) {
        console.log('\n   üìç Ligne avec companyId trouv√©e:', companyIdLine + 1);
        console.log('   üìÑ Contenu:');
        
        // Afficher 5 lignes autour
        for (let i = Math.max(0, companyIdLine - 2); i < Math.min(lines.length, companyIdLine + 8); i++) {
            const marker = i === companyIdLine ? '>>> ' : '    ';
            console.log(marker + (i + 1) + ':', lines[i]);
        }
    }
    
} else {
    console.log('‚ùå Fichier ocrController.js introuvable !');
    console.log('   Chemin recherch√©:', ocrPath);
}

console.log('\n================================================');
console.log('‚úÖ DIAGNOSTIC TERMIN√â');
console.log('================================================\n');

console.log('üìã INTERPR√âTATION :');
console.log('   - Si "NE CONTIENT PAS les validations" ‚Üí Remplacer le fichier');
console.log('   - Si ligne montre "const companyId = req.validatedCompanyId;" sans fallback ‚Üí Probl√®me confirm√©');
console.log('   - Si validations pr√©sentes mais erreur persiste ‚Üí V√©rifier qu\'il n\'y a pas un cache ou que le serveur a red√©marr√©');
console.log('');
