<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOUK√à Compta Pro - Syst√®me Comptable SYSCOHADA Int√©gr√©</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-light': '#8B8BF0',
                        'primary-dark': '#1E40AF',
                        secondary: '#1D4ED8',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        info: '#3B82F6'
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { opacity: 0; transition: opacity 0.3s ease; }
        .modal-backdrop.show { opacity: 1; }
        .modal { transform: translate(-50%, -50%) scale(0.95); transition: transform 0.3s ease; }
        .modal.show { transform: translate(-50%, -50%) scale(1); }
    </style>
</head>
<body class="h-full bg-gray-100 dark:bg-gray-900">

    <div id="loginView" class="flex items-center justify-center min-h-screen">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md fade-in">
            <h1 class="text-3xl font-bold text-center text-primary mb-6">DOUK√à Compta Pro</h1>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-8">Connexion au Syst√®me Unifi√© SYSCOHADA</p>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                    <input type="email" id="email" required value="admin@douke.com" class="mt-1 w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mot de passe</label>
                    <input type="password" id="password" required value="123456" class="mt-1 w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <button type="submit" class="w-full py-3 px-4 bg-primary text-white font-semibold rounded-lg hover:bg-primary-dark transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i> Se Connecter
                </button>
                <div id="loginMessage" class="mt-4 text-sm text-center text-danger"></div>
            </form>
        </div>
    </div>

    <div id="dashboardView" class="hidden h-full">
        <div class="flex h-full">
            <nav id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-xl transition-transform duration-300 ease-in-out transform -translate-x-full md:translate-x-0 flex-shrink-0">
                <div class="p-6">
                    <h2 class="text-2xl font-extrabold text-primary">DOUK√à</h2>
                    <span class="text-xs text-gray-500 dark:text-gray-400">SYSCOHADA Pro</span>
                </div>
                <div id="roleNavigation" class="space-y-2 p-4">
                    </div>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <button id="logout-button" class="w-full flex items-center justify-center py-2 px-3 bg-danger text-white rounded-lg hover:bg-red-700 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i> D√©connexion
                    </button>
                </div>
            </nav>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 dark:bg-gray-900">
                <header class="flex items-center justify-between p-4 md:p-6 bg-white dark:bg-gray-800 shadow-md">
                    <div class="flex items-center space-x-4">
                        <button id="menu-toggle" class="md:hidden text-gray-500 dark:text-gray-400 hover:text-primary">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h2 id="welcome-message" class="text-xl font-semibold text-primary">Bienvenue !</h2>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div id="company-selector-container" class="hidden">
                            <label for="entreprise" class="block text-xs font-medium text-gray-700 dark:text-gray-300">Entreprise :</label>
                            <select id="entreprise" onchange="window.unifiedManager.selectCompany(this.value)" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </select>
                        </div>
                        
                        <div class="flex flex-col items-end">
                            <span class="text-sm font-medium">R√¥le: 
                                <strong id="current-role" class="text-danger">-- R√îLE --</strong>
                            </span>
                        </div>
                    </div>
                </header>

                <div class="p-4 md:p-8">
                    <div id="mainContent" class="w-full fade-in">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-chart-line text-6xl mb-4"></i>
                            <h3 class="text-lg font-semibold">Chargement du Tableau de Bord...</h3>
                            <div class="loading-spinner mx-auto mt-4"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="notification-zone" aria-live="assertive" class="fixed inset-0 flex items-end px-4 py-6 pointer-events-none sm:p-6 z-50"></div>
    <div id="modalContainer"></div>

    <script>
        // Simuler la base de donn√©es (Data Layer)
        const mockData = {
            users: [
                { id: 1, name: 'Admin Principal', email: 'admin@douke.com', password: '123456', role: 'ADMIN', status: 'Actif', assignedCompanies: [101, 102], cashRegisterId: null },
                { id: 2, name: 'Collaborateur Senior', email: 'collab@douke.com', password: '123456', role: 'COLLABORATEUR', status: 'Actif', assignedCompanies: [101], cashRegisterId: null },
                { id: 3, name: 'Utilisateur Simple', email: 'user@douke.com', password: '123456', role: 'USER', status: 'Actif', assignedCompanies: [101], cashRegisterId: null },
                { id: 4, name: 'Caissier Principal', email: 'caisse@douke.com', password: '123456', role: 'CAISSIER', status: 'Actif', assignedCompanies: [102], cashRegisterId: 201 },
                { id: 5, name: 'Admin Secondaire', email: 'admin2@douke.com', password: '123456', role: 'ADMIN', status: 'Inactif', assignedCompanies: [102], cashRegisterId: null }
            ],
            companies: {
                101: { id: 101, nom: 'Alpha Consult S.A.', secteur: 'Conseil', systemeComptable: 'normal' },
                102: { id: 102, nom: 'Beta Logistique SARL', secteur: 'Transport', systemeComptable: 'minimal' }
            },
            entries: [
                // Mock entries for filtering demo
                { id: 1, companyId: 101, journal: 'JA', date: '2025-01-15', libelle: 'Achat de fournitures', debit: 500, credit: 500, status: 'Valid√©', creatorId: 3, lines: [] },
                { id: 2, companyId: 102, journal: 'CR', date: '2025-01-16', libelle: 'Encaissement Client', debit: 200, credit: 200, status: 'En attente', creatorId: 4, lines: [] }
            ],
            cashRegisters: [
                { id: 201, companyId: 102, name: 'Caisse Principale Beta', type: 'Caisse', responsibleId: 4, balance: 150000 }
            ],
            accounts: [
                // Plan comptable SYSCOHADA (partiel)
                { code: '571000', name: 'Caisse', category: 'Actif', nature: 'Debit' },
                { code: '601000', name: 'Achats de marchandises', category: 'Charge', nature: 'Debit' },
                { code: '707000', name: 'Ventes de marchandises', category: 'Produit', nature: 'Credit' }
            ],
            reports: []
        };
        
        // Structure de l'application globale (Global App State)
        window.app = {
            currentUser: null,
            currentProfile: null, // ADMIN, COLLABORATEUR, USER, CAISSIER
            currentCompanyId: null,
            currentCompanyName: null,
            filteredData: {
                entries: [], accounts: [], cashRegisters: [], users: [], reports: []
            }
        };

        // =========================================================================
        // 1. MANAGERS D'INTERFACE ET DE DONN√âES
        // =========================================================================

        /** Gestionnaire des notifications (Bas√© sur le contenu de vos fichiers) */
        const NotificationManager = {
            show: (type, title, message) => { 
                console.log(`[NOTIF ${type.toUpperCase()}] ${title}: ${message}`); 
                // Impl√©mentation compl√®te de l'affichage (comme dans les fichiers 1.txt/3.txt) omise ici pour concision, mais fonctionnelle.
                const zone = document.getElementById('notification-zone');
                if (zone) {
                    const id = Date.now();
                    const icon = type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-times-circle' : 'fa-info-circle';
                    const color = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-info';
                    const html = `
                        <div id="notif-${id}" class="notification p-4 ${color} text-white rounded-lg shadow-xl mb-3 flex items-center">
                            <i class="fas ${icon} mr-3"></i>
                            <div>
                                <h4 class="font-bold">${title}</h4>
                                <p class="text-sm">${message}</p>
                            </div>
                            <button onclick="NotificationManager.hide(${id})" class="ml-auto opacity-75 hover:opacity-100"><i class="fas fa-times"></i></button>
                        </div>`;
                    zone.innerHTML += html;
                    setTimeout(() => document.getElementById(`notif-${id}`)?.classList.add('show'), 10);
                    setTimeout(() => NotificationManager.hide(id), 5000);
                }
            },
            hide: (id) => {
                const el = document.getElementById(`notif-${id}`);
                if (el) {
                    el.classList.remove('show');
                    setTimeout(() => el.remove(), 300);
                }
            }
        };

        /** Gestionnaire de Donn√©es Unifi√© (Simule le filtrage) */
        class UnifiedDataManager {
            constructor() {
                this.data = mockData;
                this.notificationManager = NotificationManager;
            }

            // R√©cup√®re les donn√©es filtr√©es pour l'entreprise actuelle
            updateFilteredDataCache(companyId) {
                const currentId = companyId || window.app.currentCompanyId;
                if (!currentId) {
                    window.app.filteredData = { entries: [], accounts: [], cashRegisters: [], users: [], reports: [] };
                    return;
                }
                
                // Impl√©mentation du filtre (confirm√© par 1.txt)
                window.app.filteredData = {
                    entries: this.data.entries.filter(e => e.companyId === currentId),
                    accounts: this.data.accounts, // Simplifi√© : plan comptable est global dans ce mock
                    cashRegisters: this.data.cashRegisters.filter(c => c.companyId === currentId),
                    users: this.data.users.filter(u => u.assignedCompanies.includes(currentId) || u.role === 'ADMIN'),
                    reports: []
                };
                console.log(`üîÑ Cache mis √† jour pour entreprise ${currentId}`);
            }

            // S√©lectionne l'entreprise (appel√©e par le s√©lecteur dans le header)
            selectCompany(companyId) {
                if (!companyId) return;
                const company = this.data.companies[companyId];
                window.app.currentCompanyId = parseInt(companyId);
                window.app.currentCompanyName = company.nom;
                
                this.updateFilteredDataCache(window.app.currentCompanyId);
                this.notificationManager.show('success', 'S√©lection entreprise', `Vous travaillez d√©sormais sur ${company.nom}.`);
                
                this.loadSecureDashboard(); // Recharger le dashboard pour appliquer le contexte
                this.updateSecureUserInfo(); // Mettre √† jour le header
            }

            // Fonctions de s√©curit√© pour la gestion des utilisateurs (ADMIN)
            canManageUser(user) {
                // Un ADMIN peut g√©rer tout le monde sauf un ADMIN de niveau sup√©rieur (simplifi√© ici)
                return window.app.currentProfile === 'ADMIN' && user.role !== 'ADMIN';
            }

            // Logique de connexion (bas√©e sur Index √† conserver.txt)
            login(email, password) {
                const user = this.data.users.find(u => u.email === email && u.password === password);
                if (!user) {
                    return { success: false, message: 'Email ou mot de passe incorrect.' };
                }
                if (user.status !== 'Actif') {
                    return { success: false, message: 'Compte utilisateur d√©sactiv√©.' };
                }
                
                window.app.currentUser = user;
                window.app.currentProfile = user.role;
                
                // Si l'utilisateur a des entreprises assign√©es, pr√©-s√©lectionner la premi√®re
                if (user.assignedCompanies.length > 0) {
                    this.selectCompany(user.assignedCompanies[0]);
                }
                
                return { success: true, user: user };
            }
            
            // =========================================================================
            // 2. RENDU DYNAMIQUE DES VUES (Dashboards)
            // =========================================================================

            /** Charge la navigation et le dashboard s√©curis√©s */
            loadSecureDashboard() {
                const profile = window.app.currentProfile;
                if (!profile) return;
                
                this.renderRoleNavigation(profile);
                
                // Charger le dashboard par d√©faut du r√¥le
                switch(profile) {
                    case 'ADMIN':
                        this.renderGeneralDashboard('admin');
                        break;
                    case 'COLLABORATEUR':
                        this.renderCollaboratorDashboard();
                        break;
                    case 'USER':
                        this.renderUserDashboard();
                        break;
                    case 'CAISSIER':
                        this.renderCashierDashboard();
                        break;
                    default:
                        this.renderGeneralDashboard('user');
                }
            }

            /** Affiche la navigation lat√©rale dynamique pour le profil */
            renderRoleNavigation(profile) {
                const navContainer = document.getElementById('roleNavigation');
                let links = [];

                const navItem = (text, icon, onclick, isSpecial = false) => `
                    <a href="#" onclick="${onclick}" class="flex items-center p-3 rounded-lg transition-colors ${isSpecial ? 'bg-primary text-white hover:bg-primary-dark' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}">
                        <i class="fas ${icon} w-5"></i>
                        <span class="ml-3 font-medium">${text}</span>
                    </a>
                `;

                // Liens de base pour tous les r√¥les
                links.push(navItem('Tableau de Bord', 'fa-chart-line', 'window.unifiedManager.loadSecureDashboard()', true));
                links.push(navItem('Saisie Comptable', 'fa-pencil-alt', 'window.unifiedManager.loadEntryForm()'));
                links.push(navItem('Plan Comptable', 'fa-book', 'window.unifiedManager.loadAccountsPage()'));
                
                // Liens sp√©cifiques
                if (['ADMIN', 'COLLABORATEUR'].includes(profile)) {
                    links.push(navItem('Gestion des √âcritures', 'fa-clipboard-list', 'window.unifiedManager.loadEntriesPage()'));
                    links.push(navItem('√âtats Financiers (SYSCOHADA)', 'fa-balance-scale', 'window.unifiedManager.loadFinancialStatementsPage()'));
                }

                if (profile === 'COLLABORATEUR') {
                    links.push(navItem('Mon Portefeuille Client', 'fa-users', 'window.unifiedManager.loadClientPortfolioModule()'));
                }
                
                if (['ADMIN', 'CAISSIER'].includes(profile)) {
                    links.push(navItem('Gestion des Caisses', 'fa-cash-register', 'window.unifiedManager.loadCashRegisterModule()'));
                }

                if (profile === 'ADMIN') {
                    links.push(navItem('Gestion des Utilisateurs', 'fa-user-cog', 'window.unifiedManager.loadUserManagementModule()'));
                    links.push(navItem('Param√®tres Soci√©t√©', 'fa-cog', 'window.unifiedManager.loadCompanySettingsModule()'));
                    links.push(navItem('Audit & S√©curit√©', 'fa-shield-alt', 'window.unifiedManager.loadSecurityAudit()'));
                }

                navContainer.innerHTML = links.join('');
            }
            
            /** Module : Tableau de Bord G√©n√©ral (Mock) */
            renderGeneralDashboard(role) {
                const companyName = window.app.currentCompanyName || 'Veuillez s√©lectionner une entreprise';
                const content = `
                    <div class="space-y-8 fade-in">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Tableau de Bord Principal (${role.toUpperCase()})</h1>
                        <p class="text-gray-600 dark:text-gray-400">Entreprise Actuelle: <strong class="text-primary">${companyName}</strong></p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${this.generateKPIBox('fa-dollar-sign', 'Solde de Tr√©sorerie', 'N/A', 'info')}
                            ${this.generateKPIBox('fa-file-alt', '√âcritures en Attente', window.app.filteredData.entries.filter(e => e.status === 'En attente').length, 'warning')}
                            ${this.generateKPIBox('fa-users', 'Utilisateurs Actifs', window.app.filteredData.users.length, 'success')}
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Statistiques R√©centes</h3>
                            <canvas id="dashboardChart"></canvas>
                        </div>
                    </div>
                `;
                this.updateMainContent(content);
                this.renderChart();
            }

            /** Module : Tableau de Bord Collaborateur (Sp√©cifique) */
            renderCollaboratorDashboard() {
                const pendingEntries = window.app.filteredData.entries.filter(e => e.status === 'En attente' && e.creatorId !== window.app.currentUser.id).length;
                const companyName = window.app.currentCompanyName || 'Aucune s√©lection';
                const content = `
                    <div class="space-y-8 fade-in">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Espace Collaborateur</h1>
                        <p class="text-gray-600 dark:text-gray-400">Vous g√©rez le portefeuille de <strong class="text-primary">${companyName}</strong>.</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${this.generateKPIBox('fa-building', 'Clients Attribu√©s', '4', 'primary')}
                            ${this.generateKPIBox('fa-check-double', 'Validations en attente', pendingEntries, pendingEntries > 0 ? 'danger' : 'success')}
                            ${this.generateKPIBox('fa-calendar-alt', 'D√©lai Moyen Saisie', '2 jours', 'info')}
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Journal des Activit√©s (Portefeuille)</h3>
                            <p class="text-gray-500 dark:text-gray-400">Liste des derniers documents et validations en attente pour votre portefeuille.</p>
                        </div>
                    </div>
                `;
                this.updateMainContent(content);
            }
            
            /** Module : Tableau de Bord Caissier (Sp√©cifique) */
            renderCashierDashboard() {
                const myCash = window.app.filteredData.cashRegisters.find(c => c.responsibleId === window.app.currentUser.id);
                const balance = myCash ? myCash.balance.toLocaleString('fr-FR', { style: 'currency', currency: 'XOF' }) : 'N/A';
                const content = `
                    <div class="space-y-8 fade-in">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Espace Caisse</h1>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${this.generateKPIBox('fa-wallet', 'Solde de Ma Caisse', balance, myCash ? 'success' : 'danger')}
                            ${this.generateKPIBox('fa-exchange-alt', 'Op√©rations du Jour', '12', 'primary')}
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Derni√®res Op√©rations de Caisse</h3>
                            <p class="text-gray-500 dark:text-gray-400">Acc√®s rapide aux mouvements de la caisse principale: ${myCash?.name || 'Aucune caisse assign√©e'}.</p>
                            <button onclick="window.unifiedManager.loadCashRegisterModule()" class="mt-4 py-2 px-4 bg-info text-white rounded-lg hover:bg-info/80 transition-colors">
                                G√©rer la Caisse
                            </button>
                        </div>
                    </div>
                `;
                this.updateMainContent(content);
            }

            /** Module : Gestion des Utilisateurs (ADMIN) */
            loadUserManagementModule() {
                if (window.app.currentProfile !== 'ADMIN') {
                    this.notificationManager.show('danger', 'Acc√®s Refus√©', 'Fonctionnalit√© r√©serv√©e aux administrateurs.');
                    return;
                }
                const usersHtml = window.app.filteredData.users.map(user => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${user.role === 'ADMIN' ? 'text-danger' : 'text-primary'}">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Actif' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
                                ${user.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="window.unifiedManager.editUser(${user.id})" class="text-primary hover:text-primary-dark mr-3">Modifier</button>
                            <button onclick="window.unifiedManager.deleteUser(${user.id})" class="text-danger hover:text-red-700">Supprimer</button>
                        </td>
                    </tr>
                `).join('');

                const content = `
                    <div class="space-y-6 fade-in">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Gestion des Utilisateurs</h1>
                        <div class="flex justify-between items-center">
                            <p class="text-gray-600 dark:text-gray-400">Liste des utilisateurs ayant acc√®s √† l'entreprise actuelle ou globalement.</p>
                            <button onclick="window.unifiedManager.openNewUserModal()" class="py-2 px-4 bg-success text-white rounded-lg hover:bg-success/80 transition-colors">
                                <i class="fas fa-user-plus mr-2"></i> Ajouter Utilisateur
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Nom</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">R√¥le</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Statut</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    ${usersHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                this.updateMainContent(content);
            }

            /** Module : √âtats Financiers (SYSCOHADA) */
            loadFinancialStatementsPage() {
                if (!window.app.currentCompanyId) {
                    this.notificationManager.show('warning', 'S√©lection Requise', 'Veuillez s√©lectionner une entreprise pour g√©n√©rer les √©tats financiers.');
                    this.updateMainContent(this.generateCompanySelectionRequired());
                    return;
                }
                
                const company = this.data.companies[window.app.currentCompanyId];
                const isMinimal = company.systemeComptable === 'minimal';
                
                const content = `
                    <div class="space-y-6 fade-in">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">√âtats Financiers (SYSCOHADA)</h1>
                        <p class="text-lg text-gray-700 dark:text-gray-300">Entreprise: <strong class="text-primary">${company.nom}</strong></p>
                        
                        <div class="mb-4">
                            <label for="systeme" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Syst√®me Comptable Actif :</label>
                            <select id="systeme" onchange="window.unifiedManager.generateFinancialStatements()" class="mt-1 block w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white max-w-sm">
                                <option value="normal" ${!isMinimal ? 'selected' : ''}>Syst√®me Normal</option>
                                <option value="minimal" ${isMinimal ? 'selected' : ''}>Syst√®me Minimal de Tr√©sorerie</option>
                            </select>
                        </div>
                        
                        <div id="etat-financier" class="mt-6 space-y-6">
                            <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg text-center text-gray-500">
                                <i class="fas fa-calculator text-4xl mb-3"></i>
                                <p>Cliquez sur "G√©n√©rer" ou changez le syst√®me pour afficher les √©tats.</p>
                            </div>
                        </div>
                        
                        <button onclick="window.unifiedManager.generateFinancialStatements()" class="py-2 px-6 bg-primary text-white font-semibold rounded-lg hover:bg-primary-dark transition-colors">
                            <i class="fas fa-redo mr-2"></i> G√©n√©rer les √âtats
                        </button>
                    </div>
                `;
                this.updateMainContent(content);
            }
            
            // Logique de g√©n√©ration des √©tats (Simulation bas√©e sur 2.txt)
            generateFinancialStatements() {
                const systeme = document.getElementById('systeme')?.value || 'normal';
                const zone = document.getElementById('etat-financier');
                
                if (!zone) return;

                zone.innerHTML = `
                    <div class="flex items-center justify-center p-8 bg-warning/10 rounded-xl">
                        <div class="loading-spinner mr-4"></div>
                        <p class="text-warning font-semibold">G√©n√©ration des √©tats financiers en cours pour le syst√®me ${systeme.toUpperCase()}...</p>
                    </div>
                `;
                
                setTimeout(() => {
                    let html = ``;
                    const entries = window.app.filteredData.entries;

                    if (systeme === 'normal') {
                        html += this.renderReportBlock('Bilan Standard', `Bilan Actif/Passif (Actif: ${entries.length * 1000}, Passif: ${entries.length * 1000}) - √âquilibr√©.`);
                        html += this.renderReportBlock('Compte de R√©sultat', `R√©sultat Net: ${entries.length * 100} (B√©n√©fice)`);
                        html += this.renderReportBlock('Tableau de Financement', `Capacit√© d'Autofinancement: Calcul√©e.`);
                    } else { // Minimal (Tr√©sorerie)
                        html += this.renderReportBlock('√âtat des Recettes et D√©penses', `Recettes: ${entries.length * 500}, D√©penses: ${entries.length * 300}`);
                        html += this.renderReportBlock('Bilan Minimal', `Bilan de Tr√©sorerie (Solde: ${entries.length * 200}) - Conforme.`);
                    }
                    html += this.renderReportBlock('Notes Annexes', `Synth√®se des m√©thodes comptables et engagements. (Bas√© sur le fichier 2.txt)`);

                    zone.innerHTML = html;
                    this.notificationManager.show('success', 'Rapport SYSCOHADA', 'Les √©tats financiers ont √©t√© g√©n√©r√©s avec succ√®s.');
                }, 1500);
            }

            // Fonctions d'aide (Helpers)
            updateMainContent(content) {
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            updateSecureUserInfo() {
                const user = window.app.currentUser;
                const company = window.app.currentCompanyName || '-- Aucune s√©lectionn√©e --';
                
                document.getElementById('welcome-message').textContent = `Bienvenue, ${user.name.split(' ')[0]} !`;
                document.getElementById('current-role').textContent = user.role;
                
                const companySelector = document.getElementById('company-selector-container');
                const selectEntreprise = document.getElementById('entreprise');
                
                // Mettre √† jour le s√©lecteur d'entreprise pour Admin/Collaborateur/User
                const relevantCompanyIds = user.role === 'ADMIN' ? Object.keys(this.data.companies) : user.assignedCompanies;
                
                if (relevantCompanyIds.length > 0) {
                    companySelector.classList.remove('hidden');
                    selectEntreprise.innerHTML = relevantCompanyIds.map(id => {
                        const comp = this.data.companies[id];
                        return `<option value="${id}" ${window.app.currentCompanyId === comp.id ? 'selected' : ''}>${comp.nom}</option>`;
                    }).join('');
                    
                    // Si l'entreprise est s√©lectionn√©e, mettre √† jour le nom
                    if (window.app.currentCompanyId) {
                        document.getElementById('welcome-message').nextElementSibling.innerHTML = `Contexte de travail actuel: <strong id="current-company-name">${window.app.currentCompanyName}</strong>`;
                    } else {
                        document.getElementById('welcome-message').nextElementSibling.innerHTML = `Contexte de travail actuel: <strong id="current-company-name">-- S√©lection requise --</strong>`;
                    }
                } else {
                    companySelector.classList.add('hidden');
                }
            }
            
            // Stubs pour les autres modules (pour la navigation compl√®te)
            loadEntryForm() { this.updateMainContent(this.generateStubContent('Saisie d\'√âcriture', 'Module de saisie journali√®re avec contr√¥le d\'√©quilibre.')); }
            loadAccountsPage() { this.updateMainContent(this.generateStubContent('Plan Comptable', 'Consultation et gestion du plan comptable SYSCOHADA.')); }
            loadEntriesPage() { this.updateMainContent(this.generateStubContent('Gestion des √âcritures', 'Tableau de bord pour validation/modification des √©critures.')); }
            loadClientPortfolioModule() { this.updateMainContent(this.generateStubContent('Mon Portefeuille Client', 'Outils de suivi des clients et de leurs dossiers.')); }
            loadCashRegisterModule() { this.updateMainContent(this.generateStubContent('Gestion des Caisses', 'Gestion des mouvements de caisse et √©dition des rapports de caisse.')); }
            loadCompanySettingsModule() { this.updateMainContent(this.generateStubContent('Param√®tres Soci√©t√©', 'Configuration du syst√®me comptable et des informations l√©gales.')); }
            loadSecurityAudit() { this.notificationManager.show('info', 'Audit', 'Lancement de l\'audit de s√©curit√© du syst√®me...'); }
            
            generateKPIBox(icon, title, value, color) {
                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-${color} fade-in">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-${color}/20 text-${color} mr-4">
                                <i class="fas ${icon} text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${title}</p>
                                <p class="text-2xl font-bold text-gray-900 dark:text-white">${value}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            generateStubContent(title, description) {
                return `
                    <div class="p-8 bg-white dark:bg-gray-800 rounded-xl shadow-2xl space-y-4 fade-in">
                        <h1 class="text-3xl font-bold text-primary">${title}</h1>
                        <p class="text-gray-700 dark:text-gray-300">${description}</p>
                        <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border-l-4 border-warning">
                            <p class="text-warning font-semibold">‚ö†Ô∏è Fonctionnalit√© en cours de d√©veloppement. Le squelette de l'interface est affich√©.</p>
                        </div>
                    </div>
                `;
            }

            renderReportBlock(title, content) {
                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-secondary fade-in">
                        <h3 class="text-xl font-bold text-secondary mb-3">${title}</h3>
                        <p class="text-gray-700 dark:text-gray-300">${content}</p>
                    </div>
                `;
            }
            
            generateCompanySelectionRequired() {
                return `
                    <div class="text-center py-16 bg-white dark:bg-gray-800 rounded-xl shadow-lg fade-in">
                        <i class="fas fa-building text-6xl mb-4 text-warning"></i>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">S√©lection d'Entreprise Requise</h3>
                        <p class="text-gray-600 dark:text-gray-400 max-w-md mx-auto">Veuillez s√©lectionner une entreprise dans le s√©lecteur en haut √† droite pour acc√©der √† cette fonctionnalit√© et aux donn√©es filtr√©es.</p>
                    </div>
                `;
            }
            
            renderChart() {
                const ctx = document.getElementById('dashboardChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin'],
                            datasets: [{
                                label: 'Mouvements (Debit vs Credit)',
                                data: [12000, 19000, 3000, 5000, 2000, 3000],
                                backgroundColor: ['#5D5CDE', '#5D5CDE', '#5D5CDE', '#5D5CDE', '#5D5CDE', '#5D5CDE'],
                                borderColor: ['#1E40AF', '#1E40AF', '#1E40AF', '#1E40AF', '#1E40AF', '#1E40AF'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            }
        }
        
        // =========================================================================
        // 3. INITIALISATION ET √âV√âNEMENTS
        // =========================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            let unifiedManager = new UnifiedDataManager();
            window.unifiedManager = unifiedManager;

            // Masquer la sidebar sur mobile
            document.getElementById('menu-toggle')?.addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                } else {
                    sidebar.classList.add('-translate-x-full');
                }
            });

            // Gestion du formulaire de connexion
            const loginForm = document.getElementById('loginForm');
            loginForm?.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginMessage = document.getElementById('loginMessage');
                
                loginMessage.textContent = 'Connexion en cours...';

                setTimeout(() => { // Simulation d'une requ√™te asynchrone
                    const result = unifiedManager.login(email, password);
                    if (result.success) {
                        document.getElementById('loginView').classList.add('hidden');
                        document.getElementById('dashboardView').classList.remove('hidden');
                        unifiedManager.loadSecureDashboard(); // Charger le dashboard s√©curis√©
                        unifiedManager.updateSecureUserInfo();
                        unifiedManager.notificationManager.show('success', 'Connexion R√©ussie', `Bienvenue, ${result.user.name}!`);
                    } else {
                        loginMessage.textContent = result.message;
                        unifiedManager.notificationManager.show('danger', 'Erreur de Connexion', result.message);
                    }
                }, 500);
            });

            // Bouton de d√©connexion
            document.getElementById('logout-button')?.addEventListener('click', () => {
                window.app.currentUser = null;
                window.app.currentProfile = null;
                window.app.currentCompanyId = null;
                document.getElementById('dashboardView').classList.add('hidden');
                document.getElementById('loginView').classList.remove('hidden');
                unifiedManager.notificationManager.show('info', 'D√©connexion', 'Vous avez √©t√© d√©connect√© avec succ√®s.');
            });
            
            console.log('üéâ DOUK√à Compta Pro - SYST√àME UNIFI√â CHARG√â AVEC SUCC√àS');
            console.log('üîí Profils support√©s: ADMIN, COLLABORATEUR, USER, CAISSIER');
        });
    </script>
</body>
</html>
