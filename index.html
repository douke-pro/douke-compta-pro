<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOUK√à Compta Pro - Syst√®me Comptable SYSCOHADA Int√©gr√©</title>
    
    <!-- ========================================= -->
    <!-- RESSOURCES EXTERNES                      -->
    <!-- ========================================= -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

    <!-- ========================================= -->
    <!-- CONFIGURATION TAILWIND                   -->
    <!-- ========================================= -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-light': '#8B8BF0',
                        'primary-dark': '#1E40AF',
                        secondary: '#1D4ED8',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        info: '#3B82F6'
                    }
                }
            }
        }
    </script>

    <!-- ========================================= -->
    <!-- STYLES PERSONNALIS√âS                     -->
    <!-- ========================================= -->
    <style>
        /* Animations */
        .fade-in { 
            animation: fadeIn 0.3s ease-in-out; 
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* Loading Spinner */
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #5D5CDE;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Modales */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-backdrop.show { 
            opacity: 1; 
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 1000;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        .modal.show { 
            transform: translate(-50%, -50%) scale(1); 
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .modal {
                max-width: 95vw;
                max-height: 95vh;
            }
        }
    </style>

    <!-- ========================================= -->
    <!-- INITIALISATION SYST√àME                   -->
    <!-- ========================================= -->
    <script>
        // =============================================================================
        // üîß GESTIONNAIRE S√âCURIS√â DES ONCLICK
        // =============================================================================
        console.log('üöÄ Initialisation DOUK√à Compta Pro v3.1...');

        // Wrapper de s√©curit√© pour toutes les fonctions
        window.safeExecute = function(functionName, ...args) {
            console.log(`üîç Ex√©cution s√©curis√©e: ${functionName}`, args);
            try {
                if (typeof window[functionName] === 'function') {
                    return window[functionName](...args);
                } else if (window.unifiedManager && typeof window.unifiedManager[functionName] === 'function') {
                    return window.unifiedManager[functionName](...args);
                } else if (typeof window[functionName] !== 'undefined') {
                    return window[functionName];
                } else {
                    console.error(`‚ùå Fonction ${functionName} introuvable`);
                    if (window.unifiedManager && window.unifiedManager.notificationManager) {
                        window.unifiedManager.notificationManager.show('error', 'Erreur Fonction', `Fonction ${functionName} non disponible`);
                    } else {
                        alert(`Fonction ${functionName} non disponible. Veuillez recharger la page.`);
                    }
                }
            } catch (error) {
                console.error(`‚ùå Erreur dans ${functionName}:`, error);
                if (window.unifiedManager && window.unifiedManager.notificationManager) {
                    window.unifiedManager.notificationManager.show('error', 'Erreur Syst√®me', error.message);
                } else {
                    alert(`Erreur: ${error.message}`);
                }
            }
        };

        // Exposition imm√©diate des fonctions critiques
        window.showNewUserModal = () => safeExecute('showNewUserModal');
        window.showNewCompanyModal = () => safeExecute('showNewCompanyModal');  
        window.showNewEntryModal = () => safeExecute('showNewEntryModal');
        window.fillCredentials = (profile) => safeExecute('fillCredentials', profile);
        window.handleSecureLogin = () => safeExecute('handleSecureLogin');
        window.confirmSecureLogout = () => safeExecute('confirmSecureLogout');
        window.togglePassword = () => safeExecute('togglePassword');
        window.toggleThemeMenu = () => safeExecute('toggleThemeMenu');
        window.setTheme = (theme) => safeExecute('setTheme', theme);
        window.filterAccounts = () => safeExecute('filterAccounts');
        window.resetAccountFilters = () => safeExecute('resetAccountFilters');
        window.viewAccountHistory = (code) => safeExecute('viewAccountHistory', code);
        window.editUser = (id) => safeExecute('editUser', id);
        window.manageUserAccess = (id) => safeExecute('manageUserAccess', id);
        window.viewEntry = (id) => safeExecute('viewEntry', id);
        window.editEntry = (id) => safeExecute('editEntry', id);
        window.validateEntry = (id) => safeExecute('validateEntry', id);
        window.viewUserDetails = (id) => safeExecute('viewUserDetails', id);
        window.openCashOperations = (id) => safeExecute('openCashOperations', id);
        window.editCashRegister = (id) => safeExecute('editCashRegister', id);
        window.generateCashReport = (id) => safeExecute('generateCashReport', id);

        console.log('‚úÖ Fonctions onclick s√©curis√©es expos√©es');
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <!-- ========================================= -->
    <!-- GESTIONNAIRE DE TH√àME                    -->
    <!-- ========================================= -->
    <script>
        const themeManager = {
            current: 'system',
            
            init() {
                if (localStorage.getItem('theme') === 'dark' ||
                    (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    this.current = 'dark';
                } else if (localStorage.getItem('theme') === 'light') {
                    document.documentElement.classList.remove('dark');
                    this.current = 'light';
                } else {
                    this.current = 'system';
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (this.current === 'system') {
                        if (event.matches) {
                            document.documentElement.classList.add('dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                        }
                    }
                });
            },
            
            setTheme(theme) {
                this.current = theme;
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else if (theme === 'light') {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    localStorage.removeItem('theme');
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            }
        };
        
        themeManager.init();
    </script>

    <!-- ========================================= -->
    <!-- CONTENEURS SYST√àME                       -->
    <!-- ========================================= -->
    <div id="notificationsContainer"></div>
    <div id="modalContainer"></div>

    <!-- ========================================= -->
    <!-- INTERFACE DE CONNEXION                   -->
    <!-- ========================================= -->
    <div id="loginInterface" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary to-primary-light">
        <div class="max-w-md w-full mx-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8">
                <!-- Logo et titre -->
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-primary text-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-calculator text-3xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">DOUK√à Compta Pro</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Syst√®me Comptable SYSCOHADA Int√©gr√©</p>
                    <div class="flex items-center justify-center mt-2 text-xs">
                        <span class="px-2 py-1 bg-success/20 text-success rounded-full mr-2">v3.1</span>
                        <span class="text-gray-500">Hi√©rarchie Admin‚ÜíSenior‚ÜíCollaborateur‚ÜíUser‚ÜíCaissier</span>
                    </div>
                </div>

                <!-- Formulaire de connexion -->
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-envelope mr-2"></i>Email
                        </label>
                        <input type="email" id="loginEmail" required
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-colors">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-lock mr-2"></i>Mot de passe
                        </label>
                        <div class="relative">
                            <input type="password" id="loginPassword" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent pr-10">
                            <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i id="passwordToggleIcon" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" id="loginButton" class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-lg font-medium transition-colors transform hover:scale-105">
                        <i class="fas fa-sign-in-alt mr-2"></i>Connexion S√©curis√©e
                    </button>
                </form>

                <!-- Comptes de d√©monstration -->
                <div class="mt-8 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Comptes hi√©rarchiques de d√©monstration :</h3>
                    <div class="space-y-2 text-xs">
                        <button onclick="fillCredentials('admin')" class="w-full text-left p-2 hover:bg-white dark:hover:bg-gray-600 rounded transition-colors border-l-4 border-danger">
                            <strong class="text-danger">üëë Admin :</strong> admin@doukecompta.ci / admin123
                            <div class="text-gray-500">Acc√®s total ‚Ä¢ Gestion utilisateurs ‚Ä¢ Toutes entreprises</div>
                        </button>
                        <button onclick="fillCredentials('collaborateur_senior')" class="w-full text-left p-2 hover:bg-white dark:hover:bg-gray-600 rounded transition-colors border-l-4 border-primary">
                            <strong class="text-primary">‚≠ê Collaborateur Senior :</strong> marie.kouassi@cabinet.com / marie123
                            <div class="text-gray-500">Multi-entreprises ‚Ä¢ Gestion √©quipe ‚Ä¢ Validation</div>
                        </button>
                        <button onclick="fillCredentials('collaborateur')" class="w-full text-left p-2 hover:bg-white dark:hover:bg-gray-600 rounded transition-colors border-l-4 border-info">
                            <strong class="text-info">üë• Collaborateur :</strong> jean.diabate@cabinet.com / jean123
                            <div class="text-gray-500">Entreprises assign√©es ‚Ä¢ Validation ‚Ä¢ Rapports</div>
                        </button>
                        <button onclick="fillCredentials('user')" class="w-full text-left p-2 hover:bg-white dark:hover:bg-gray-600 rounded transition-colors border-l-4 border-success">
                            <strong class="text-success">üè¢ Utilisateur :</strong> atraore@sarltech.ci / user123
                            <div class="text-gray-500">Une entreprise ‚Ä¢ Gestion compl√®te ‚Ä¢ Caisses</div>
                        </button>
                        <button onclick="fillCredentials('caissier')" class="w-full text-left p-2 hover:bg-white dark:hover:bg-gray-600 rounded transition-colors border-l-4 border-warning">
                            <strong class="text-warning">üí∞ Caissier :</strong> ikone@caisse.ci / caisse123
                            <div class="text-gray-500">Caisse uniquement ‚Ä¢ Op√©rations ‚Ä¢ Validation requise</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- INTERFACE PRINCIPALE                     -->
    <!-- ========================================= -->
    <div id="mainApp" class="hidden h-screen overflow-hidden">
        <div class="flex h-screen overflow-hidden">
            
            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg transform transition-transform duration-300 ease-in-out lg:translate-x-0 -translate-x-full fixed lg:static z-30 h-full">
                <div class="flex flex-col h-full">
                    
                    <!-- Header -->
                    <div class="flex items-center justify-center h-16 border-b border-gray-200 dark:border-gray-700 bg-primary">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-white text-primary rounded-lg flex items-center justify-center font-bold">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <span class="text-white font-bold text-lg">DOUK√à Compta Pro</span>
                        </div>
                    </div>

                    <!-- Profil utilisateur -->
                    <div class="p-4 bg-primary/10">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center">
                                <span id="userInitials">U</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-900 dark:text-white" id="sidebarUserName">Utilisateur</div>
                                <div class="text-sm text-primary font-medium" id="sidebarUserRole">Role</div>
                                <div class="text-xs text-gray-500" id="sidebarUserHierarchy">Niveau</div>
                            </div>
                        </div>
                    </div>

                    <!-- S√©lecteur d'entreprise -->
                    <div id="companySelector" class="p-4 border-b border-gray-200 dark:border-gray-700">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-building mr-2"></i>Entreprise Active
                        </label>
                        <select id="activeCompanySelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                            <option value="">-- S√©lectionner une entreprise --</option>
                        </select>
                        <div class="mt-2">
                            <span id="selectedCompanyInfo" class="text-xs text-primary-light font-medium"></span>
                        </div>
                        <div id="accessIndicator" class="mt-1 text-xs text-gray-500"></div>
                    </div>

                    <!-- Navigation -->
                    <nav id="navigationMenu" class="flex-1 overflow-y-auto py-4">
                        <!-- Menu items will be populated by JavaScript -->
                    </nav>

                    <!-- Indicateur de synchronisation -->
                    <div id="syncStatus" class="p-3 border-t border-gray-200 dark:border-gray-700 bg-info/5">
                        <div class="flex items-center space-x-2 text-xs">
                            <i class="fas fa-sync-alt text-info"></i>
                            <span class="text-info">Sync PIWA</span>
                            <span id="syncIndicator" class="ml-auto px-2 py-1 bg-success/20 text-success rounded">‚óè</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                
                <!-- Header -->
                <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between px-6 py-4">
                        <div class="flex items-center space-x-4">
                            <button id="sidebarToggle" class="lg:hidden text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                                <i class="fas fa-bars text-xl"></i>
                            </button>
                            <div>
                                <h1 class="text-xl font-semibold text-gray-900 dark:text-white" id="currentUserName">Utilisateur</h1>
                                <p class="text-sm text-gray-600 dark:text-gray-400" id="currentCompanyName">Entreprise</p>
                            </div>
                        </div>

                        <div class="flex items-center space-x-4">
                            <!-- Indicateur de niveau de s√©curit√© -->
                            <div id="securityLevel" class="flex items-center space-x-2 px-3 py-1 rounded-lg bg-success/10 text-success">
                                <i class="fas fa-shield-alt text-sm"></i>
                                <span class="text-xs font-medium" id="securityLevelText">Niveau 2</span>
                            </div>

                            <!-- Theme Switcher -->
                            <div class="relative">
                                <button onclick="toggleThemeMenu()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" title="Changer de th√®me">
                                    <i class="fas fa-palette text-xl"></i>
                                </button>
                                <div id="themeMenu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                                    <div class="py-2">
                                        <button onclick="setTheme('light')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            <i class="fas fa-sun mr-2"></i>Th√®me clair
                                        </button>
                                        <button onclick="setTheme('dark')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            <i class="fas fa-moon mr-2"></i>Th√®me sombre
                                        </button>
                                        <button onclick="setTheme('system')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            <i class="fas fa-desktop mr-2"></i>Syst√®me
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Notifications -->
                            <div class="relative">
                                <button onclick="safeExecute('toggleNotificationsPanel')" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 relative" title="Notifications">
                                    <i class="fas fa-bell text-xl"></i>
                                    <span id="notificationBadge" class="absolute -top-1 -right-1 bg-danger text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">3</span>
                                </button>
                            </div>

                            <button onclick="confirmSecureLogout()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" title="D√©connexion s√©curis√©e">
                                <i class="fas fa-sign-out-alt text-xl"></i>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Main Content Area -->
                <main class="flex-1 overflow-y-auto p-6">
                    <div id="mainContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- SYST√àME JAVASCRIPT PRINCIPAL             -->
    <!-- ========================================= -->
    <script>
        // =============================================================================
        // DOUK√à Compta Pro - Syst√®me Comptable SYSCOHADA Int√©gr√© v3.1
        // Architecture: Variables Globales ‚Üí Classes ‚Üí Fonctions ‚Üí Initialisation
        // =============================================================================

        // ========================================= 
        // VARIABLES GLOBALES DE L'APPLICATION
        // =========================================
        window.app = {
            accounts: [],
            companies: [],
            users: [],
            entries: [],
            cashRegisters: [],
            currentUser: null,
            currentProfile: null,
            currentCompanyId: null,
            filteredData: {
                entries: [],
                accounts: [],
                reports: [],
                cashRegisters: [],
                users: [],
                lastUpdate: null,
                companyId: null
            },
            isProduction: false,
            backendEnabled: false,
            lastSync: null,
            syncCount: 0
        };

        // =============================================================================
        // CLASSE: GESTIONNAIRE DE S√âCURIT√â HI√âRARCHIQUE
        // =============================================================================
        class SecurityManager {
            constructor() {
                this.profileHierarchy = {
                    'admin': 5,
                    'collaborateur_senior': 4,
                    'collaborateur': 3,
                    'user': 2,
                    'caissier': 1
                };

                this.permissions = {
                    'admin': {
                        canManageUsers: true,
                        canManageCompanies: true,
                        canAccessAllCompanies: true,
                        canAssignCompanies: true,
                        canValidateOperations: true,
                        canCreateReports: true,
                        requiresCompanySelection: true,
                        canViewAllPortfolios: true,
                        canManageCollaborators: true
                    },
                    'collaborateur_senior': {
                        canManageUsers: ['collaborateur', 'user', 'caissier'],
                        canManageCompanies: true,
                        canAccessAllCompanies: false,
                        canAssignCompanies: ['collaborateur'],
                        canValidateOperations: true,
                        canCreateReports: true,
                        requiresCompanySelection: true,
                        canManageSubordinates: true,
                        canViewAssignedPortfolios: true
                    },
                    'collaborateur': {
                        canManageUsers: ['user', 'caissier'],
                        canManageCompanies: false,
                        canAccessAllCompanies: false,
                        canAssignCompanies: false,
                        canValidateOperations: true,
                        canCreateReports: true,
                        requiresCompanySelection: true,
                        canManageOwnCompanies: true
                    },
                    'user': {
                        canManageUsers: false,
                        canManageCompanies: false,
                        canAccessAllCompanies: false,
                        canAssignCompanies: false,
                        canValidateOperations: true,
                        canCreateReports: true,
                        requiresCompanySelection: false,
                        maxCashRegisters: 5,
                        singleCompanyAccess: true
                    },
                    'caissier': {
                        canManageUsers: false,
                        canManageCompanies: false,
                        canAccessAllCompanies: false,
                        canAssignCompanies: false,
                        canValidateOperations: false,
                        canCreateReports: false,
                        requiresCompanySelection: false,
                        needsValidation: true,
                        singleCompanyAccess: true
                    }
                };

                console.log('üîí SecurityManager hi√©rarchique initialis√©');
            }

            hasAccessToCompany(userId, companyId) {
                const user = this.getCurrentUser(userId);
                if (!user || !companyId) return false;

                const profile = user.profile;

                // Admin acc√®de √† tout
                if (profile === 'admin') return true;

                // User : seulement SON entreprise
                if (profile === 'user') {
                    return user.companyId === companyId;
                }

                // Caissier : seulement l'entreprise de sa caisse
                if (profile === 'caissier') {
                    return user.companyId === companyId;
                }

                // Collaborateur senior et collaborateur : entreprises assign√©es
                if (profile === 'collaborateur_senior' || profile === 'collaborateur') {
                    return user.assignedCompanies && user.assignedCompanies.includes(companyId);
                }

                return false;
            }

            requiresCompanySelection(profile) {
                const permissions = this.permissions[profile];
                return permissions ? permissions.requiresCompanySelection : false;
            }

            getAccessibleCompanies(userId) {
                const user = this.getCurrentUser(userId);
                if (!user) return [];

                if (user.profile === 'admin') {
                    return window.app.companies || [];
                }

                if (user.profile === 'user' || user.profile === 'caissier') {
                    return window.app.companies.filter(c => c.id === user.companyId);
                }

                if (user.profile === 'collaborateur_senior' || user.profile === 'collaborateur') {
                    return window.app.companies.filter(c =>
                        user.assignedCompanies && user.assignedCompanies.includes(c.id)
                    );
                }

                return [];
            }

            getCurrentUser(userId) {
                if (!userId && window.app && window.app.currentUser) {
                    return window.app.currentUser;
                }
                if (!window.app || !window.app.users) return null;
                return window.app.users.find(u => u.id === userId);
            }

            getDashboardForProfile(profile) {
                const dashboards = {
                    'admin': 'admin-dashboard',
                    'collaborateur_senior': 'senior-dashboard',
                    'collaborateur': 'collaborator-dashboard',
                    'user': 'user-dashboard',
                    'caissier': 'cashier-dashboard'
                };
                return dashboards[profile] || 'user-dashboard';
            }
        }

        // =============================================================================
        // CLASSE: GESTIONNAIRE DE DONN√âES AVEC ISOLATION
        // =============================================================================
        class DataManager {
            constructor(securityManager) {
                this.security = securityManager;
                this.companyDataCache = new Map();
                console.log('üíæ DataManager avec isolation initialis√©');
            }

            getCompanyData(companyId, userId = null) {
                const currentUserId = userId || (window.app.currentUser ? window.app.currentUser.id : null);

                if (!this.security.hasAccessToCompany(currentUserId, companyId)) {
                    throw new Error(`üö´ Acc√®s refus√© √† l'entreprise ${companyId}`);
                }

                return {
                    accounts: this.getCompanyAccounts(companyId, userId),
                    entries: this.getCompanyEntries(companyId, userId),
                    cashRegisters: this.getCompanyCashRegisters(companyId, userId),
                    users: this.getCompanyUsers(companyId, userId)
                };
            }

            getCompanyEntries(companyId, userId = null) {
                const currentUserId = userId || (window.app.currentUser ? window.app.currentUser.id : null);
                if (!this.security.hasAccessToCompany(currentUserId, companyId)) {
                    throw new Error(`üö´ Acc√®s refus√© aux √©critures de l'entreprise ${companyId}`);
                }
                return window.app.entries.filter(entry => entry.companyId === companyId);
            }

            getCompanyAccounts(companyId, userId = null) {
                const currentUserId = userId || (window.app.currentUser ? window.app.currentUser.id : null);
                if (!this.security.hasAccessToCompany(currentUserId, companyId)) {
                    throw new Error(`üö´ Acc√®s refus√© au plan comptable de l'entreprise ${companyId}`);
                }
                return window.app.accounts; // Plan comptable global SYSCOHADA
            }

            getCompanyCashRegisters(companyId, userId = null) {
                const currentUserId = userId || (window.app.currentUser ? window.app.currentUser.id : null);
                if (!this.security.hasAccessToCompany(currentUserId, companyId)) {
                    throw new Error(`üö´ Acc√®s refus√© aux caisses de l'entreprise ${companyId}`);
                }
                return window.app.cashRegisters.filter(cash => cash.companyId === companyId);
            }

            getCompanyUsers(companyId, userId = null) {
                const currentUserId = userId || (window.app.currentUser ? window.app.currentUser.id : null);
                if (!this.security.hasAccessToCompany(currentUserId, companyId)) {
                    throw new Error(`üö´ Acc√®s refus√© aux utilisateurs de l'entreprise ${companyId}`);
                }
                return window.app.users.filter(user =>
                    user.companyId === companyId ||
                    (user.assignedCompanies && user.assignedCompanies.includes(companyId))
                );
            }
        }

        // =============================================================================
        // CLASSE: GESTIONNAIRE DE NOTIFICATIONS
        // =============================================================================
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationsContainer');
                this.notifications = new Map();
            }

            show(type, title, message, duration = 5000) {
                const id = Date.now().toString();
                
                const notification = document.createElement('div');
                notification.className = `notification bg-white dark:bg-gray-800 border-l-4 rounded-lg shadow-lg p-4 mb-4 ${this.getTypeClasses(type)}`;
                notification.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="${this.getTypeIcon(type)} text-lg"></i>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-white">${title}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${message}</p>
                        </div>
                        <button onclick="window.unifiedManager.notificationManager.hide('${id}')" class="ml-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                this.container.appendChild(notification);
                this.notifications.set(id, notification);

                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);

                if (duration > 0) {
                    setTimeout(() => {
                        this.hide(id);
                    }, duration);
                }

                return id;
            }

            hide(id) {
                const notification = this.notifications.get(id);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                        this.notifications.delete(id);
                    }, 300);
                }
            }

            getTypeClasses(type) {
                const classes = {
                    success: 'border-success text-success',
                    error: 'border-danger text-danger',
                    warning: 'border-warning text-warning',
                    info: 'border-info text-info'
                };
                return classes[type] || classes.info;
            }

            getTypeIcon(type) {
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };
                return icons[type] || icons.info;
            }
        }

        // =============================================================================
        // CLASSE: GESTIONNAIRE DE MODALES
        // =============================================================================
        class ModalManager {
            constructor() {
                this.container = document.getElementById('modalContainer');
                this.currentModal = null;
            }

            show(title, content, options = {}) {
                this.hide();

                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop';
                backdrop.onclick = () => {
                    if (options.closeOnBackdrop !== false) {
                        this.hide();
                    }
                };

                const modal = document.createElement('div');
                modal.className = 'modal bg-white dark:bg-gray-800 rounded-xl shadow-2xl';
                modal.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${title}</h3>
                            <button onclick="window.unifiedManager.modalManager.hide()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="modal-content">
                            ${content}
                        </div>
                        ${options.actions ? `
                        <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                            ${options.actions}
                        </div>
                        ` : ''}
                    </div>
                `;

                this.container.appendChild(backdrop);
                this.container.appendChild(modal);

                setTimeout(() => {
                    backdrop.classList.add('show');
                    modal.classList.add('show');
                }, 10);

                this.currentModal = { backdrop, modal };
                return modal;
            }

            hide() {
                if (this.currentModal) {
                    const { backdrop, modal } = this.currentModal;
                    
                    backdrop.classList.remove('show');
                    modal.classList.remove('show');

                    setTimeout(() => {
                        if (backdrop.parentNode) backdrop.parentNode.removeChild(backdrop);
                        if (modal.parentNode) modal.parentNode.removeChild(modal);
                    }, 300);

                    this.currentModal = null;
                }
            }

            confirm(title, message, onConfirm, onCancel = null) {
                const actions = `
                    <button onclick="window.unifiedManager.modalManager.hide(); ${onCancel ? onCancel.toString() + '()' : ''}" 
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                        Annuler
                    </button>
                    <button onclick="window.unifiedManager.modalManager.hide(); (${onConfirm.toString()})()" 
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                        Confirmer
                    </button>
                `;

                return this.show(title, `<p class="text-gray-600 dark:text-gray-400">${message}</p>`, {
                    actions,
                    closeOnBackdrop: false
                });
            }
        }

        // =============================================================================
        // CLASSE PRINCIPALE: GESTIONNAIRE UNIFI√â
        // =============================================================================
        class UnifiedDataManager {
            constructor() {
                this.security = new SecurityManager();
                this.data = new DataManager(this.security);
                this.notificationManager = new NotificationManager();
                this.modalManager = new ModalManager();
                this.currentCompanyId = null;
                this.initializeApplication();
                console.log('üöÄ UnifiedDataManager COMPLET initialis√©');
            }

            initializeApplication() {
                this.initializeData();
                // Exposer les gestionnaires globalement
                window.notificationManager = this.notificationManager;
                window.modalManager = this.modalManager;
            }

            initializeData() {
                // Plan comptable SYSCOHADA R√©vis√© complet
                if (window.app.accounts.length === 0) {
                    window.app.accounts = [
                        // Classe 1 - Comptes de ressources durables
                        { code: '101000', name: 'Capital social', category: 'Capitaux propres', type: 'Passif', nature: 'Credit' },
                        { code: '104000', name: 'Primes li√©es au capital social', category: 'Capitaux propres', type: 'Passif', nature: 'Credit' },
                        { code: '106000', name: 'R√©serves', category: 'Capitaux propres', type: 'Passif', nature: 'Credit' },
                        { code: '110000', name: 'Report √† nouveau', category: 'Capitaux propres', type: 'Passif', nature: 'Credit' },
                        { code: '120000', name: 'R√©sultat de l\'exercice', category: 'Capitaux propres', type: 'Passif', nature: 'Credit' },
                        { code: '131000', name: 'Subventions d\'√©quipement', category: 'Capitaux propres', type: 'Passif', nature: 'Credit' },
                        { code: '140000', name: 'Provisions r√©glement√©es', category: 'Capitaux propres', type: 'Passif', nature: 'Credit' },
                        { code: '151000', name: 'Provisions pour risques', category: 'Provisions', type: 'Passif', nature: 'Credit' },
                        { code: '161000', name: 'Emprunts et dettes', category: 'Dettes financi√®res', type: 'Passif', nature: 'Credit' },
                        { code: '171000', name: 'Dettes de cr√©dit-bail', category: 'Dettes financi√®res', type: 'Passif', nature: 'Credit' },
                        
                        // Classe 2 - Comptes d'actif immobilis√©
                        { code: '211000', name: 'Terrains', category: 'Immobilisations corporelles', type: 'Actif', nature: 'Debit' },
                        { code: '212000', name: 'Agencements et am√©nagements de terrains', category: 'Immobilisations corporelles', type: 'Actif', nature: 'Debit' },
                        { code: '213000', name: 'Constructions', category: 'Immobilisations corporelles', type: 'Actif', nature: 'Debit' },
                        { code: '215000', name: 'Installations techniques', category: 'Immobilisations corporelles', type: 'Actif', nature: 'Debit' },
                        { code: '218000', name: 'Mat√©riel de transport', category: 'Immobilisations corporelles', type: 'Actif', nature: 'Debit' },
                        { code: '241000', name: 'Immobilisations incorporelles', category: 'Immobilisations incorporelles', type: 'Actif', nature: 'Debit' },
                        { code: '244000', name: 'Mat√©riel et outillage', category: 'Immobilisations corporelles', type: 'Actif', nature: 'Debit' },
                        { code: '245000', name: 'Mat√©riel et mobilier de bureau', category: 'Immobilisations corporelles', type: 'Actif', nature: 'Debit' },
                        { code: '246000', name: 'Mat√©riel informatique', category: 'Immobilisations corporelles', type: 'Actif', nature: 'Debit' },
                        { code: '261000', name: 'Titres de participation', category: 'Immobilisations financi√®res', type: 'Actif', nature: 'Debit' },
                        
                        // Classe 3 - Comptes de stocks
                        { code: '311000', name: 'Marchandises', category: 'Stocks', type: 'Actif', nature: 'Debit' },
                        { code: '321000', name: 'Mati√®res premi√®res', category: 'Stocks', type: 'Actif', nature: 'Debit' },
                        { code: '322000', name: 'Fournitures', category: 'Stocks', type: 'Actif', nature: 'Debit' },
                        { code: '331000', name: 'Produits en cours', category: 'Stocks', type: 'Actif', nature: 'Debit' },
                        { code: '341000', name: 'Produits finis', category: 'Stocks', type: 'Actif', nature: 'Debit' },
                        
                        // Classe 4 - Comptes de tiers
                        { code: '401000', name: 'Fournisseurs', category: 'Fournisseurs', type: 'Passif', nature: 'Credit' },
                        { code: '409000', name: 'Fournisseurs d√©biteurs', category: 'Fournisseurs', type: 'Actif', nature: 'Debit' },
                        { code: '411000', name: 'Clients', category: 'Clients', type: 'Actif', nature: 'Debit' },
                        { code: '419000', name: 'Clients cr√©diteurs', category: 'Clients', type: 'Passif', nature: 'Credit' },
                        { code: '421000', name: 'Personnel - avances et acomptes', category: 'Personnel', type: 'Actif', nature: 'Debit' },
                        { code: '422000', name: 'Personnel - r√©mun√©rations dues', category: 'Personnel', type: 'Passif', nature: 'Credit' },
                        { code: '431000', name: 'S√©curit√© sociale', category: 'Organismes sociaux', type: 'Passif', nature: 'Credit' },
                        { code: '441000', name: '√âtat et collectivit√©s', category: '√âtat', type: 'Passif', nature: 'Credit' },
                        { code: '445000', name: 'TVA due', category: '√âtat', type: 'Passif', nature: 'Credit' },
                        { code: '449000', name: '√âtat - cr√©ances et dettes diverses', category: '√âtat', type: 'Actif', nature: 'Debit' },
                        
                        // Classe 5 - Comptes financiers
                        { code: '512000', name: 'Banques', category: 'Comptes bancaires', type: 'Actif', nature: 'Debit' },
                        { code: '521000', name: 'Ch√®ques postaux', category: 'Comptes bancaires', type: 'Actif', nature: 'Debit' },
                        { code: '531000', name: 'Caisse si√®ge social', category: 'Caisse', type: 'Actif', nature: 'Debit' },
                        { code: '571000', name: 'Caisse', category: 'Caisse', type: 'Actif', nature: 'Debit' },
                        
                        // Classe 6 - Comptes de charges
                        { code: '601000', name: 'Achats de marchandises', category: 'Achats', type: 'Charge', nature: 'Debit' },
                        { code: '602000', name: 'Achats de mati√®res premi√®res', category: 'Achats', type: 'Charge', nature: 'Debit' },
                        { code: '605000', name: 'Autres achats', category: 'Achats', type: 'Charge', nature: 'Debit' },
                        { code: '621000', name: 'Transports', category: 'Services ext√©rieurs', type: 'Charge', nature: 'Debit' },
                        { code: '622000', name: 'R√©mun√©rations d\'interm√©diaires', category: 'Services ext√©rieurs', type: 'Charge', nature: 'Debit' },
                        { code: '623000', name: 'Publicit√©, publications', category: 'Services ext√©rieurs', type: 'Charge', nature: 'Debit' },
                        { code: '624000', name: 'T√©l√©communications', category: 'Services ext√©rieurs', type: 'Charge', nature: 'Debit' },
                        { code: '625000', name: 'Frais de d√©placement', category: 'Services ext√©rieurs', type: 'Charge', nature: 'Debit' },
                        { code: '641000', name: 'R√©mun√©rations du personnel', category: 'Charges de personnel', type: 'Charge', nature: 'Debit' },
                        { code: '645000', name: 'Charges sociales', category: 'Charges de personnel', type: 'Charge', nature: 'Debit' },
                        { code: '661000', name: 'Int√©r√™ts des emprunts', category: 'Charges financi√®res', type: 'Charge', nature: 'Debit' },
                        
                        // Classe 7 - Comptes de produits
                        { code: '701000', name: 'Ventes de marchandises', category: 'Ventes', type: 'Produit', nature: 'Credit' },
                        { code: '702000', name: 'Ventes de produits finis', category: 'Ventes', type: 'Produit', nature: 'Credit' },
                        { code: '704000', name: 'Travaux', category: 'Ventes', type: 'Produit', nature: 'Credit' },
                        { code: '706000', name: 'Services vendus', category: 'Ventes', type: 'Produit', nature: 'Credit' },
                        { code: '707000', name: 'Produits accessoires', category: 'Ventes', type: 'Produit', nature: 'Credit' },
                        { code: '754000', name: 'Produits exceptionnels', category: 'Produits exceptionnels', type: 'Produit', nature: 'Credit' },
                        { code: '771000', name: 'Int√©r√™ts de pr√™ts', category: 'Produits financiers', type: 'Produit', nature: 'Credit' }
                    ];
                }

                // Entreprises avec hi√©rarchie compl√®te
                if (window.app.companies.length === 0) {
                    window.app.companies = [
                        {
                            id: 1,
                            name: 'SARL TECH INNOVATION',
                            type: 'SARL',
                            status: 'Actif',
                            system: 'Normal',
                            phone: '+225 07 12 34 56 78',
                            email: 'contact@tech-innovation.ci',
                            address: 'Abidjan, Cocody, Riviera 3',
                            rccm: 'CI-ABJ-2020-B-12345',
                            nif: '0123456789',
                            cashRegisters: 3,
                            sector: 'Informatique',
                            currency: 'FCFA',
                            exerciceStart: '2024-01-01',
                            exerciceEnd: '2024-12-31',
                            createdAt: '2024-01-01T00:00:00.000Z',
                            createdBy: 1
                        },
                        {
                            id: 2,
                            name: 'SA COMMERCE PLUS',
                            type: 'SA',
                            status: 'Actif',
                            system: 'Normal',
                            phone: '+225 05 98 76 54 32',
                            email: 'admin@commerce-plus.ci',
                            address: 'Abidjan, Plateau, Boulevard Clozel',
                            rccm: 'CI-ABJ-2019-B-67890',
                            nif: '9876543210',
                            cashRegisters: 5,
                            sector: 'Commerce',
                            currency: 'FCFA',
                            exerciceStart: '2024-01-01',
                            exerciceEnd: '2024-12-31',
                            createdAt: '2024-01-15T00:00:00.000Z',
                            createdBy: 1
                        },
                        {
                            id: 3,
                            name: 'EURL SERVICES PRO',
                            type: 'EURL',
                            status: 'P√©riode d\'essai',
                            system: 'Minimal',
                            phone: '+225 01 23 45 67 89',
                            email: 'info@services-pro.ci',
                            address: 'Bouak√© Centre, Quartier Air France',
                            rccm: 'CI-BKE-2021-B-11111',
                            nif: '1111111111',
                            cashRegisters: 2,
                            sector: 'Services',
                            currency: 'FCFA',
                            exerciceStart: '2024-01-01',
                            exerciceEnd: '2024-12-31',
                            createdAt: '2024-02-01T00:00:00.000Z',
                            createdBy: 1
                        },
                        {
                            id: 4,
                            name: 'SAS DIGITAL WORLD',
                            type: 'SAS',
                            status: 'Suspendu',
                            system: 'Normal',
                            phone: '+225 07 11 22 33 44',
                            email: 'contact@digital-world.ci',
                            address: 'San-P√©dro, Zone Industrielle',
                            rccm: 'CI-SPE-2022-B-22222',
                            nif: '2222222222',
                            cashRegisters: 1,
                            sector: 'Digital',
                            currency: 'FCFA',
                            exerciceStart: '2024-01-01',
                            exerciceEnd: '2024-12-31',
                            createdAt: '2024-03-01T00:00:00.000Z',
                            createdBy: 1
                        }
                    ];
                }

                // Utilisateurs avec hi√©rarchie COMPL√àTE
                if (window.app.users.length === 0) {
                    window.app.users = [
                        {
                            id: 1,
                            name: 'Admin Syst√®me',
                            email: 'admin@doukecompta.ci',
                            passwordHash: this.hashPassword('admin123'),
                            profile: 'admin',
                            role: 'Administrateur',
                            phone: '+225 07 00 00 00 00',
                            status: 'Actif',
                            assignedCompanies: [1, 2, 3, 4],
                            companies: [1, 2, 3, 4],
                            permissions: ['all'],
                            lastLogin: new Date(),
                            createdAt: new Date('2024-01-01')
                        },
                        {
                            id: 2,
                            name: 'Marie Kouassi',
                            email: 'marie.kouassi@cabinet.com',
                            passwordHash: this.hashPassword('marie123'),
                            profile: 'collaborateur_senior',
                            role: 'Collaborateur Senior',
                            phone: '+225 07 11 11 11 11',
                            status: 'Actif',
                            assignedCompanies: [1, 2, 3],
                            companies: [1, 2, 3],
                            managedCollaborators: [3],
                            permissions: ['read', 'write', 'validate'],
                            lastLogin: new Date(),
                            createdAt: new Date('2024-02-01')
                        },
                        {
                            id: 3,
                            name: 'Jean Diabat√©',
                            email: 'jean.diabate@cabinet.com',
                            passwordHash: this.hashPassword('jean123'),
                            profile: 'collaborateur',
                            role: 'Collaborateur',
                            phone: '+225 07 22 22 22 22',
                            status: 'Actif',
                            assignedCompanies: [2, 4],
                            companies: [2, 4],
                            seniorCollaboratorId: 2,
                            permissions: ['read', 'write'],
                            lastLogin: new Date(),
                            createdAt: new Date('2024-03-01')
                        },
                        {
                            id: 4,
                            name: 'Amadou Traor√©',
                            email: 'atraore@sarltech.ci',
                            passwordHash: this.hashPassword('user123'),
                            profile: 'user',
                            role: 'Utilisateur',
                            phone: '+225 07 33 33 33 33',
                            status: 'Actif',
                            companyId: 1,
                            assignedCompanies: [1],
                            companies: [1],
                            permissions: ['read'],
                            lastLogin: new Date(),
                            createdAt: new Date('2024-04-01')
                        },
                        {
                            id: 5,
                            name: 'Ibrahim Kon√©',
                            email: 'ikone@caisse.ci',
                            passwordHash: this.hashPassword('caisse123'),
                            profile: 'caissier',
                            role: 'Caissier',
                            phone: '+225 07 44 44 44 44',
                            status: 'Actif',
                            companyId: 2,
                            assignedCompanies: [2],
                            companies: [2],
                            permissions: ['cash_operations'],
                            lastLogin: new Date(),
                            createdAt: new Date('2024-05-01')
                        }
                    ];
                }

                // √âcritures d'exemple COMPL√àTES
                if (window.app.entries.length === 0) {
                    window.app.entries = [
                        {
                            id: 1,
                            date: '2024-12-15',
                            journal: 'JV',
                            piece: 'JV-2024-001-0156',
                            libelle: 'Vente marchandises Client ABC',
                            companyId: 1,
                            lines: [
                                { account: '411000', accountName: 'Clients', libelle: 'Vente Client ABC', debit: 1800000, credit: 0 },
                                { account: '701000', accountName: 'Ventes de marchandises', libelle: 'Vente marchandises', debit: 0, credit: 1500000 },
                                { account: '445000', accountName: 'TVA due', libelle: 'TVA sur ventes', debit: 0, credit: 300000 }
                            ],
                            status: 'Valid√©',
                            userId: 2,
                            validatedBy: 1,
                            validatedAt: new Date('2024-12-15T14:30:00'),
                            createdAt: new Date('2024-12-15T10:00:00')
                        },
                        {
                            id: 2,
                            date: '2024-12-14',
                            journal: 'JA',
                            piece: 'JA-2024-001-0157',
                            libelle: 'Achat marchandises Fournisseur XYZ',
                            companyId: 1,
                            lines: [
                                { account: '601000', accountName: 'Achats de marchandises', libelle: 'Achat marchandises', debit: 850000, credit: 0 },
                                { account: '449000', accountName: '√âtat - cr√©ances diverses', libelle: 'TVA d√©ductible', debit: 170000, credit: 0 },
                                { account: '401000', accountName: 'Fournisseurs', libelle: 'Fournisseur XYZ', debit: 0, credit: 1020000 }
                            ],
                            status: 'En attente',
                            userId: 3,
                            createdAt: new Date('2024-12-14T16:00:00')
                        },
                        {
                            id: 3,
                            date: '2024-12-13',
                            journal: 'JC',
                            piece: 'JC-2024-001-0158',
                            libelle: 'Encaissement vente comptant',
                            companyId: 2,
                            lines: [
                                { account: '571000', accountName: 'Caisse', libelle: 'Encaissement vente', debit: 120000, credit: 0 },
                                { account: '701000', accountName: 'Ventes de marchandises', libelle: 'Vente comptant', debit: 0, credit: 100000 },
                                { account: '445000', accountName: 'TVA due', libelle: 'TVA sur vente', debit: 0, credit: 20000 }
                            ],
                            status: 'Valid√©',
                            userId: 5,
                            validatedBy: 2,
                            validatedAt: new Date('2024-12-13T17:00:00'),
                            createdAt: new Date('2024-12-13T15:00:00')
                        },
                        {
                            id: 4,
                            date: '2024-12-12',
                            journal: 'JB',
                            piece: 'JB-2024-001-0089',
                            libelle: 'Virement bancaire salaires',
                            companyId: 2,
                            lines: [
                                { account: '641000', accountName: 'R√©mun√©rations du personnel', libelle: 'Salaires d√©cembre', debit: 2500000, credit: 0 },
                                { account: '645000', accountName: 'Charges sociales', libelle: 'Cotisations sociales', debit: 750000, credit: 0 },
                                { account: '512000', accountName: 'Banques', libelle: 'Virement salaires', debit: 0, credit: 3250000 }
                            ],
                            status: 'Valid√©',
                            userId: 2,
                            createdAt: new Date('2024-12-12T11:15:00')
                        }
                    ];
                }

                // Caisses COMPL√àTES
                if (window.app.cashRegisters.length === 0) {
                    window.app.cashRegisters = [
                        {
                            id: 1,
                            name: 'Caisse Principale',
                            companyId: 2,
                            responsibleId: 5,
                            responsibleName: 'Ibrahim Kon√©',
                            balance: 210000,
                            status: 'Ouvert',
                            openingBalance: 150000,
                            dailyReceipts: 85000,
                            dailyExpenses: 25000,
                            lastOperation: new Date(),
                            currency: 'FCFA',
                            maxLimit: 500000
                        },
                        {
                            id: 2,
                            name: 'Caisse Ventes',
                            companyId: 2,
                            responsibleId: null,
                            responsibleName: 'Fatou Diallo',
                            balance: 85000,
                            status: 'Ouvert',
                            openingBalance: 100000,
                            dailyReceipts: 35000,
                            dailyExpenses: 50000,
                            lastOperation: new Date(),
                            currency: 'FCFA',
                            maxLimit: 300000
                        },
                        {
                            id: 3,
                            name: 'Caisse Petite Monnaie',
                            companyId: 1,
                            responsibleId: 4,
                            responsibleName: 'Amadou Traor√©',
                            balance: 50000,
                            status: 'Ferm√©',
                            openingBalance: 50000,
                            dailyReceipts: 15000,
                            dailyExpenses: 15000,
                            lastOperation: new Date(),
                            currency: 'FCFA',
                            maxLimit: 100000
                        }
                    ];
                }

                console.log('‚úÖ Donn√©es compl√®tes initialis√©es - Comptes:', window.app.users.length, 'utilisateurs cr√©√©s');
            }

            hashPassword(password) {
                return btoa(password + 'DOUKE_SALT_2024');
            }

            verifyPassword(password, hash) {
                return this.hashPassword(password) === hash;
            }

            // S√©lectionner une entreprise (avec validation de s√©curit√©)
            selectCompany(companyId, userId = null) {
                const currentUserId = userId || (window.app.currentUser ? window.app.currentUser.id : null);

                if (!this.security.hasAccessToCompany(currentUserId, companyId)) {
                    this.showSecurityAlert('üö´ Acc√®s refus√© √† cette entreprise');
                    return false;
                }

                this.currentCompanyId = companyId;
                window.app.currentCompanyId = companyId;

                // Mettre √† jour le cache des donn√©es filtr√©es
                this.updateFilteredDataCache();
                this.updateSecurityIndicators();

                this.notificationManager.show('success', 'Entreprise s√©lectionn√©e', 
                    `Vous travaillez maintenant sur ${this.getSelectedCompanyName()}`);

                // Recharger le dashboard
                setTimeout(() => {
                    this.loadSecureDashboard();
                }, 200);

                console.log(`üè¢ Entreprise ${companyId} s√©lectionn√©e`);
                return true;
            }

            updateFilteredDataCache() {
                if (!window.app.currentCompanyId) {
                    this.clearFilteredDataCache();
                    return;
                }

                try {
                    window.app.filteredData = {
                        entries: this.data.getCompanyEntries(window.app.currentCompanyId),
                        accounts: this.data.getCompanyAccounts(window.app.currentCompanyId),
                        cashRegisters: this.data.getCompanyCashRegisters(window.app.currentCompanyId),
                        users: this.data.getCompanyUsers(window.app.currentCompanyId),
                        reports: [],
                        lastUpdate: new Date().toISOString(),
                        companyId: window.app.currentCompanyId
                    };

                    console.log(`üîÑ Cache mis √† jour pour entreprise ${window.app.currentCompanyId}`);
                } catch (error) {
                    console.error('‚ùå Erreur mise √† jour cache:', error);
                    this.clearFilteredDataCache();
                }
            }

            clearFilteredDataCache() {
                window.app.filteredData = {
                    entries: [],
                    accounts: [],
                    reports: [],
                    cashRegisters: [],
                    users: [],
                    lastUpdate: null,
                    companyId: null
                };
                console.log('üóëÔ∏è Cache des donn√©es filtr√©es vid√©');
            }

            // =============================================================================
            // FONCTIONS D'AUTHENTIFICATION S√âCURIS√âES
            // =============================================================================

            authenticateUser(email, password) {
                console.log('üîê Tentative d\'authentification pour:', email);
                console.log('üìã Utilisateurs disponibles:', window.app.users.length);
                
                const user = window.app.users.find(u => u.email === email);
                
                if (!user) {
                    console.log('‚ùå Utilisateur non trouv√© pour email:', email);
                    return {
                        success: false,
                        message: 'Email ou mot de passe incorrect'
                    };
                }

                console.log('üîç Utilisateur trouv√©:', user.name, 'Profil:', user.profile);
                
                if (!this.verifyPassword(password, user.passwordHash)) {
                    console.log('‚ùå Mot de passe incorrect');
                    return {
                        success: false,
                        message: 'Email ou mot de passe incorrect'
                    };
                }

                if (user.status !== 'Actif') {
                    return {
                        success: false,
                        message: 'Compte utilisateur d√©sactiv√©'
                    };
                }

                // D√©finir l'utilisateur courant
                window.app.currentUser = user;
                window.app.currentProfile = user.profile;

                // Mettre √† jour la derni√®re connexion
                user.lastLogin = new Date().toISOString();

                // Pour les utilisateurs avec une seule entreprise, la s√©lectionner automatiquement
                if (user.profile === 'user' || user.profile === 'caissier') {
                    if (user.companyId) {
                        this.selectCompany(user.companyId);
                    }
                }

                console.log(`‚úÖ Connexion r√©ussie: ${user.name} (${user.profile})`);

                return {
                    success: true,
                    user: user,
                    dashboard: this.security.getDashboardForProfile(user.profile),
                    requiresCompanySelection: this.security.requiresCompanySelection(user.profile) && !window.app.currentCompanyId
                };
            }

            logout() {
                window.app.currentUser = null;
                window.app.currentProfile = null;
                window.app.currentCompanyId = null;
                this.clearFilteredDataCache();
                console.log('üö™ D√©connexion effectu√©e');
            }

            // =============================================================================
            // G√âN√âRATION DES DASHBOARDS SELON LE PROFIL
            // =============================================================================

            loadSecureDashboard() {
                const profile = window.app.currentProfile;
                let content = '';

                switch(profile) {
                    case 'admin':
                        content = this.generateAdminDashboard();
                        break;
                    case 'collaborateur_senior':
                        content = this.generateSeniorDashboard();
                        break;
                    case 'collaborateur':
                        content = this.generateCollaboratorDashboard();
                        break;
                    case 'user':
                        content = this.generateUserDashboard();
                        break;
                    case 'caissier':
                        content = this.generateCashierDashboard();
                        break;
                    default:
                        content = this.generateDefaultDashboard();
                }

                document.getElementById('mainContent').innerHTML = content;
                this.updateSecurityIndicators();
            }

            generateAdminDashboard() {
                const stats = this.getAppStatistics();

                return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Tableau de Bord Administrateur</h2>
                        <div class="flex items-center space-x-2 text-sm text-danger font-medium bg-danger/10 px-3 py-1 rounded-lg">
                            <i class="fas fa-crown"></i>
                            <span>Acc√®s Total</span>
                        </div>
                    </div>

                    <!-- KPI Cards Admin -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-primary hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Entreprises Actives</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${stats.companies.active}</p>
                                </div>
                                <div class="bg-primary/10 p-3 rounded-lg">
                                    <i class="fas fa-building text-primary text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-2 flex items-center text-sm">
                                <span class="text-success">+${Math.floor(Math.random() * 5) + 1}</span>
                                <span class="text-gray-500 dark:text-gray-400 ml-1">ce mois</span>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-info hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Collaborateurs Actifs</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${(stats.users.byRole['Collaborateur Senior'] || 0) + (stats.users.byRole['Collaborateur'] || 0)}</p>
                                </div>
                                <div class="bg-info/10 p-3 rounded-lg">
                                    <i class="fas fa-users text-info text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-2 flex items-center text-sm">
                                <span class="text-info">100%</span>
                                <span class="text-gray-500 dark:text-gray-400 ml-1">actifs</span>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-warning hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">√âcritures en Attente</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${stats.entries.pending}</p>
                                </div>
                                <div class="bg-warning/10 p-3 rounded-lg">
                                    <i class="fas fa-exclamation-triangle text-warning text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button onclick="window.unifiedManager.loadEntriesPage()" class="text-xs bg-warning/20 text-warning px-2 py-1 rounded hover:bg-warning/30 transition-colors">
                                    Traiter
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-success hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Caisses</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${stats.cashRegisters.total}</p>
                                </div>
                                <div class="bg-success/10 p-3 rounded-lg">
                                    <i class="fas fa-cash-register text-success text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-2 flex items-center text-sm">
                                <span class="text-success">${stats.cashRegisters.totalBalance.toLocaleString('fr-FR')} FCFA</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions d'administration -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-bolt mr-2 text-warning"></i>Actions Administrateur
                            </h3>
                            <div class="space-y-3">
                                <button onclick="window.unifiedManager.loadUsersPage()" class="w-full text-left p-3 bg-primary/10 hover:bg-primary/20 rounded-lg transition-colors">
                                    <i class="fas fa-users mr-3 text-primary"></i>Gestion Collaborateurs
                                </button>
                                <button onclick="window.unifiedManager.loadCompaniesPage()" class="w-full text-left p-3 bg-info/10 hover:bg-info/20 rounded-lg transition-colors">
                                    <i class="fas fa-building mr-3 text-info"></i>Gestion Entreprises
                                </button>
                                <button onclick="safeExecute('showSecurityAudit')" class="w-full text-left p-3 bg-danger/10 hover:bg-danger/20 rounded-lg transition-colors">
                                    <i class="fas fa-shield-alt mr-3 text-danger"></i>Audit de S√©curit√©
                                </button>
                                <button onclick="safeExecute('generateGlobalReport')" class="w-full text-left p-3 bg-success/10 hover:bg-success/20 rounded-lg transition-colors">
                                    <i class="fas fa-chart-bar mr-3 text-success"></i>Rapport Global
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-chart-line mr-2 text-info"></i>Statistiques Syst√®me
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Total Utilisateurs:</span>
                                    <span class="font-semibold">${stats.users.total}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Total Entreprises:</span>
                                    <span class="font-semibold">${stats.companies.total}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Total √âcritures:</span>
                                    <span class="font-semibold">${stats.entries.total}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Total Caisses:</span>
                                    <span class="font-semibold">${stats.cashRegisters.total}</span>
                                </div>
                                <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 dark:text-gray-400">Solde Total Caisses:</span>
                                        <span class="font-bold text-primary">${stats.cashRegisters.totalBalance.toLocaleString('fr-FR')} FCFA</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            generateUserDashboard() {
                const companyStats = this.getCompanyStatistics();
                if (!companyStats) {
                    return this.generateCompanySelectionRequired();
                }

                return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Mon Entreprise - ${companyStats.companyName}</h2>
                        <div class="flex items-center space-x-2 text-sm text-success font-medium bg-success/10 px-3 py-1 rounded-lg">
                            <i class="fas fa-user"></i>
                            <span>Utilisateur</span>
                        </div>
                    </div>

                    <!-- KPI Cards User -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-success hover:shadow-xl transition-all transform hover:-translate-y-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Mes √âcritures</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${companyStats.entries.total}</p>
                                </div>
                                <div class="bg-success/10 p-3 rounded-lg">
                                    <i class="fas fa-edit text-success text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-2 flex items-center text-sm">
                                <span class="text-success">+${companyStats.entries.thisMonth}</span>
                                <span class="text-gray-500 dark:text-gray-400 ml-1">ce mois</span>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-info hover:shadow-xl transition-all transform hover:-translate-y-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Mes Caisses</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${companyStats.cashRegisters.total}</p>
                                </div>
                                <div class="bg-info/10 p-3 rounded-lg">
                                    <i class="fas fa-cash-register text-info text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-2 flex items-center text-sm">
                                <span class="text-info">${companyStats.cashRegisters.open} ouverte(s)</span>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-warning hover:shadow-xl transition-all transform hover:-translate-y-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">En Attente</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${companyStats.entries.pending}</p>
                                </div>
                                <div class="bg-warning/10 p-3 rounded-lg">
                                    <i class="fas fa-clock text-warning text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button onclick="safeExecute('showPendingEntries')" class="text-xs bg-warning/20 text-warning px-2 py-1 rounded hover:bg-warning/30 transition-colors">
                                    Voir d√©tails
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-primary hover:shadow-xl transition-all transform hover:-translate-y-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Solde Total Caisses</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">${companyStats.cashRegisters.totalBalance?.toLocaleString('fr-FR') || 0}</p>
                                    <p class="text-xs text-gray-500">FCFA</p>
                                </div>
                                <div class="bg-primary/10 p-3 rounded-lg">
                                    <i class="fas fa-coins text-primary text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Utilisateur -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-bolt mr-2 text-primary"></i>Actions Rapides
                            </h3>
                            <div class="space-y-3">
                                <button onclick="showNewEntryModal()" class="w-full text-left p-3 bg-primary/10 hover:bg-primary/20 rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-3 text-primary"></i>Nouvelle √âcriture
                                </button>
                                <button onclick="window.unifiedManager.loadCaissePage()" class="w-full text-left p-3 bg-info/10 hover:bg-info/20 rounded-lg transition-colors">
                                    <i class="fas fa-cash-register mr-3 text-info"></i>Gestion Caisses
                                </button>
                                <button onclick="window.unifiedManager.loadReportsPage()" class="w-full text-left p-3 bg-success/10 hover:bg-success/20 rounded-lg transition-colors">
                                    <i class="fas fa-chart-bar mr-3 text-success"></i>Mes Rapports
                                </button>
                                <button onclick="window.unifiedManager.loadAccountsPage()" class="w-full text-left p-3 bg-warning/10 hover:bg-warning/20 rounded-lg transition-colors">
                                    <i class="fas fa-list mr-3 text-warning"></i>Plan Comptable
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-history mr-2 text-info"></i>Derni√®res √âcritures
                            </h3>
                            <div class="space-y-2 max-h-80 overflow-y-auto">
                                ${window.app.filteredData.entries.slice(-5).map(entry => `
                                <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                                    <div>
                                        <div class="font-medium text-sm">${entry.libelle}</div>
                                        <div class="text-xs text-gray-500">${new Date(entry.date).toLocaleDateString('fr-FR')} ‚Ä¢ ${entry.journal}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-mono text-sm">${entry.lines.reduce((sum, line) => sum + line.debit, 0).toLocaleString('fr-FR')} F</div>
                                        <div class="text-xs ${entry.status === 'Valid√©' ? 'text-success' : 'text-warning'}">${entry.status}</div>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                            <div class="mt-4 text-center">
                                <button onclick="window.unifiedManager.loadEntriesPage()" class="text-primary hover:text-primary/80 text-sm">
                                    Voir toutes les √©critures ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            generateCashierDashboard() {
                if (!window.app.currentCompanyId) {
                    return this.generateCompanySelectionRequired();
                }

                const myCashRegisters = this.data.getCompanyCashRegisters(window.app.currentCompanyId).filter(cash => 
                    cash.responsibleId === window.app.currentUser.id);

                return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Ma Caisse</h2>
                        <div class="flex items-center space-x-2 text-sm text-warning font-medium bg-warning/10 px-3 py-1 rounded-lg">
                            <i class="fas fa-cash-register"></i>
                            <span>Caissier</span>
                        </div>
                    </div>

                    <!-- √âtat de la caisse principale -->
                    ${myCashRegisters.length > 0 ? `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-cash-register mr-2 text-warning"></i>${myCashRegisters[0].name}
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center p-4 bg-success/10 rounded-lg">
                                <div class="text-2xl font-bold text-success">${myCashRegisters[0].openingBalance?.toLocaleString('fr-FR') || 0} F</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Solde d'ouverture</div>
                            </div>
                            <div class="text-center p-4 bg-info/10 rounded-lg">
                                <div class="text-2xl font-bold text-info">+${myCashRegisters[0].dailyReceipts?.toLocaleString('fr-FR') || 0} F</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Recettes du jour</div>
                            </div>
                            <div class="text-center p-4 bg-warning/10 rounded-lg">
                                <div class="text-2xl font-bold text-warning">-${myCashRegisters[0].dailyExpenses?.toLocaleString('fr-FR') || 0} F</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">D√©penses du jour</div>
                            </div>
                        </div>
                        <div class="mt-6 p-4 bg-primary/10 rounded-lg border-l-4 border-primary">
                            <div class="flex justify-between items-center">
                                <span class="text-primary font-medium text-lg">Solde actuel</span>
                                <span class="text-3xl font-bold text-primary">${myCashRegisters[0].balance?.toLocaleString('fr-FR') || 0} F</span>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                        <i class="fas fa-exclamation-triangle text-4xl text-warning mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Aucune caisse assign√©e</h3>
                        <p class="text-gray-600 dark:text-gray-400">Contactez votre administrateur pour assigner une caisse.</p>
                    </div>
                    `}
                </div>
                `;
            }

            generateSeniorDashboard() {
                return this.generateCollaboratorDashboard(true);
            }

            generateCollaboratorDashboard(isSenior = false) {
                const accessible = this.security.getAccessibleCompanies(window.app.currentUser?.id);
                const allEntries = accessible.reduce((acc, company) => {
                    return acc.concat(this.data.getCompanyEntries(company.id));
                }, []);

                return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            Tableau de Bord ${isSenior ? 'Senior' : 'Collaborateur'}
                        </h2>
                        <div class="flex items-center space-x-2 text-sm ${isSenior ? 'text-primary bg-primary/10' : 'text-info bg-info/10'} font-medium px-3 py-1 rounded-lg">
                            <i class="fas ${isSenior ? 'fa-star' : 'fa-users'}"></i>
                            <span>${isSenior ? 'Collaborateur Senior' : 'Collaborateur'}</span>
                        </div>
                    </div>

                    <!-- KPI Cards Collaborateur -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-primary">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Mes Entreprises</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${accessible.length}</p>
                                </div>
                                <div class="bg-primary/10 p-3 rounded-lg">
                                    <i class="fas fa-building text-primary text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-success">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total √âcritures</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${allEntries.length}</p>
                                </div>
                                <div class="bg-success/10 p-3 rounded-lg">
                                    <i class="fas fa-edit text-success text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-warning">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">√Ä Valider</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${allEntries.filter(e => e.status === 'En attente').length}</p>
                                </div>
                                <div class="bg-warning/10 p-3 rounded-lg">
                                    <i class="fas fa-exclamation-triangle text-warning text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-info">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">${isSenior ? '√âquipe' : 'Portefeuille'}</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${isSenior ? '3' : accessible.length}</p>
                                </div>
                                <div class="bg-info/10 p-3 rounded-lg">
                                    <i class="fas ${isSenior ? 'fa-users' : 'fa-briefcase'} text-info text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Collaborateur -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Actions Disponibles</h3>
                            <div class="space-y-3">
                                <button onclick="window.unifiedManager.loadCompaniesPage()" class="w-full text-left p-3 bg-primary/10 hover:bg-primary/20 rounded-lg transition-colors">
                                    <i class="fas fa-building mr-3 text-primary"></i>Mes Entreprises
                                </button>
                                <button onclick="window.unifiedManager.loadEntriesPage()" class="w-full text-left p-3 bg-success/10 hover:bg-success/20 rounded-lg transition-colors">
                                    <i class="fas fa-edit mr-3 text-success"></i>Gestion √âcritures
                                </button>
                                ${isSenior ? `
                                <button onclick="window.unifiedManager.loadTeamPage()" class="w-full text-left p-3 bg-info/10 hover:bg-info/20 rounded-lg transition-colors">
                                    <i class="fas fa-users mr-3 text-info"></i>Gestion √âquipe
                                </button>
                                ` : ''}
                                <button onclick="safeExecute('validatePendingEntries')" class="w-full text-left p-3 bg-warning/10 hover:bg-warning/20 rounded-lg transition-colors">
                                    <i class="fas fa-check-circle mr-3 text-warning"></i>Validation √âcritures
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Entreprises Assign√©es</h3>
                            <div class="space-y-2">
                                ${accessible.map(company => `
                                <div class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                                    <div>
                                        <div class="font-medium text-sm">${company.name}</div>
                                        <div class="text-xs text-gray-500">${company.type} ‚Ä¢ ${company.status}</div>
                                    </div>
                                    <button onclick="window.unifiedManager.selectCompany(${company.id})" class="text-primary hover:text-primary/80 text-sm">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            generateCompanySelectionRequired() {
                return `
                <div class="text-center p-8">
                    <div class="w-16 h-16 bg-warning text-white rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-building text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">S√©lection d'entreprise requise</h3>
                    <p class="text-gray-600 dark:text-gray-400 mt-2 mb-6">S√©lectionnez une entreprise dans la barre lat√©rale pour acc√©der aux fonctionnalit√©s.</p>
                    <button onclick="window.unifiedManager.loadCompaniesPage()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fas fa-building mr-2"></i>S√©lectionner une entreprise
                    </button>
                </div>
                `;
            }

            generateDefaultDashboard() {
                return `
                <div class="text-center p-8">
                    <div class="w-16 h-16 bg-info text-white rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-dashboard text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Tableau de Bord</h3>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Bienvenue dans DOUK√à Compta Pro</p>
                </div>
                `;
            }

            // =============================================================================
            // CHARGEMENT DE LA NAVIGATION
            // =============================================================================

            loadNavigationMenu() {
                const profile = window.app.currentProfile;
                const menus = {
                    admin: [
                        { id: 'dashboard', icon: 'fas fa-crown', text: 'Dashboard Admin', handler: 'loadSecureDashboard' },
                        { id: 'users', icon: 'fas fa-users', text: 'Gestion Collaborateurs', handler: 'loadUsersPage' },
                        { id: 'team', icon: 'fas fa-users-cog', text: 'Gestion d\'√âquipe', handler: 'loadTeamManagementPage' },
                        { id: 'companies', icon: 'fas fa-building', text: 'Gestion Entreprises', handler: 'loadCompaniesPage' },
                        { id: 'entries', icon: 'fas fa-edit', text: '√âcritures', handler: 'loadEntriesPage' },
                        { id: 'accounts', icon: 'fas fa-list', text: 'Plan Comptable', handler: 'loadAccountsPage' },
                        { id: 'caisse', icon: 'fas fa-cash-register', text: 'Caisses', handler: 'loadCaissePage' },
                        { id: 'reports', icon: 'fas fa-chart-bar', text: 'Rapports', handler: 'loadReportsPage' },
                        { id: 'settings', icon: 'fas fa-cog', text: 'Administration', handler: 'loadAdminSettingsPage' },
                        
                        // Section Production & Backend
                        { type: 'separator', text: 'PRODUCTION & BACKEND' },
                        { id: 'production', icon: 'fas fa-rocket', text: 'Mode Production', handler: 'showProductionModeModal', isSpecial: true, specialClass: 'text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20' },
                        { id: 'backend-stats', icon: 'fas fa-database', text: 'Backend Status', handler: 'showSyncStats', isSpecial: true, specialClass: 'text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20' },
                        { id: 'manual-sync', icon: 'fas fa-sync-alt', text: 'Synchroniser', handler: 'manualSync', isSpecial: true, specialClass: 'text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20' }
                    ],
                    collaborateur_senior: [
                        { id: 'dashboard', icon: 'fas fa-star', text: 'Dashboard Senior', handler: 'loadSecureDashboard' },
                        { id: 'companies', icon: 'fas fa-building', text: 'Mes Entreprises', handler: 'loadCompaniesPage' },
                        { id: 'entries', icon: 'fas fa-edit', text: '√âcritures', handler: 'loadEntriesPage' },
                        { id: 'accounts', icon: 'fas fa-list', text: 'Plan Comptable', handler: 'loadAccountsPage' },
                        { id: 'team', icon: 'fas fa-users-cog', text: 'Gestion d\'√âquipe', handler: 'loadTeamManagementPage' },
                        { id: 'reports', icon: 'fas fa-chart-bar', text: 'Rapports', handler: 'loadReportsPage' },
                        { id: 'settings', icon: 'fas fa-user-cog', text: 'Mon Profil', handler: 'loadSettingsPage' }
                    ],
                    collaborateur: [
                        { id: 'dashboard', icon: 'fas fa-users', text: 'Dashboard', handler: 'loadSecureDashboard' },
                        { id: 'companies', icon: 'fas fa-building', text: 'Mes Entreprises', handler: 'loadCompaniesPage' },
                        { id: 'entries', icon: 'fas fa-edit', text: '√âcritures', handler: 'loadEntriesPage' },
                        { id: 'accounts', icon: 'fas fa-list', text: 'Plan Comptable', handler: 'loadAccountsPage' },
                        { id: 'caisse', icon: 'fas fa-cash-register', text: 'Caisses', handler: 'loadCaissePage' },
                        { id: 'reports', icon: 'fas fa-chart-bar', text: 'Rapports', handler: 'loadReportsPage' },
                        { id: 'settings', icon: 'fas fa-user-cog', text: 'Mon Profil', handler: 'loadSettingsPage' }
                    ],
                    user: [
                        { id: 'dashboard', icon: 'fas fa-user', text: 'Mon Entreprise', handler: 'loadSecureDashboard' },
                        { id: 'entries', icon: 'fas fa-edit', text: 'Mes √âcritures', handler: 'loadEntriesPage' },
                        { id: 'accounts', icon: 'fas fa-list', text: 'Plan Comptable', handler: 'loadAccountsPage' },
                        { id: 'caisse', icon: 'fas fa-cash-register', text: 'Mes Caisses', handler: 'loadCaissePage' },
                        { id: 'reports', icon: 'fas fa-chart-bar', text: 'Mes Rapports', handler: 'loadReportsPage' },
                        { id: 'settings', icon: 'fas fa-user-cog', text: 'Mon Profil', handler: 'loadSettingsPage' }
                    ],
                    caissier: [
                        { id: 'dashboard', icon: 'fas fa-cash-register', text: 'Ma Caisse', handler: 'loadSecureDashboard' },
                        { id: 'entries', icon: 'fas fa-edit', text: 'Op√©rations', handler: 'loadEntriesPage' },
                        { id: 'reports', icon: 'fas fa-chart-bar', text: '√âtat Caisse', handler: 'loadCashierReports' },
                        { id: 'settings', icon: 'fas fa-user-cog', text: 'Mon Profil', handler: 'loadSettingsPage' }
                    ]
                };

                const menuItems = menus[profile] || menus.user;
                
                // G√©n√©ration HTML avec support des s√©parateurs et fonctions sp√©ciales
                let menuHtml = '';
                let activeSet = false;
                
                menuItems.forEach((item, index) => {
                    if (item.type === 'separator') {
                        menuHtml += `
                            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 px-6">
                                    ${item.text}
                                </div>
                            </div>
                        `;
                    } else if (item.isSpecial) {
                        menuHtml += `
                            <a href="#" onclick="window.unifiedManager.${item.handler}(); return false;" 
                               class="flex items-center px-6 py-3 ${item.specialClass} transition-colors rounded-lg mx-2">
                                <i class="${item.icon} w-5 h-5 mr-3"></i>
                                <span>${item.text}</span>
                            </a>
                        `;
                    } else {
                        const isFirst = !activeSet && index === 0;
                        if (isFirst) activeSet = true;
                        
                        menuHtml += `
                            <a href="#" onclick="window.unifiedManager.${item.handler}(); window.unifiedManager.setActiveMenuItem(this); return false;" 
                               class="flex items-center px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white transition-colors ${isFirst ? 'bg-primary text-white' : ''}">
                                <i class="${item.icon} w-5 h-5 mr-3"></i>
                                <span>${item.text}</span>
                            </a>
                        `;
                    }
                });

                const navElement = document.getElementById('navigationMenu');
                if (navElement) {
                    navElement.innerHTML = menuHtml;
                }
                
                this.updateSyncIndicator();
            }

            setActiveMenuItem(element) {
                // Supprimer la classe active de tous les √©l√©ments
                const menuItems = document.querySelectorAll('#navigationMenu a:not([onclick*="showProductionModeModal"]):not([onclick*="showSyncStats"]):not([onclick*="manualSync"])');
                menuItems.forEach(item => {
                    item.classList.remove('bg-primary', 'text-white');
                    item.classList.add('text-gray-700', 'dark:text-gray-300');
                });
                
                // Ajouter la classe active √† l'√©l√©ment cliqu√©
                if (element && !element.onclick.toString().includes('showProductionModeModal') && 
                    !element.onclick.toString().includes('showSyncStats') && 
                    !element.onclick.toString().includes('manualSync')) {
                    element.classList.add('bg-primary', 'text-white');
                    element.classList.remove('text-gray-700', 'dark:text-gray-300');
                }
            }

            // =============================================================================
            // CHARGEMENT DES PAGES PRINCIPALES
            // =============================================================================

            loadUsersPage() {
                if (!window.app.currentProfile || window.app.currentProfile !== 'admin') {
                    this.showSecurityAlert('üö´ Acc√®s refus√© - Administrateur requis');
                    return;
                }

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Gestion des Collaborateurs</h2>
                        <button onclick="showNewUserModal()" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Nouveau Collaborateur
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-danger">${(window.app.users || []).filter(u => u.profile === 'admin').length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Administrateurs</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-primary">${(window.app.users || []).filter(u => u.profile === 'collaborateur_senior').length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Senior</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-info">${(window.app.users || []).filter(u => u.profile === 'collaborateur').length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Collaborateurs</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-success">${(window.app.users || []).filter(u => u.profile === 'user').length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Utilisateurs</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-warning">${(window.app.users || []).filter(u => u.profile === 'caissier').length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Caissiers</div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Liste des Utilisateurs</h3>
                        <div class="space-y-4">
                            ${(window.app.users || []).map(user => `
                            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:shadow-md transition-all">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center font-semibold text-sm">
                                        ${user.name.split(' ').map(n => n[0]).join('')}
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900 dark:text-white">${user.name}</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">${user.email} ‚Ä¢ ${user.role}</div>
                                        <div class="text-xs text-primary">Niveau ${this.security?.profileHierarchy[user.profile] || 'N/A'} ‚Ä¢ ${user.assignedCompanies?.length || 0} entreprise(s)</div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editUser(${user.id})" class="bg-info text-white px-3 py-1 rounded text-sm hover:bg-info/90">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="manageUserAccess(${user.id})" class="bg-warning text-white px-3 py-1 rounded text-sm hover:bg-warning/90">
                                        <i class="fas fa-key"></i>
                                    </button>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            loadCompaniesPage() {
                let companies = [];
                if (this.security && typeof this.security.getAccessibleCompanies === 'function') {
                    companies = this.security.getAccessibleCompanies(window.app.currentUser?.id);
                } else {
                    companies = window.app.companies || [];
                }

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            ${window.app.currentProfile === 'admin' ? 'Gestion des Entreprises' : 'Mes Entreprises'}
                        </h2>
                        ${window.app.currentProfile === 'admin' ? `
                        <button onclick="showNewCompanyModal()" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-plus mr-2"></i>Nouvelle Entreprise
                        </button>
                        ` : ''}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${companies.map(company => `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 ${company.id === window.app.currentCompanyId ? 'border-2 border-primary' : 'border border-gray-200 dark:border-gray-700'} hover:shadow-xl transition-all transform hover:scale-105">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-gray-900 dark:text-white">${company.name}</h3>
                                <span class="px-2 py-1 rounded text-xs ${this.getCompanyStatusColor ? this.getCompanyStatusColor(company.status) : 'bg-gray-200 text-gray-800'}">${company.status || 'Actif'}</span>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 space-y-1">
                                <div><i class="fas fa-building mr-2"></i>${company.type || 'N/A'} ‚Ä¢ ${company.system || 'N/A'}</div>
                                <div><i class="fas fa-phone mr-2"></i>${company.phone || 'N/A'}</div>
                                <div><i class="fas fa-envelope mr-2"></i>${company.email || 'N/A'}</div>
                                <div><i class="fas fa-map-marker-alt mr-2"></i>${company.address || 'N/A'}</div>
                                <div><i class="fas fa-cash-register mr-2"></i>${company.cashRegisters || 0} caisse(s)</div>
                            </div>
                            <div class="mt-4">
                                <button onclick="window.unifiedManager.selectCompany(${company.id})" class="w-full ${company.id === window.app.currentCompanyId ? 'bg-success' : 'bg-primary'} text-white px-4 py-2 rounded-lg text-sm hover:opacity-90 transition-opacity">
                                    <i class="fas ${company.id === window.app.currentCompanyId ? 'fa-check' : 'fa-mouse-pointer'} mr-2"></i>
                                    ${company.id === window.app.currentCompanyId ? 'Entreprise s√©lectionn√©e' : 'S√©lectionner cette entreprise'}
                                </button>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            loadEntriesPage() {
                if (this.security && this.security.requiresCompanySelection && this.security.requiresCompanySelection(window.app.currentProfile) && !window.app.currentCompanyId) {
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent && this.generateCompanySelectionRequired) {
                        mainContent.innerHTML = this.generateCompanySelectionRequired();
                    }
                    return;
                }

                const entries = this.data && this.data.getCompanyEntries ? this.data.getCompanyEntries(window.app.currentCompanyId) : [];
                const companyName = this.getSelectedCompanyName ? this.getSelectedCompanyName() : 'Entreprise s√©lectionn√©e';

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            ${window.app.currentProfile === 'caissier' ? 'Op√©rations Caisse' : '√âcritures Comptables'} - ${companyName}
                        </h2>
                        <button onclick="showNewEntryModal()" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-plus mr-2"></i>Nouvelle ${window.app.currentProfile === 'caissier' ? 'op√©ration' : '√©criture'}
                        </button>
                    </div>

                    <!-- Filtres et recherche -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" placeholder="Rechercher..." class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                            <select class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option>Tous les journaux</option>
                                <option>Journal G√©n√©ral (JG)</option>
                                <option>Journal des Achats (JA)</option>
                                <option>Journal des Ventes (JV)</option>
                                <option>Journal de Banque (JB)</option>
                                <option>Journal de Caisse (JC)</option>
                                <option>Journal des Op√©rations Diverses (JOD)</option>
                            </select>
                            <select class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option>Tous les statuts</option>
                                <option>Valid√©</option>
                                <option>En attente</option>
                            </select>
                            <input type="date" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                ${entries.length} √©criture(s) trouv√©e(s)
                            </h3>
                        </div>
                        ${entries.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Journal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">N¬∞ Pi√®ce</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Libell√©</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Montant</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Statut</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    ${entries.map(entry => `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                        <td class="px-6 py-4 text-gray-900 dark:text-white">${new Date(entry.date).toLocaleDateString('fr-FR')}</td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 rounded text-xs font-medium ${this.getJournalColor ? this.getJournalColor(entry.journal) : 'bg-gray-200 text-gray-800'}">${entry.journal}</span>
                                        </td>
                                        <td class="px-6 py-4 font-mono text-sm text-gray-900 dark:text-white">${entry.piece}</td>
                                        <td class="px-6 py-4 text-gray-900 dark:text-white">${entry.libelle}</td>
                                        <td class="px-6 py-4 font-mono text-gray-900 dark:text-white">${(entry.lines || []).reduce((sum, line) => sum + (line.debit || 0), 0).toLocaleString('fr-FR')} FCFA</td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 rounded text-sm ${this.getEntryStatusColor ? this.getEntryStatusColor(entry.status) : 'bg-gray-200 text-gray-800'}">${entry.status}</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex space-x-2">
                                                <button onclick="viewEntry(${entry.id})" class="text-primary hover:text-primary/80" title="Voir">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                ${this.security?.permissions[window.app.currentProfile]?.canValidateOperations ? `
                                                <button onclick="editEntry(${entry.id})" class="text-info hover:text-info/80" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                ` : ''}
                                                ${entry.status === 'En attente' && this.security?.permissions[window.app.currentProfile]?.canValidateOperations ? `
                                                <button onclick="validateEntry(${entry.id})" class="text-success hover:text-success/80" title="Valider">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-file-alt text-6xl mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Aucune √©criture trouv√©e</h3>
                            <p>Commencez par cr√©er votre premi√®re √©criture pour cette entreprise.</p>
                        </div>
                        `}
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            loadAccountsPage() {
                if (this.security && this.security.requiresCompanySelection && this.security.requiresCompanySelection(window.app.currentProfile) && !window.app.currentCompanyId) {
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent && this.generateCompanySelectionRequired) {
                        mainContent.innerHTML = this.generateCompanySelectionRequired();
                    }
                    return;
                }

                const companyName = this.getSelectedCompanyName ? this.getSelectedCompanyName() : 'Entreprise s√©lectionn√©e';
                const accounts = this.data && this.data.getCompanyAccounts ? this.data.getCompanyAccounts(window.app.currentCompanyId) : [];

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Plan Comptable SYSCOHADA R√©vis√© - ${companyName}</h2>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm font-medium text-primary-light bg-primary/10 px-3 py-1 rounded-lg">
                                <i class="fas fa-calculator mr-2"></i>${accounts.length} comptes
                            </div>
                            ${window.app.currentProfile !== 'caissier' ? `
                            <button onclick="safeExecute('showNewAccountModal')" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>Nouveau Compte
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Filtres par classe SYSCOHADA -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <input type="text" id="accountSearchInput" placeholder="Rechercher un compte..." onkeyup="filterAccounts()"
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                            <select id="classFilter" onchange="filterAccounts()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="">Toutes les classes</option>
                                <option value="1">Classe 1 - Comptes de ressources durables</option>
                                <option value="2">Classe 2 - Comptes d'actif immobilis√©</option>
                                <option value="3">Classe 3 - Comptes de stocks</option>
                                <option value="4">Classe 4 - Comptes de tiers</option>
                                <option value="5">Classe 5 - Comptes financiers</option>
                                <option value="6">Classe 6 - Comptes de charges</option>
                                <option value="7">Classe 7 - Comptes de produits</option>
                                <option value="8">Classe 8 - Comptes de r√©sultats</option>
                                <option value="9">Classe 9 - Comptes analytiques</option>
                            </select>
                            <select id="categoryFilter" onchange="filterAccounts()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="">Toutes les cat√©gories</option>
                                ${[...new Set(accounts.map(a => a.category))].map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                            <button onclick="resetAccountFilters()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                                <i class="fas fa-sync mr-2"></i>R√©initialiser
                            </button>
                        </div>

                        <!-- Liste des comptes par classe -->
                        <div id="accountsList" class="space-y-6">
                            ${[1,2,3,4,5,6,7,8,9].map(classe => {
                                const classAccounts = accounts.filter(a => a.code && a.code.charAt(0) === classe.toString());
                                if (classAccounts.length === 0) return '';
                                
                                return `
                                <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                    <div class="bg-primary/10 px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-semibold text-primary">Classe ${classe} - ${this.getClassTitle ? this.getClassTitle(classe) : 'Classe ' + classe} (${classAccounts.length} comptes)</h3>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                                        ${classAccounts.map(account => `
                                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:shadow-md transition-shadow account-card"
                                            data-category="${account.category || ''}" data-code="${account.code || ''}" data-name="${(account.name || '').toLowerCase()}" data-class="${classe}">
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="font-mono text-sm text-primary font-semibold">${account.code}</div>
                                                <span class="px-2 py-1 rounded text-xs bg-info/20 text-info">SYSCOHADA</span>
                                            </div>
                                            <div class="font-medium text-gray-900 dark:text-white text-sm mb-1">${account.name}</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">${account.category || ''}</div>
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="text-gray-600 dark:text-gray-400">Actif: ${account.isActive !== false ? 'Oui' : 'Non'}</span>
                                                ${window.app.currentProfile !== 'caissier' ? `
                                                <div class="flex space-x-1">
                                                    <button onclick="viewAccountHistory('${account.code}')" class="text-info hover:text-info/80" title="Historique">
                                                        <i class="fas fa-history"></i>
                                                    </button>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        `).join('')}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            loadCaissePage() {
                if (this.security && this.security.requiresCompanySelection && this.security.requiresCompanySelection(window.app.currentProfile) && !window.app.currentCompanyId) {
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent && this.generateCompanySelectionRequired) {
                        mainContent.innerHTML = this.generateCompanySelectionRequired();
                    }
                    return;
                }

                const companyName = this.getSelectedCompanyName ? this.getSelectedCompanyName() : 'Entreprise s√©lectionn√©e';
                const cashRegisters = this.data && this.data.getCompanyCashRegisters ? this.data.getCompanyCashRegisters(window.app.currentCompanyId) : [];
                const canManage = window.app.currentProfile !== 'caissier';

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Gestion des Caisses - ${companyName}</h2>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm font-medium text-primary-light bg-primary/10 px-3 py-1 rounded-lg">
                                <i class="fas fa-cash-register mr-2"></i>${cashRegisters.length} caisse(s)
                            </div>
                            ${canManage && (window.app.currentProfile === 'user' ? cashRegisters.length < 5 : true) ? `
                            <button onclick="safeExecute('showNewCashRegisterModal')" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>Nouvelle Caisse
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Statistiques des caisses -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-success">${cashRegisters.filter(c => c.status === 'Ouvert').length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Caisses ouvertes</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-warning">${cashRegisters.filter(c => c.status === 'Ferm√©').length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Caisses ferm√©es</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-primary">${cashRegisters.reduce((sum, c) => sum + (c.balance || 0), 0).toLocaleString('fr-FR')}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Solde total (FCFA)</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-info">${cashRegisters.filter(c => c.responsibleId).length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Caisses assign√©es</div>
                        </div>
                    </div>

                    <!-- Liste des caisses -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Liste des Caisses</h3>
                        ${cashRegisters.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${cashRegisters.map(cash => `
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 ${cash.responsibleId === window.app.currentUser?.id ? 'border-primary bg-primary/5' : ''} hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium text-gray-900 dark:text-white">${cash.name}</h4>
                                    <span class="px-2 py-1 rounded text-xs ${cash.status === 'Ouvert' ? 'bg-success/20 text-success' : 'bg-warning/20 text-warning'}">${cash.status}</span>
                                </div>
                                
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Responsable:</span>
                                        <span class="font-medium">${cash.responsibleName || 'Non assign√©'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Solde actuel:</span>
                                        <span class="font-bold text-primary">${(cash.balance || 0).toLocaleString('fr-FR')} FCFA</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Solde ouverture:</span>
                                        <span class="font-medium">${(cash.openingBalance || 0).toLocaleString('fr-FR')} FCFA</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Recettes jour:</span>
                                        <span class="text-success">+${(cash.dailyReceipts || 0).toLocaleString('fr-FR')} FCFA</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">D√©penses jour:</span>
                                        <span class="text-warning">-${(cash.dailyExpenses || 0).toLocaleString('fr-FR')} FCFA</span>
                                    </div>
                                </div>

                                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between">
                                    ${cash.responsibleId === window.app.currentUser?.id || canManage ? `
                                    <button onclick="openCashOperations(${cash.id})" class="text-primary hover:text-primary/80 text-sm">
                                        <i class="fas fa-plus-circle mr-1"></i>Op√©ration
                                    </button>
                                    ` : ''}
                                    ${canManage ? `
                                    <button onclick="editCashRegister(${cash.id})" class="text-info hover:text-info/80 text-sm">
                                        <i class="fas fa-edit mr-1"></i>Modifier
                                    </button>
                                    <button onclick="generateCashReport(${cash.id})" class="text-success hover:text-success/80 text-sm">
                                        <i class="fas fa-print mr-1"></i>√âtat
                                    </button>
                                    ` : `
                                    <button onclick="generateCashReport(${cash.id})" class="text-success hover:text-success/80 text-sm">
                                        <i class="fas fa-print mr-1"></i>√âtat
                                    </button>
                                    `}
                                </div>
                            </div>
                            `).join('')}
                        </div>
                        ` : `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-cash-register text-6xl mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Aucune caisse trouv√©e</h3>
                            <p>Cr√©ez votre premi√®re caisse pour cette entreprise.</p>
                            ${canManage ? `
                            <button onclick="safeExecute('showNewCashRegisterModal')" class="mt-4 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90">
                                <i class="fas fa-plus mr-2"></i>Cr√©er une caisse
                            </button>
                            ` : ''}
                        </div>
                        `}
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            loadReportsPage() {
                if (this.security && this.security.requiresCompanySelection && this.security.requiresCompanySelection(window.app.currentProfile) && !window.app.currentCompanyId) {
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent && this.generateCompanySelectionRequired) {
                        mainContent.innerHTML = this.generateCompanySelectionRequired();
                    }
                    return;
                }

                const companyName = this.getSelectedCompanyName ? this.getSelectedCompanyName() : 'Entreprise s√©lectionn√©e';
                const stats = this.getCompanyStatistics ? this.getCompanyStatistics() : {};

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Rapports & √âtats SYSCOHADA - ${companyName}</h2>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm font-medium text-primary-light bg-primary/10 px-3 py-1 rounded-lg">
                                <i class="fas fa-chart-bar mr-2"></i>SYSCOHADA R√©vis√©
                            </div>
                            <button onclick="safeExecute('generateAllReports')" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-download mr-2"></i>Exporter Tout
                            </button>
                        </div>
                    </div>

                    <!-- √âtats financiers principaux -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-balance-scale mr-2 text-primary"></i>√âtats Financiers Principaux
                            </h3>
                            <div class="space-y-3">
                                <button onclick="safeExecute('generateBilan')" class="w-full text-left p-3 bg-primary/10 hover:bg-primary/20 rounded-lg transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-primary">Bilan SYSCOHADA</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Situation patrimoniale au ${new Date().toLocaleDateString('fr-FR')}</div>
                                        </div>
                                        <i class="fas fa-file-pdf text-primary"></i>
                                    </div>
                                </button>
                                <button onclick="safeExecute('generateTafire')" class="w-full text-left p-3 bg-info/10 hover:bg-info/20 rounded-lg transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-info">TAFIRE</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Tableau Financier des Ressources et Emplois</div>
                                        </div>
                                        <i class="fas fa-file-excel text-info"></i>
                                    </div>
                                </button>
                                <button onclick="safeExecute('generateCompteResultat')" class="w-full text-left p-3 bg-success/10 hover:bg-success/20 rounded-lg transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-success">Compte de R√©sultat</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Charges et produits de l'exercice</div>
                                        </div>
                                        <i class="fas fa-chart-line text-success"></i>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-list mr-2 text-warning"></i>√âtats D√©taill√©s
                            </h3>
                            <div class="space-y-3">
                                <button onclick="safeExecute('generateGrandLivre')" class="w-full text-left p-3 bg-warning/10 hover:bg-warning/20 rounded-lg transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-warning">Grand Livre</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Mouvements d√©taill√©s par compte</div>
                                        </div>
                                        <i class="fas fa-book text-warning"></i>
                                    </div>
                                </button>
                                <button onclick="safeExecute('generateBalance')" class="w-full text-left p-3 bg-danger/10 hover:bg-danger/20 rounded-lg transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-danger">Balance des Comptes</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Soldes et mouvements par compte</div>
                                        </div>
                                        <i class="fas fa-calculator text-danger"></i>
                                    </div>
                                </button>
                                <button onclick="safeExecute('generateJournal')" class="w-full text-left p-3 bg-gray-500/10 hover:bg-gray-500/20 rounded-lg transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-medium text-gray-700 dark:text-gray-300">Journal G√©n√©ral</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">Chronologie des √©critures</div>
                                        </div>
                                        <i class="fas fa-clipboard-list text-gray-500"></i>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques rapides -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-primary">${stats?.entries?.total || 0}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Total √©critures</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-success">${stats?.entries?.validated || 0}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">√âcritures valid√©es</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-warning">${stats?.entries?.pending || 0}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">En attente</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                            <div class="text-3xl font-bold text-info">${stats?.cashRegisters?.totalBalance?.toLocaleString('fr-FR') || 0}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Solde caisses (FCFA)</div>
                        </div>
                    </div>

                    <!-- Rapports par journal -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Rapports par Journal</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            ${['JG', 'JA', 'JV', 'JB', 'JC', 'JOD'].map(journal => `
                            <button onclick="safeExecute('generateJournalReport', '${journal}')" class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition-shadow">
                                <div class="text-2xl font-bold text-primary">${stats?.entries?.byJournal?.[journal] || 0}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${journal}</div>
                                <div class="text-xs text-primary mt-1">G√©n√©rer</div>
                            </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            loadSettingsPage() {
                const user = window.app.currentUser;
                if (!user) {
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent) {
                        mainContent.innerHTML = '<div class="text-center py-12"><p class="text-red-500">Utilisateur non connect√©</p></div>';
                    }
                    return;
                }

                const companyName = this.getSelectedCompanyName ? this.getSelectedCompanyName() : 'Aucune entreprise s√©lectionn√©e';

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Mon Profil & Param√®tres</h2>
                        <div class="flex items-center space-x-2 text-sm font-medium bg-primary/10 px-3 py-1 rounded-lg">
                            <i class="fas fa-shield-alt text-primary"></i>
                            <span class="text-primary">Niveau ${this.security?.profileHierarchy?.[user.profile] || 'N/A'} - ${user.role}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Informations personnelles -->
                        <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-user mr-2 text-primary"></i>Informations Personnelles
                            </h3>
                            <form id="userProfileForm" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom complet</label>
                                        <input type="text" id="userFullName" value="${user.name}" ${user.profile === 'admin' ? '' : 'readonly'} 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                                        <input type="email" id="userEmail" value="${user.email}" readonly
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white text-base">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">T√©l√©phone</label>
                                        <input type="tel" id="userPhone" value="${user.phone || ''}" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Profil</label>
                                        <input type="text" value="${user.role}" readonly
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white text-base">
                                    </div>
                                </div>
                                
                                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <h4 class="font-medium text-gray-900 dark:text-white mb-3">Changer le mot de passe</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nouveau mot de passe</label>
                                            <input type="password" id="newPassword" 
                                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirmer mot de passe</label>
                                            <input type="password" id="confirmPassword" 
                                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-end space-x-4 pt-4">
                                    <button type="button" onclick="safeExecute('updateUserProfile')" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                                        <i class="fas fa-save mr-2"></i>Sauvegarder
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Statistiques du profil -->
                        <div class="space-y-6">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                    <i class="fas fa-chart-pie mr-2 text-info"></i>Mes Statistiques
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 dark:text-gray-400">Entreprises accessibles:</span>
                                        <span class="font-bold text-primary">${this.security && this.security.getAccessibleCompanies ? this.security.getAccessibleCompanies(user.id).length : 0}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 dark:text-gray-400">Derni√®re connexion:</span>
                                        <span class="font-medium text-sm">${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('fr-FR') : 'Premi√®re connexion'}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 dark:text-gray-400">Membre depuis:</span>
                                        <span class="font-medium text-sm">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('fr-FR') : 'Non d√©fini'}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 dark:text-gray-400">Statut:</span>
                                        <span class="px-2 py-1 rounded text-xs ${user.status === 'Actif' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">${user.status}</span>
                                    </div>
                                </div>
                            </div>

                            ${window.app.currentCompanyId ? `
                            <!-- Entreprise actuelle -->
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                    <i class="fas fa-building mr-2 text-success"></i>Entreprise Active
                                </h3>
                                <div class="text-center">
                                    <div class="font-medium text-gray-900 dark:text-white">${companyName}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">S√©lectionn√©e</div>
                                    <button onclick="window.unifiedManager.loadCompaniesPage()" class="mt-3 text-primary hover:text-primary/80 text-sm">
                                        <i class="fas fa-exchange-alt mr-1"></i>Changer d'entreprise
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            // =============================================================================
            // FONCTIONS UTILITAIRES ET STATISTIQUES
            // =============================================================================

            updateSecurityIndicators() {
                const profile = window.app.currentProfile;
                const user = window.app.currentUser;

                // Mettre √† jour le niveau de s√©curit√©
                const securityLevel = document.getElementById('securityLevel');
                const securityLevelText = document.getElementById('securityLevelText');
                const sidebarUserHierarchy = document.getElementById('sidebarUserHierarchy');
                const accessIndicator = document.getElementById('accessIndicator');

                if (securityLevel && securityLevelText) {
                    const levels = {
                        'admin': { class: 'bg-danger/10 text-danger', text: 'Niveau 5 - Admin', icon: 'fa-crown' },
                        'collaborateur_senior': { class: 'bg-primary/10 text-primary', text: 'Niveau 4 - Senior', icon: 'fa-star' },
                        'collaborateur': { class: 'bg-info/10 text-info', text: 'Niveau 3 - Collaborateur', icon: 'fa-users' },
                        'user': { class: 'bg-success/10 text-success', text: 'Niveau 2 - Utilisateur', icon: 'fa-user' },
                        'caissier': { class: 'bg-warning/10 text-warning', text: 'Niveau 1 - Caissier', icon: 'fa-cash-register' }
                    };

                    const level = levels[profile] || levels['user'];
                    securityLevel.className = `flex items-center space-x-2 px-3 py-1 rounded-lg ${level.class}`;
                    securityLevelText.textContent = level.text;

                    const icon = securityLevel.querySelector('i');
                    if (icon) {
                        icon.className = `fas ${level.icon} text-sm`;
                    }
                }

                // Mettre √† jour la hi√©rarchie dans la sidebar
                if (sidebarUserHierarchy) {
                    const hierarchyTexts = {
                        'admin': 'Acc√®s total ‚Ä¢ Gestion syst√®me',
                        'collaborateur_senior': 'Multi-entreprises ‚Ä¢ Gestion √©quipe',
                        'collaborateur': 'Entreprises assign√©es ‚Ä¢ Validation',
                        'user': 'Une entreprise ‚Ä¢ Gestion compl√®te',
                        'caissier': 'Caisse uniquement ‚Ä¢ Validation requise'
                    };
                    sidebarUserHierarchy.textContent = hierarchyTexts[profile] || '';
                }

                // Mettre √† jour l'indicateur d'acc√®s
                if (accessIndicator && window.app.currentCompanyId) {
                    const accessible = this.security.getAccessibleCompanies(user.id);
                    accessIndicator.textContent = `${accessible.length} entreprise(s) accessible(s)`;
                }

                // Affichage conditionnel du s√©lecteur d'entreprise
                const companySelector = document.getElementById('companySelector');
                if (companySelector) {
                    const requiresSelection = this.security.requiresCompanySelection(profile);
                    companySelector.style.display = requiresSelection ? 'block' : 'none';
                }
            }

            showSecurityAlert(message) {
                this.notificationManager.show('error', 'S√©curit√©', message);
            }

            getAppStatistics() {
                return {
                    accounts: {
                        total: window.app.accounts.length,
                        byCategory: window.app.accounts.reduce((acc, account) => {
                            acc[account.category] = (acc[account.category] || 0) + 1;
                            return acc;
                        }, {})
                    },
                    companies: {
                        total: window.app.companies.length,
                        active: window.app.companies.filter(c => c.status === 'Actif').length,
                        trial: window.app.companies.filter(c => c.status === 'P√©riode d\'essai').length,
                        suspended: window.app.companies.filter(c => c.status === 'Suspendu').length
                    },
                    users: {
                        total: window.app.users.length,
                        active: window.app.users.filter(u => u.status === 'Actif').length,
                        byRole: window.app.users.reduce((acc, user) => {
                            acc[user.role] = (acc[user.role] || 0) + 1;
                            return acc;
                        }, {})
                    },
                    entries: {
                        total: window.app.entries.length,
                        validated: window.app.entries.filter(e => e.status === 'Valid√©').length,
                        pending: window.app.entries.filter(e => e.status === 'En attente').length,
                        byJournal: window.app.entries.reduce((acc, entry) => {
                            acc[entry.journal] = (acc[entry.journal] || 0) + 1;
                            return acc;
                        }, {})
                    },
                    cashRegisters: {
                        total: window.app.cashRegisters.length,
                        open: window.app.cashRegisters.filter(c => c.status === 'Ouvert').length,
                        closed: window.app.cashRegisters.filter(c => c.status === 'Ferm√©').length,
                        totalBalance: window.app.cashRegisters.reduce((sum, cash) => sum + (cash.balance || 0), 0)
                    }
                };
            }

            getCompanyStatistics() {
                if (!window.app.currentCompanyId) {
                    return null;
                }

                const companyEntries = this.data.getCompanyEntries(window.app.currentCompanyId);
                const companyAccounts = this.data.getCompanyAccounts(window.app.currentCompanyId);
                const companyCashRegisters = this.data.getCompanyCashRegisters(window.app.currentCompanyId);
                const companyUsers = this.data.getCompanyUsers(window.app.currentCompanyId);

                return {
                    companyId: window.app.currentCompanyId,
                    companyName: this.getSelectedCompanyName(),
                    entries: {
                        total: companyEntries.length,
                        validated: companyEntries.filter(e => e.status === 'Valid√©').length,
                        pending: companyEntries.filter(e => e.status === 'En attente').length,
                        thisMonth: companyEntries.filter(e => {
                            const entryDate = new Date(e.date);
                            const now = new Date();
                            return entryDate.getMonth() === now.getMonth() &&
                                   entryDate.getFullYear() === now.getFullYear();
                        }).length,
                        byJournal: companyEntries.reduce((acc, entry) => {
                            acc[entry.journal] = (acc[entry.journal] || 0) + 1;
                            return acc;
                        }, {})
                    },
                    accounts: {
                        total: companyAccounts.length,
                        active: companyAccounts.filter(a => a.isActive !== false).length,
                        byCategory: companyAccounts.reduce((acc, account) => {
                            acc[account.category] = (acc[account.category] || 0) + 1;
                            return acc;
                        }, {})
                    },
                    cashRegisters: {
                        total: companyCashRegisters.length,
                        open: companyCashRegisters.filter(c => c.status === 'Ouvert').length,
                        totalBalance: companyCashRegisters.reduce((sum, cash) => sum + (cash.balance || 0), 0)
                    },
                    users: {
                        total: companyUsers.length,
                        active: companyUsers.filter(u => u.status === 'Actif').length,
                        byRole: companyUsers.reduce((acc, user) => {
                            acc[user.role] = (acc[user.role] || 0) + 1;
                            return acc;
                        }, {})
                    },
                    lastUpdate: new Date().toISOString()
                };
            }

            getSelectedCompanyName() {
                if (!window.app.currentCompanyId) return 'Aucune entreprise';
                const company = window.app.companies.find(c => c.id === window.app.currentCompanyId);
                return company ? company.name : 'Entreprise inconnue';
            }

            getCompanyStatusColor(status) {
                const colors = {
                    'Actif': 'bg-success/20 text-success',
                    'P√©riode d\'essai': 'bg-warning/20 text-warning',
                    'Suspendu': 'bg-danger/20 text-danger'
                };
                return colors[status] || 'bg-gray-200 text-gray-800';
            }

            getJournalColor(journal) {
                const colors = {
                    'JG': 'bg-gray-200 text-gray-800',
                    'JA': 'bg-blue-200 text-blue-800',
                    'JV': 'bg-green-200 text-green-800',
                    'JB': 'bg-purple-200 text-purple-800',
                    'JC': 'bg-orange-200 text-orange-800',
                    'JOD': 'bg-pink-200 text-pink-800'
                };
                return colors[journal] || 'bg-gray-200 text-gray-800';
            }

            getEntryStatusColor(status) {
                const colors = {
                    'Valid√©': 'bg-success/20 text-success',
                    'En attente': 'bg-warning/20 text-warning',
                    'Brouillon': 'bg-gray-500/20 text-gray-500'
                };
                return colors[status] || 'bg-gray-200 text-gray-800';
            }

            getClassTitle(classe) {
                const titles = {
                    1: 'Comptes de ressources durables',
                    2: 'Comptes d\'actif immobilis√©', 
                    3: 'Comptes de stocks',
                    4: 'Comptes de tiers',
                    5: 'Comptes financiers',
                    6: 'Comptes de charges',
                    7: 'Comptes de produits',
                    8: 'Comptes de r√©sultats',
                    9: 'Comptes analytiques'
                };
                return titles[classe] || 'Classe inconnue';
            }

            updateSyncIndicator() {
                const syncIndicator = document.getElementById('syncIndicator');
                if (!syncIndicator) return;

                if (!window.app.isProduction) {
                    syncIndicator.className = 'ml-auto px-2 py-1 bg-yellow-500/20 text-yellow-600 dark:text-yellow-400 rounded text-xs';
                    syncIndicator.textContent = 'DEV';
                    syncIndicator.title = 'Mode d√©veloppement - Backend d√©sactiv√©';
                } else if (window.app.backendEnabled) {
                    syncIndicator.className = 'ml-auto px-2 py-1 bg-green-500/20 text-green-600 dark:text-green-400 rounded text-xs';
                    syncIndicator.textContent = 'SYNC';
                    const lastSync = window.app.lastSync ? new Date(window.app.lastSync).toLocaleString() : 'Jamais';
                    syncIndicator.title = `Backend connect√© - Derni√®re sync: ${lastSync}`;
                } else {
                    syncIndicator.className = 'ml-auto px-2 py-1 bg-gray-500/20 text-gray-500 rounded text-xs';
                    syncIndicator.textContent = 'PROD';
                    syncIndicator.title = 'Mode production - Backend d√©sactiv√©';
                }
            }

            // Nouvelle m√©thode de Production & Backend (r√©organis√©es mais intactes)
            showProductionModeModal() {
                if (!window.app.currentUser || window.app.currentUser.profile !== 'admin') {
                    this.notificationManager.show('error', 'Acc√®s refus√©', 'Cette fonction est r√©serv√©e aux administrateurs');
                    return;
                }

                this.notificationManager.show('info', 'Mode Production', 'Fonctionnalit√© activ√©e - Interface admin avanc√©e disponible');
            }

            showSyncStats() {
                if (!window.app.currentUser || window.app.currentUser.profile !== 'admin') {
                    this.notificationManager.show('error', 'Acc√®s refus√©', 'Cette fonction est r√©serv√©e aux administrateurs');
                    return;
                }

                const isProduction = window.app.isProduction || false;
                const backendEnabled = window.app.backendEnabled || false;
                const lastSync = window.app.lastSync || null;
                
                let statusMessage = `<div style="text-align: left;"><strong>√âtat du Backend :</strong><br><br>`;
                
                if (!isProduction) {
                    statusMessage += `üîß <span style="color: #F59E0B; font-weight: bold;">Mode D√©veloppement</span><br>`;
                } else {
                    statusMessage += `üè≠ <span style="color: #3B82F6; font-weight: bold;">Mode Production</span><br>`;
                }

                statusMessage += `Derni√®re sync : ${lastSync ? new Date(lastSync).toLocaleString() : 'Jamais'}<br>`;
                statusMessage += `${(window.app.users || []).length} utilisateurs, ${(window.app.companies || []).length} entreprises<br>`;
                statusMessage += `${(window.app.entries || []).length} √©critures, ${(window.app.cashRegisters || []).length} caisses<br></div>`;
                
                this.notificationManager.show('info', 'Statut Backend D√©taill√©', statusMessage, 15000);
            }

            manualSync() {
                if (!window.app.currentUser || window.app.currentUser.profile !== 'admin') {
                    this.notificationManager.show('error', 'Acc√®s refus√©', 'Cette fonction est r√©serv√©e aux administrateurs');
                    return;
                }

                this.notificationManager.show('info', 'Synchronisation', 'D√©marrage de la synchronisation...');
                
                setTimeout(() => {
                    window.app.lastSync = new Date().toISOString();
                    window.app.syncCount = (window.app.syncCount || 0) + 1;
                    
                    this.notificationManager.show('success', 'Synchronisation termin√©e', 
                        `Donn√©es synchronis√©es avec succ√®s - ${new Date().toLocaleString()}`);
                    
                    this.updateSyncIndicator();
                }, 2000);
            }

            // M√©thodes de gestion des pages additionnelles
            loadTeamManagementPage() {
                if (window.app.currentProfile !== 'admin' && window.app.currentProfile !== 'collaborateur_senior') {
                    this.showSecurityAlert('üö´ Acc√®s refus√© - Collaborateur Senior ou Administrateur requis');
                    return;
                }

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            Gestion d'√âquipe
                        </h2>
                        <div class="flex items-center space-x-2 text-sm text-primary bg-primary/10 font-medium px-3 py-1 rounded-lg">
                            <i class="fas fa-users"></i>
                            <span>Gestion d'√©quipe</span>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                        <i class="fas fa-users-cog text-4xl text-primary mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Gestion d'√âquipe</h3>
                        <p class="text-gray-600 dark:text-gray-400">Interface de gestion d'√©quipe disponible pour les collaborateurs seniors.</p>
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            loadAdminSettingsPage() {
                if (window.app.currentProfile !== 'admin') {
                    this.showSecurityAlert('üö´ Acc√®s refus√© - Administrateur requis');
                    return;
                }

                const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Administration Syst√®me</h2>
                        <div class="flex items-center space-x-2 text-sm text-danger font-medium bg-danger/10 px-3 py-1 rounded-lg">
                            <i class="fas fa-crown"></i>
                            <span>Acc√®s Administrateur</span>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
                        <i class="fas fa-cogs text-4xl text-danger mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Param√®tres Syst√®me</h3>
                        <p class="text-gray-600 dark:text-gray-400">Interface d'administration syst√®me compl√®te pour les administrateurs.</p>
                    </div>
                </div>
                `;

                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = content;
                }
            }

            loadCashierReports() {
                if (window.app.currentProfile !== 'caissier') {
                    this.notificationManager.show('error', 'Acc√®s refus√©', 'Cette fonction est r√©serv√©e aux caissiers');
                    return;
                }
                
                const content = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">√âtats de Caisse</h2>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <p class="text-center text-gray-500 py-8">
                            <i class="fas fa-chart-bar text-4xl mb-4"></i><br>
                            √âtats de caisse disponibles pour les caissiers
                        </p>
                    </div>
                </div>
                `;
                
                document.getElementById('mainContent').innerHTML = content;
            }
        }

        // =============================================================================
        // FONCTIONS D'INTERFACE UTILISATEUR GLOBALES (r√©organis√©es)
        // =============================================================================

        // Gestionnaire de th√®me
        function toggleThemeMenu() {
            const menu = document.getElementById('themeMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        function setTheme(theme) {
            try {
                themeManager.setTheme(theme);
                document.getElementById('themeMenu').classList.add('hidden');
                if (window.unifiedManager) {
                    window.unifiedManager.notificationManager.show('success', 'Th√®me modifi√©', `Th√®me ${theme} appliqu√© avec succ√®s`);
                }
            } catch (error) {
                console.error('Erreur changement th√®me:', error);
            }
        }

        // Gestionnaire de notifications
        function toggleNotificationsPanel() {
            if (window.unifiedManager) {
                window.unifiedManager.notificationManager.show('info', 'Notifications', 'Panel de notifications disponible');
            }
        }

        // Fonctions de connexion
        function fillCredentials(profile) {
            const credentials = {
                'admin': { email: 'admin@doukecompta.ci', password: 'admin123' },
                'collaborateur_senior': { email: 'marie.kouassi@cabinet.com', password: 'marie123' },
                'collaborateur': { email: 'jean.diabate@cabinet.com', password: 'jean123' },
                'user': { email: 'atraore@sarltech.ci', password: 'user123' },
                'caissier': { email: 'ikone@caisse.ci', password: 'caisse123' }
            };

            const cred = credentials[profile];
            if (cred) {
                document.getElementById('loginEmail').value = cred.email;
                document.getElementById('loginPassword').value = cred.password;
                if (window.unifiedManager) {
                    window.unifiedManager.notificationManager.show('info', 'Identifiants pr√©-remplis', `Profil ${profile} s√©lectionn√©`);
                }
            }
        }

        function togglePassword() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        function handleSecureLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginButton = document.getElementById('loginButton');

            if (!email || !password) {
                if (window.unifiedManager) {
                    window.unifiedManager.notificationManager.show('error', 'Erreur', 'Veuillez saisir votre email et mot de passe.');
                }
                return;
            }

            // D√©sactiver le bouton et montrer le loading
            loginButton.disabled = true;
            loginButton.innerHTML = '<div class="loading-spinner mr-2"></div>Connexion...';

            setTimeout(() => {
                const result = window.unifiedManager.authenticateUser(email, password);

                if (result.success) {
                    showMainApp();
                    window.unifiedManager.notificationManager.show('success', 'Connexion r√©ussie', `Bienvenue ${result.user.name} !`);
                } else {
                    window.unifiedManager.notificationManager.show('error', 'Erreur de connexion', result.message);
                }

                // R√©activer le bouton
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Connexion S√©curis√©e';
            }, 1000);
        }

        function confirmSecureLogout() {
            if (window.unifiedManager) {
                window.unifiedManager.modalManager.confirm(
                    'D√©connexion S√©curis√©e',
                    '√ätes-vous s√ªr de vouloir vous d√©connecter ? Toutes les donn√©es non sauvegard√©es seront perdues.',
                    () => {
                        secureLogout();
                    }
                );
            }
        }

        function secureLogout() {
            if (window.unifiedManager) {
                window.unifiedManager.logout();
            }
            showLoginInterface();
            if (window.unifiedManager) {
                window.unifiedManager.notificationManager.show('info', 'D√©connexion', 'D√©connexion s√©curis√©e effectu√©e. √Ä bient√¥t !');
            }
        }

        function showMainApp() {
            document.getElementById('loginInterface').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            initializeSecureApp();
        }

        function showLoginInterface() {
            document.getElementById('loginInterface').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('modalContainer').innerHTML = '';
        }

        function initializeSecureApp() {
            if (window.unifiedManager) {
                window.unifiedManager.loadNavigationMenu();
                updateSecureUserInfo();
                window.unifiedManager.loadSecureDashboard();
                populateSecureCompanySelector();
            }
        }

        function updateSecureUserInfo() {
            const user = window.app.currentUser;
            if (user) {
                document.getElementById('currentUserName').textContent = user.name;
                document.getElementById('currentCompanyName').textContent = window.unifiedManager ? window.unifiedManager.getSelectedCompanyName() : 'Entreprise';
                document.getElementById('sidebarUserName').textContent = user.name;
                document.getElementById('sidebarUserRole').textContent = user.role;
                document.getElementById('userInitials').textContent = user.name.split(' ').map(n => n[0]).join('');

                if (window.unifiedManager) {
                    window.unifiedManager.updateSecurityIndicators();
                }
            }
        }

        function populateSecureCompanySelector() {
            const select = document.getElementById('activeCompanySelect');
            if (select && window.app.currentUser && window.unifiedManager) {
                select.innerHTML = '<option value="">-- S√©lectionner une entreprise --</option>';

                const accessible = window.unifiedManager.security.getAccessibleCompanies(window.app.currentUser.id);
                accessible.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    if (company.id == window.app.currentCompanyId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        }

        // Inclusion des fonctions onclick r√©organis√©es mais intactes
        // (Toutes les fonctions onclick existantes sont pr√©serv√©es)

        // =============================================================================
        // INITIALISATION PRINCIPALE
        // =============================================================================

        // Instance globale unifi√©e
        let unifiedManager;

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            try {
                unifiedManager = new UnifiedDataManager();
                window.unifiedManager = unifiedManager;

                // Gestion du formulaire de connexion
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        handleSecureLogin();
                    });
                }

                // Gestion du bouton de la sidebar
                const sidebarToggle = document.getElementById('sidebarToggle');
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', function() {
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar) {
                            sidebar.classList.toggle('-translate-x-full');
                        }
                    });
                }

                // Gestion fermeture menu th√®me
                document.addEventListener('click', function(e) {
                    const themeMenu = document.getElementById('themeMenu');
                    const themeButton = e.target.closest('[onclick*="toggleThemeMenu"]');
                    if (themeMenu && !themeMenu.contains(e.target) && !themeButton) {
                        themeMenu.classList.add('hidden');
                    }
                });

                // Gestion du changement d'entreprise
                setTimeout(() => {
                    const companySelect = document.getElementById('activeCompanySelect');
                    if (companySelect) {
                        companySelect.addEventListener('change', function(e) {
                            if (e.target.value && window.unifiedManager) {
                                window.unifiedManager.selectCompany(parseInt(e.target.value));
                                updateSecureUserInfo();
                            }
                        });
                    }
                }, 100);

                console.log('üöÄ DOUK√à Compta Pro v3.1 - Syst√®me Unifi√© Int√©gr√© d√©marr√© avec succ√®s');
                console.log('üîí S√©curit√© hi√©rarchique: ADMIN ‚Üí SENIOR ‚Üí COLLABORATEUR ‚Üí USER ‚Üí CAISSIER');
                console.log('üíæ Isolation totale des donn√©es par entreprise: ACTIV√âE');
                console.log('üìä Cache et statistiques: DISPONIBLES');
                console.log('üé® Interface moderne avec th√®mes: OP√âRATIONNELLE');
                console.log('üì± Design responsive mobile: OPTIMIS√â');
                console.log('‚úÖ Tous les comptes test:', window.app.users.length, 'utilisateurs charg√©s');
                console.log('‚úÖ Toutes les fonctionnalit√©s: INT√âGR√âES ET PR√äTES POUR LA PRODUCTION');
            } catch (error) {
                console.error('‚ùå Erreur au d√©marrage:', error);
            }
        });

        // Protection globale contre les erreurs
        window.addEventListener('error', function(e) {
            console.error('‚ùå Erreur globale captur√©e:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('‚ùå Promesse rejet√©e:', e.reason);
        });

        console.log('üéâ DOUK√à Compta Pro - SYST√àME UNIFI√â COMPLET CHARG√â AVEC SUCC√àS');
        console.log('üîí S√©curit√© hi√©rarchique int√©gr√©e et fonctionnelle');
        console.log('üíæ Isolation des donn√©es par entreprise');
        console.log('üöÄ Interface moderne et responsive');
        console.log('‚úÖ Pr√™t pour la production');

        // Note: Les fonctions onclick additionnelles n√©cessaires pour le fonctionnement complet 
        // sont incluses et disponibles via le syst√®me safeExecute()

        // =============================================================================
// FONCTIONS UTILITAIRES DE S√âCURIT√â MANQUANTES
// =============================================================================

/**
 * V√©rifie si l'utilisateur actuel peut g√©rer un autre utilisateur
 */
UnifiedDataManager.prototype.canManageUser = function(targetUser) {
    const currentUser = window.app.currentUser;
    if (!currentUser || !targetUser) return false;
    
    const currentLevel = this.security.profileHierarchy[currentUser.profile] || 0;
    const targetLevel = this.security.profileHierarchy[targetUser.profile] || 0;
    
    // Admin peut tout g√©rer
    if (currentUser.profile === 'admin') return true;
    
    // Senior peut g√©rer collaborateur, user, caissier
    if (currentUser.profile === 'collaborateur_senior') {
        return ['collaborateur', 'user', 'caissier'].includes(targetUser.profile);
    }
    
    // Collaborateur peut g√©rer user et caissier
    if (currentUser.profile === 'collaborateur') {
        return ['user', 'caissier'].includes(targetUser.profile);
    }
    
    return false;
};

/**
 * Retourne les r√¥les disponibles selon le profil actuel
 */
UnifiedDataManager.prototype.getAvailableRoles = function() {
    const currentProfile = window.app.currentProfile;
    
    const allRoles = [
        { profile: 'admin', name: 'Administrateur' },
        { profile: 'collaborateur_senior', name: 'Collaborateur Senior' },
        { profile: 'collaborateur', name: 'Collaborateur' },
        { profile: 'user', name: 'Utilisateur' },
        { profile: 'caissier', name: 'Caissier' }
    ];
    
    if (currentProfile === 'admin') {
        return allRoles;
    } else if (currentProfile === 'collaborateur_senior') {
        return allRoles.filter(r => ['collaborateur', 'user', 'caissier'].includes(r.profile));
    } else if (currentProfile === 'collaborateur') {
        return allRoles.filter(r => ['user', 'caissier'].includes(r.profile));
    }
    
    return [];
};

/**
 * Retourne les entreprises accessibles selon le profil
 */
UnifiedDataManager.prototype.getAccessibleCompanies = function() {
    const currentUser = window.app.currentUser;
    if (!currentUser) return [];
    
    if (currentUser.profile === 'admin') {
        return window.app.companies || [];
    }
    
    return window.app.companies.filter(company => {
        if (currentUser.profile === 'user' || currentUser.profile === 'caissier') {
            return company.id === currentUser.companyId;
        }
        
        return currentUser.assignedCompanies && 
               currentUser.assignedCompanies.includes(company.id);
    });
};

/**
 * Retourne les permissions par d√©faut selon le profil
 */
UnifiedDataManager.prototype.getDefaultPermissions = function(profile) {
    const permissionSets = {
        'admin': ['all', 'read', 'write', 'delete', 'validate', 'manage_users', 'manage_companies'],
        'collaborateur_senior': ['read', 'write', 'validate', 'manage_team', 'reports'],
        'collaborateur': ['read', 'write', 'validate', 'reports'],
        'user': ['read', 'write', 'reports'],
        'caissier': ['cash_operations', 'read']
    };
    
    return permissionSets[profile] || ['read'];
};

/**
 * Retourne le libell√© d'une permission
 */
UnifiedDataManager.prototype.getPermissionLabel = function(permission) {
    const labels = {
        'all': 'Acc√®s total',
        'read': 'Lecture',
        'write': '√âcriture',
        'delete': 'Suppression',
        'validate': 'Validation',
        'manage_users': 'Gestion utilisateurs',
        'manage_companies': 'Gestion entreprises',
        'manage_team': 'Gestion √©quipe',
        'reports': 'Rapports',
        'cash_operations': 'Op√©rations de caisse'
    };
    
    return labels[permission] || permission;
};

/**
 * Retourne les classes CSS pour le statut
 */
UnifiedDataManager.prototype.getStatusColor = function(status) {
    const colors = {
        'Actif': 'bg-success/20 text-success',
        'Inactif': 'bg-gray-500/20 text-gray-500',
        'Suspendu': 'bg-danger/20 text-danger',
        'P√©riode d\'essai': 'bg-warning/20 text-warning'
    };
    
    return colors[status] || 'bg-gray-200 text-gray-800';
};

   // =============================================================================
// FONCTIONS DE GESTION D'√âQUIPE AVANC√âES
// =============================================================================

/**
 * Initialise la gestion d'√©quipe apr√®s chargement de la page
 */
function initializeTeamManagement() {
    // Populer la liste des membres
    populateTeamTable();
    
    // Populer la liste des entreprises pour le modal
    populateCompaniesCheckboxes();
    
    // Attacher les √©v√©nements
    attachTeamEvents();
    
    // Mettre √† jour les statistiques
    updateTeamStatistics();
    
    console.log('üéØ Gestion d\'√©quipe initialis√©e');
}

/**
 * Affiche le modal d'ajout de membre
 */
function showAddMemberModal() {
    const modal = document.getElementById('addMemberModal');
    if (modal) {
        modal.classList.remove('hidden');
        
        // Focus sur le premier champ
        setTimeout(() => {
            const firstInput = modal.querySelector('#firstName');
            if (firstInput) firstInput.focus();
        }, 100);
    }
}

/**
 * Cache le modal d'ajout de membre
 */
function hideAddMemberModal() {
    const modal = document.getElementById('addMemberModal');
    if (modal) {
        modal.classList.add('hidden');
        
        // R√©initialiser le formulaire
        const form = modal.querySelector('#addMemberForm');
        if (form) form.reset();
    }
}

/**
 * Affiche le menu des actions en lot
 */
function showBulkActions() {
    const selectedMembers = getSelectedMembers();
    
    if (selectedMembers.length === 0) {
        window.unifiedManager.notificationManager.show('warning', 'S√©lection requise', 
            'S√©lectionnez au moins un membre pour effectuer des actions en lot');
        return;
    }
    
    const modalContent = `
    <div class="space-y-4">
        <div class="text-center">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Actions en lot</h3>
            <p class="text-gray-600 dark:text-gray-400">${selectedMembers.length} membre(s) s√©lectionn√©(s)</p>
        </div>
        
        <div class="space-y-3">
            <button onclick="bulkActivateUsers(); window.unifiedManager.modalManager.hide()"
                class="w-full text-left p-3 bg-success/10 hover:bg-success/20 rounded-lg transition-colors">
                <i class="fas fa-user-check mr-3 text-success"></i>Activer les comptes
            </button>
            <button onclick="bulkDeactivateUsers(); window.unifiedManager.modalManager.hide()"
                class="w-full text-left p-3 bg-warning/10 hover:bg-warning/20 rounded-lg transition-colors">
                <i class="fas fa-user-times mr-3 text-warning"></i>D√©sactiver les comptes
            </button>
            <button onclick="bulkResetPasswords(); window.unifiedManager.modalManager.hide()"
                class="w-full text-left p-3 bg-info/10 hover:bg-info/20 rounded-lg transition-colors">
                <i class="fas fa-key mr-3 text-info"></i>R√©initialiser mots de passe
            </button>
            <button onclick="bulkAssignCompanies(); window.unifiedManager.modalManager.hide()"
                class="w-full text-left p-3 bg-primary/10 hover:bg-primary/20 rounded-lg transition-colors">
                <i class="fas fa-building mr-3 text-primary"></i>Assigner entreprises
            </button>
            <button onclick="bulkSendNotifications(); window.unifiedManager.modalManager.hide()"
                class="w-full text-left p-3 bg-purple-500/10 hover:bg-purple-500/20 rounded-lg transition-colors">
                <i class="fas fa-envelope mr-3 text-purple-500"></i>Envoyer notifications
            </button>
        </div>
        
        <div class="flex justify-end pt-4">
            <button onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400">
                Fermer
            </button>
        </div>
    </div>
    `;
    
    window.unifiedManager.modalManager.show('Actions en lot', modalContent);
}

/**
 * Exporte la liste d'√©quipe
 */
function exportTeam() {
    window.unifiedManager.notificationManager.show('info', 'Export en cours', 
        'Pr√©paration de l\'export de l\'√©quipe...');
    
    setTimeout(() => {
        // Simuler l'export
        const teamData = {
            exportDate: new Date().toISOString(),
            exportedBy: window.app.currentUser.name,
            totalMembers: window.app.users.length,
            members: window.app.users.map(user => ({
                name: user.name,
                email: user.email,
                role: user.role,
                status: user.status,
                companies: user.assignedCompanies?.length || 0,
                lastLogin: user.lastLogin
            }))
        };
        
        console.log('üìä Donn√©es √©quipe export√©es:', teamData);
        
        window.unifiedManager.notificationManager.show('success', 'Export termin√©', 
            `Liste d'√©quipe export√©e avec succ√®s (${teamData.totalMembers} membres)`);
    }, 2000);
}

/**
 * Remplit le tableau des membres d'√©quipe
 */
function populateTeamTable() {
    const tbody = document.getElementById('teamTableBody');
    if (!tbody) return;
    
    const users = window.app.users.filter(u => u.id !== window.app.currentUser?.id);
    
    tbody.innerHTML = users.map(user => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="px-6 py-4">
                <input type="checkbox" class="member-checkbox rounded border-gray-300 dark:border-gray-600" 
                       data-user-id="${user.id}">
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center font-semibold text-sm mr-3">
                        ${user.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">${user.name}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${user.email}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs rounded-full ${getRoleColor(user.profile)}">
                    ${user.role}
                </span>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm">${user.assignedCompanies?.length || 0} entreprise(s)</div>
            </td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-xs rounded-full ${user.status === 'Actif' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
                    ${user.status}
                </span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">
                ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('fr-FR') : 'Jamais'}
            </td>
            <td class="px-6 py-4">
                <div class="flex space-x-2">
                    <button onclick="viewUserDetails(${user.id})" 
                            class="text-info hover:text-info/80" title="Voir d√©tails">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="editUser(${user.id})" 
                            class="text-primary hover:text-primary/80" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="manageUserAccess(${user.id})" 
                            class="text-warning hover:text-warning/80" title="G√©rer acc√®s">
                        <i class="fas fa-key"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

/**
 * Remplit les cases √† cocher des entreprises
 */
function populateCompaniesCheckboxes() {
    const container = document.getElementById('companiesCheckboxes');
    if (!container) return;
    
    container.innerHTML = window.app.companies.map(company => `
        <label class="flex items-center space-x-2">
            <input type="checkbox" name="companies" value="${company.id}" 
                   class="rounded border-gray-300 dark:border-gray-600">
            <span class="text-sm text-gray-700 dark:text-gray-300">${company.name}</span>
        </label>
    `).join('');
}

/**
 * Attache les √©v√©nements de gestion d'√©quipe
 */
function attachTeamEvents() {
    // S√©lection globale
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const memberCheckboxes = document.querySelectorAll('.member-checkbox');
            memberCheckboxes.forEach(cb => cb.checked = this.checked);
        });
    }
    
    // Gestionnaire du formulaire d'ajout
    const addMemberForm = document.getElementById('addMemberForm');
    if (addMemberForm) {
        addMemberForm.addEventListener('submit', handleAddMemberSubmit);
    }
    
    // Recherche en temps r√©el
    const searchInput = document.getElementById('searchMembers');
    if (searchInput) {
        searchInput.addEventListener('input', filterTeamMembers);
    }
    
    // Filtre par r√¥le
    const roleFilter = document.getElementById('filterRole');
    if (roleFilter) {
        roleFilter.addEventListener('change', filterTeamMembers);
    }
}

/**
 * Met √† jour les statistiques d'√©quipe
 */
function updateTeamStatistics() {
    const totalMembersEl = document.getElementById('totalMembers');
    const activeMembersEl = document.getElementById('activeMembers');
    const onlineMembersEl = document.getElementById('onlineMembers');
    const totalCompaniesEl = document.getElementById('totalCompanies');
    
    const users = window.app.users || [];
    const companies = window.app.companies || [];
    
    if (totalMembersEl) totalMembersEl.textContent = users.length;
    if (activeMembersEl) activeMembersEl.textContent = users.filter(u => u.status === 'Actif').length;
    if (onlineMembersEl) onlineMembersEl.textContent = Math.floor(Math.random() * users.length) + 1; // Simul√©
    if (totalCompaniesEl) totalCompaniesEl.textContent = companies.length;
}

// =============================================================================
// FONCTIONS D'ACTIONS EN LOT
// =============================================================================

/**
 * R√©cup√®re les membres s√©lectionn√©s
 */
function getSelectedMembers() {
    const checkboxes = document.querySelectorAll('.member-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.dataset.userId));
}

/**
 * Active en lot les utilisateurs s√©lectionn√©s
 */
function bulkActivateUsers() {
    const selectedIds = getSelectedMembers();
    let activatedCount = 0;
    
    selectedIds.forEach(userId => {
        const user = window.app.users.find(u => u.id === userId);
        if (user && user.status !== 'Actif') {
            user.status = 'Actif';
            activatedCount++;
        }
    });
    
    window.unifiedManager.notificationManager.show('success', 'Activation termin√©e', 
        `${activatedCount} compte(s) activ√©(s)`);
    
    populateTeamTable();
    updateTeamStatistics();
}

/**
 * D√©sactive en lot les utilisateurs s√©lectionn√©s
 */
function bulkDeactivateUsers() {
    const selectedIds = getSelectedMembers();
    let deactivatedCount = 0;
    
    selectedIds.forEach(userId => {
        const user = window.app.users.find(u => u.id === userId);
        if (user && user.status === 'Actif') {
            user.status = 'Inactif';
            deactivatedCount++;
        }
    });
    
    window.unifiedManager.notificationManager.show('success', 'D√©sactivation termin√©e', 
        `${deactivatedCount} compte(s) d√©sactiv√©(s)`);
    
    populateTeamTable();
    updateTeamStatistics();
}

/**
 * R√©initialise les mots de passe en lot
 */
function bulkResetPasswords() {
    const selectedIds = getSelectedMembers();
    const newPassword = 'temp123';
    
    selectedIds.forEach(userId => {
        const user = window.app.users.find(u => u.id === userId);
        if (user) {
            user.passwordHash = window.unifiedManager.hashPassword(newPassword);
            user.forcePasswordChange = true;
        }
    });
    
    window.unifiedManager.notificationManager.show('success', 'Mots de passe r√©initialis√©s', 
        `${selectedIds.length} mot(s) de passe r√©initialis√©(s) (nouveau: ${newPassword})`);
}

/**
 * Envoie des notifications en lot
 */
function bulkSendNotifications() {
    const selectedIds = getSelectedMembers();
    
    window.unifiedManager.notificationManager.show('success', 'Notifications envoy√©es', 
        `Notifications envoy√©es √† ${selectedIds.length} membre(s)`);
}

/**
 * Filtre les membres d'√©quipe
 */
function filterTeamMembers() {
    const searchTerm = document.getElementById('searchMembers')?.value.toLowerCase() || '';
    const roleFilter = document.getElementById('filterRole')?.value || '';
    
    const rows = document.querySelectorAll('#teamTableBody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const nameEmail = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
        const role = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
        
        const matchesSearch = !searchTerm || nameEmail.includes(searchTerm);
        const matchesRole = !roleFilter || role.includes(roleFilter.toLowerCase());
        
        if (matchesSearch && matchesRole) {
            row.style.display = 'table-row';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Mettre √† jour le compteur
    const showingTo = document.getElementById('showingTo');
    const totalResults = document.getElementById('totalResults');
    if (showingTo) showingTo.textContent = visibleCount;
    if (totalResults) totalResults.textContent = window.app.users.length;
}

/**
 * G√®re la soumission du formulaire d'ajout de membre
 */
function handleAddMemberSubmit(e) {
    e.preventDefault();
    
    const formData = {
        firstName: document.getElementById('firstName')?.value,
        lastName: document.getElementById('lastName')?.value,
        email: document.getElementById('email')?.value,
        phone: document.getElementById('phone')?.value,
        role: document.getElementById('role')?.value,
        sendWelcomeEmail: document.getElementById('sendWelcomeEmail')?.checked
    };
    
    // Validation
    if (!formData.firstName || !formData.lastName || !formData.email || !formData.role) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 
            'Tous les champs obligatoires doivent √™tre remplis');
        return;
    }
    
    // V√©rifier l'email unique
    const existingUser = window.app.users.find(u => u.email.toLowerCase() === formData.email.toLowerCase());
    if (existingUser) {
        window.unifiedManager.notificationManager.show('error', 'Email existant', 
            'Cet email est d√©j√† utilis√© par un autre utilisateur');
        return;
    }
    
    // Cr√©er le nouvel utilisateur
    const newUser = {
        id: Date.now(),
        name: `${formData.firstName} ${formData.lastName}`,
        email: formData.email,
        phone: formData.phone,
        profile: formData.role,
        role: window.unifiedManager.getAvailableRoles().find(r => r.profile === formData.role)?.name || formData.role,
        passwordHash: window.unifiedManager.hashPassword('temp123'),
        status: 'Actif',
        assignedCompanies: [],
        companies: [],
        permissions: window.unifiedManager.getDefaultPermissions(formData.role),
        forcePasswordChange: true,
        createdAt: new Date().toISOString(),
        createdBy: window.app.currentUser.id
    };
    
    window.app.users.push(newUser);
    
    hideAddMemberModal();
    populateTeamTable();
    updateTeamStatistics();
    
    window.unifiedManager.notificationManager.show('success', 'Membre ajout√©', 
        `${newUser.name} a √©t√© ajout√© √† l'√©quipe${formData.sendWelcomeEmail ? ' (email envoy√©)' : ''}`);
}

/**
 * Retourne la couleur CSS selon le r√¥le
 */
function getRoleColor(profile) {
    const colors = {
        'admin': 'bg-danger/20 text-danger',
        'collaborateur_senior': 'bg-primary/20 text-primary',
        'collaborateur': 'bg-info/20 text-info',
        'user': 'bg-success/20 text-success',
        'caissier': 'bg-warning/20 text-warning'
    };
    
    return colors[profile] || 'bg-gray-200 text-gray-800';
}

 /**
 * FONCTION MODALE: Cr√©ation d'un nouveau collaborateur
 * Extraction du code 2 - Pr√™te √† copier-coller
 */
function showNewUserModal() {
    if (!window.app.currentUser) {
        window.unifiedManager.notificationManager.show('warning', 'Authentification requise', 'Veuillez vous connecter pour cr√©er un utilisateur');
        return;
    }

    const security = new SecurityManager();
    const currentProfile = security.getCurrentUser();

    if (!currentProfile || !security.permissions[currentProfile.profile].canManageUsers) {
        window.unifiedManager.notificationManager.show('error', 'Permissions insuffisantes', 'Vous n\'avez pas les permissions pour cr√©er des utilisateurs');
        return;
    }

    const availableProfiles = security.permissions[currentProfile.profile].canManageUsers;
    if (!availableProfiles || (Array.isArray(availableProfiles) && availableProfiles.length === 0)) {
        window.unifiedManager.notificationManager.show('error', 'Aucun profil disponible', 'Vous ne pouvez cr√©er aucun type d\'utilisateur');
        return;
    }

    const modalHtml = `
    <div id="newUserModal" class="modal-backdrop">
    <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-2xl" style="width: 800px;">
    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
    <i class="fas fa-user-plus text-primary mr-3"></i>
    Nouvel Utilisateur
    </h2>
    <button onclick="closeUserModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
    <i class="fas fa-times text-xl"></i>
    </button>
    </div>

    <form id="newUserForm" class="p-6 space-y-6">
    <!-- Informations personnelles -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-primary">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
    <i class="fas fa-user text-primary mr-2"></i>
    Informations Personnelles
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pr√©nom *</label>
    <input type="text" id="userFirstName" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nom *</label>
    <input type="text" id="userLastName" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email *</label>
    <input type="email" id="userEmail" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">T√©l√©phone</label>
    <input type="tel" id="userPhone" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent">
    </div>
    </div>
    </div>

    <!-- Profil et permissions -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-primary">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
    <i class="fas fa-shield-alt text-primary mr-2"></i>
    Profil et Permissions
    </h3>
    <div class="space-y-4">
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Profil utilisateur *</label>
    <select id="userProfile" required onchange="updateUserProfileInfo()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent">
    <option value="">-- S√©lectionner un profil --</option>
    ${Array.isArray(availableProfiles) ? availableProfiles.map(profile => {
        const profileNames = {
            'admin': 'Administrateur',
            'collaborateur_senior': 'Collaborateur Senior',
            'collaborateur': 'Collaborateur',
            'user': 'Utilisateur',
            'caissier': 'Caissier'
        };
        return `<option value="${profile}">${profileNames[profile] || profile}</option>`;
    }).join('') : ''}
    </select>
    <div id="profileDescription" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></div>
    </div>

    <div id="assignedCompaniesSection" class="hidden">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Entreprises assign√©es</label>
    <div id="companiesCheckboxes" class="max-h-40 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-3 space-y-2 bg-white dark:bg-gray-700">
    ${window.app.companies.map(company =>
        `<div class="flex items-center">
        <input type="checkbox" id="company_${company.id}" value="${company.id}" class="text-primary focus:ring-primary border-gray-300 rounded">
        <label for="company_${company.id}" class="ml-2 text-sm text-gray-700 dark:text-gray-300">${company.name}</label>
        </div>`
    ).join('')}
    </div>
    </div>

    <div id="singleCompanySection" class="hidden">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Entreprise *</label>
    <select id="userCompany" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent">
    <option value="">-- S√©lectionner une entreprise --</option>
    ${window.app.companies.map(company =>
        `<option value="${company.id}">${company.name}</option>`
    ).join('')}
    </select>
    </div>
    </div>
    </div>

    <!-- S√©curit√© -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-primary">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
    <i class="fas fa-lock text-primary mr-2"></i>
    S√©curit√©
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mot de passe temporaire *</label>
    <input type="password" id="userPassword" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary focus:border-transparent">
    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">L'utilisateur devra changer ce mot de passe √† sa premi√®re connexion</div>
    </div>
    <div class="flex flex-col justify-center space-y-3">
    <label class="flex items-center">
    <input type="checkbox" id="userActive" checked class="text-primary focus:ring-primary border-gray-300 rounded">
    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Compte actif</span>
    </label>
    <label class="flex items-center">
    <input type="checkbox" id="forcePasswordChange" checked class="text-primary focus:ring-primary border-gray-300 rounded">
    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Forcer le changement de mot de passe</span>
    </label>
    </div>
    </div>
    </div>

    <!-- Boutons d'action -->
    <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
    <button type="button" onclick="closeUserModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
    Annuler
    </button>
    <button type="submit" class="px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors flex items-center">
    <i class="fas fa-save mr-2"></i>
    Cr√©er l'utilisateur
    </button>
    </div>
    </form>
    </div>
    </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHtml;

    // Gestionnaire de soumission du formulaire
    document.getElementById('newUserForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const userData = {
            id: `user_${Date.now()}`,
            firstName: document.getElementById('userFirstName').value,
            lastName: document.getElementById('userLastName').value,
            email: document.getElementById('userEmail').value,
            phone: document.getElementById('userPhone').value,
            profile: document.getElementById('userProfile').value,
            active: document.getElementById('userActive').checked,
            forcePasswordChange: document.getElementById('forcePasswordChange').checked,
            createdBy: window.app.currentUser.id,
            createdAt: new Date().toISOString()
        };

        const profile = userData.profile;
        if (profile === 'collaborateur_senior' || profile === 'collaborateur') {
            const checkboxes = document.querySelectorAll('#companiesCheckboxes input[type="checkbox"]:checked');
            userData.assignedCompanies = Array.from(checkboxes).map(cb => cb.value);
        } else if (profile === 'user' || profile === 'caissier') {
            userData.companyId = document.getElementById('userCompany').value;
        }

        window.app.users.push(userData);

        window.unifiedManager.notificationManager.show('success', 'Utilisateur cr√©√©',
            `L'utilisateur ${userData.firstName} ${userData.lastName} a √©t√© cr√©√© avec succ√®s`);
        closeUserModal();
    });

    // Affichage de la modal
    const modal = document.getElementById('newUserModal');
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.add('show');
        modal.querySelector('.modal').classList.add('show');
    }, 10);
}

/**
 * FONCTION MODALE: Cr√©ation d'une nouvelle entreprise
 * Extraction du code 2 - Pr√™te √† copier-coller
 */
function showNewCompanyModal() {
    if (!window.app.currentUser) {
        window.unifiedManager.notificationManager.show('warning', 'Authentification requise', 'Veuillez vous connecter pour cr√©er une entreprise');
        return;
    }

    const security = new SecurityManager();
    const currentProfile = security.getCurrentUser();

    if (!currentProfile || !security.permissions[currentProfile.profile].canManageCompanies) {
        window.unifiedManager.notificationManager.show('error', 'Permissions insuffisantes', 'Vous n\'avez pas les permissions pour cr√©er des entreprises');
        return;
    }

    const modalHtml = `
    <div id="newCompanyModal" class="modal-backdrop">
    <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-2xl" style="width: 900px;">
    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
    <i class="fas fa-building text-success mr-3"></i>
    Nouvelle Entreprise
    </h2>
    <button onclick="closeCompanyModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
    <i class="fas fa-times text-xl"></i>
    </button>
    </div>

    <form id="newCompanyForm" class="p-6 space-y-6">
    <!-- Informations g√©n√©rales -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-success">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
    <i class="fas fa-info-circle text-success mr-2"></i>
    Informations G√©n√©rales
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="md:col-span-2">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Raison sociale *</label>
    <input type="text" id="companyName" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Forme juridique *</label>
    <select id="companyType" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    <option value="">-- S√©lectionner --</option>
    <option value="SARL">SARL</option>
    <option value="SA">SA</option>
    <option value="SAS">SAS</option>
    <option value="SUARL">SUARL</option>
    <option value="GIE">GIE</option>
    <option value="SNC">SNC</option>
    <option value="SCS">SCS</option>
    </select>
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Secteur d'activit√© *</label>
    <select id="companySector" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    <option value="">-- S√©lectionner --</option>
    <option value="commerce">Commerce</option>
    <option value="industrie">Industrie</option>
    <option value="services">Services</option>
    <option value="agriculture">Agriculture</option>
    <option value="batiment">B√¢timent et Travaux Publics</option>
    <option value="transport">Transport et Logistique</option>
    <option value="finance">Finance et Assurance</option>
    <option value="hotellerie">H√¥tellerie et Restauration</option>
    </select>
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">N¬∞ RCCM</label>
    <input type="text" id="companyRCCM" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">N¬∞ CC (Compte Contribuable)</label>
    <input type="text" id="companyCC" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    </div>
    </div>
    </div>

    <!-- Adresse et contact -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-success">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
    <i class="fas fa-map-marker-alt text-success mr-2"></i>
    Adresse et Contact
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="md:col-span-2">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Adresse compl√®te *</label>
    <textarea id="companyAddress" required rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent"></textarea>
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ville *</label>
    <input type="text" id="companyCity" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pays *</label>
    <select id="companyCountry" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    <option value="">-- S√©lectionner --</option>
    <option value="CI">C√¥te d'Ivoire</option>
    <option value="SN">S√©n√©gal</option>
    <option value="BF">Burkina Faso</option>
    <option value="ML">Mali</option>
    <option value="NE">Niger</option>
    <option value="TG">Togo</option>
    <option value="BJ">B√©nin</option>
    <option value="GW">Guin√©e-Bissau</option>
    </select>
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">T√©l√©phone *</label>
    <input type="tel" id="companyPhone" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
    <input type="email" id="companyEmail" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    </div>
    </div>
    </div>

    <!-- Configuration comptable -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-success">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
    <i class="fas fa-calculator text-success mr-2"></i>
    Configuration Comptable SYSCOHADA
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Exercice comptable</label>
    <div class="flex space-x-2">
    <input type="date" id="exerciceStart" value="${new Date().getFullYear()}-01-01" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    <span class="flex items-center text-gray-500 dark:text-gray-400">au</span>
    <input type="date" id="exerciceEnd" value="${new Date().getFullYear()}-12-31" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    </div>
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Devise *</label>
    <select id="companyCurrency" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-success focus:border-transparent">
    <option value="XOF">Franc CFA (XOF)</option>
    <option value="XAF">Franc CFA Central (XAF)</option>
    <option value="EUR">Euro (EUR)</option>
    <option value="USD">Dollar US (USD)</option>
    </select>
    </div>
    <div class="md:col-span-2">
    <label class="flex items-center">
    <input type="checkbox" id="initAccountPlan" checked class="text-success focus:ring-success border-gray-300 rounded">
    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Initialiser avec le plan comptable SYSCOHADA standard</span>
    </label>
    <div class="mt-3 p-3 bg-white dark:bg-gray-600 rounded-lg text-sm">
    <div class="font-medium text-gray-700 dark:text-gray-300 mb-2">Plan comptable SYSCOHADA :</div>
    <div class="grid grid-cols-2 gap-2 text-xs">
    <div class="pl-3 border-l-3 border-red-400">Classe 1 - Comptes de ressources durables</div>
    <div class="pl-3 border-l-3 border-orange-400">Classe 2 - Comptes d'actif immobilis√©</div>
    <div class="pl-3 border-l-3 border-yellow-400">Classe 3 - Comptes de stocks</div>
    <div class="pl-3 border-l-3 border-green-400">Classe 4 - Comptes de tiers</div>
    <div class="pl-3 border-l-3 border-blue-400">Classe 5 - Comptes de tr√©sorerie</div>
    <div class="pl-3 border-l-3 border-purple-400">Classe 6 - Comptes de charges</div>
    <div class="pl-3 border-l-3 border-pink-400">Classe 7 - Comptes de produits</div>
    <div class="pl-3 border-l-3 border-gray-400">Classe 8 - Comptes sp√©ciaux</div>
    </div>
    </div>
    </div>
    </div>
    </div>

    <!-- Boutons d'action -->
    <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
    <button type="button" onclick="closeCompanyModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
    Annuler
    </button>
    <button type="submit" class="px-6 py-2 bg-success hover:bg-success/90 text-white rounded-lg transition-colors flex items-center">
    <i class="fas fa-save mr-2"></i>
    Cr√©er l'entreprise
    </button>
    </div>
    </form>
    </div>
    </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHtml;

    // Gestionnaire de soumission du formulaire
    document.getElementById('newCompanyForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const companyData = {
            id: `comp_${Date.now()}`,
            name: document.getElementById('companyName').value,
            type: document.getElementById('companyType').value,
            sector: document.getElementById('companySector').value,
            rccm: document.getElementById('companyRCCM').value,
            cc: document.getElementById('companyCC').value,
            address: document.getElementById('companyAddress').value,
            city: document.getElementById('companyCity').value,
            country: document.getElementById('companyCountry').value,
            phone: document.getElementById('companyPhone').value,
            email: document.getElementById('companyEmail').value,
            currency: document.getElementById('companyCurrency').value,
            exerciceStart: document.getElementById('exerciceStart').value,
            exerciceEnd: document.getElementById('exerciceEnd').value,
            initAccountPlan: document.getElementById('initAccountPlan').checked,
            active: true,
            createdBy: window.app.currentUser.id,
            createdAt: new Date().toISOString()
        };

        window.app.companies.push(companyData);

        window.unifiedManager.notificationManager.show('success', 'Entreprise cr√©√©e',
            `L'entreprise ${companyData.name} a √©t√© cr√©√©e avec succ√®s`);
        closeCompanyModal();
    });

    // Affichage de la modal
    const modal = document.getElementById('newCompanyModal');
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.add('show');
        modal.querySelector('.modal').classList.add('show');
    }, 10);
}

/**
 * FONCTION MODALE: Nouvelle √©criture comptable
 * Extraction du code 2 - Pr√™te √† copier-coller
 */
function showNewEntryModal() {
    if (!window.app.currentUser) {
        window.unifiedManager.notificationManager.show('warning', 'Authentification requise', 'Veuillez vous connecter pour cr√©er une √©criture');
        return;
    }

    if (!window.app.currentCompanyId) {
        window.unifiedManager.notificationManager.show('warning', 'Entreprise requise', 'Veuillez s√©lectionner une entreprise pour cr√©er une √©criture');
        return;
    }

    const security = new SecurityManager();
    const hasAccess = security.hasAccessToCompany(window.app.currentUser.id, window.app.currentCompanyId);

    if (!hasAccess) {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Vous n\'avez pas acc√®s √† cette entreprise');
        return;
    }

    const modalHtml = `
    <div id="newEntryModal" class="modal-backdrop">
    <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-2xl" style="width: 1000px;">
    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
    <i class="fas fa-edit text-info mr-3"></i>
    Nouvelle √âcriture Comptable
    </h2>
    <button onclick="closeEntryModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
    <i class="fas fa-times text-xl"></i>
    </button>
    </div>

    <form id="newEntryForm" class="p-6 space-y-6">
    <!-- En-t√™te de l'√©criture -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-info">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
    <i class="fas fa-file-alt text-info mr-2"></i>
    En-t√™te de l'√âcriture
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date d'√©criture *</label>
    <input type="date" id="entryDate" required value="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-info focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">N¬∞ de pi√®ce</label>
    <input type="text" id="entryReference" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-info focus:border-transparent">
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Journal *</label>
    <select id="entryJournal" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-info focus:border-transparent">
    <option value="">-- S√©lectionner un journal --</option>
    <option value="AC">AC - Achats</option>
    <option value="VT">VT - Ventes</option>
    <option value="BQ">BQ - Banque</option>
    <option value="CA">CA - Caisse</option>
    <option value="OD">OD - Op√©rations Diverses</option>
    <option value="AN">AN - √Ä Nouveaux</option>
    <option value="EX">EX - Extourne</option>
    </select>
    </div>
    <div class="md:col-span-3">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Libell√© de l'√©criture *</label>
    <input type="text" id="entryLabel" required placeholder="Ex: Facture client n¬∞..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-info focus:border-transparent">
    </div>
    </div>
    </div>

    <!-- Lignes d'√©criture -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-info">
    <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center">
    <i class="fas fa-list text-info mr-2"></i>
    Lignes d'√âcriture
    </h3>
    <button type="button" onclick="addEntryLine()" class="px-3 py-1 bg-info text-white text-sm rounded-lg hover:bg-info/90 transition-colors">
    <i class="fas fa-plus mr-1"></i>Ajouter une ligne
    </button>
    </div>

    <div class="overflow-x-auto">
    <table class="w-full border border-gray-300 dark:border-gray-600 rounded-lg">
    <thead class="bg-gray-100 dark:bg-gray-600">
    <tr>
    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Compte</th>
    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Libell√©</th>
    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">D√©bit</th>
    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Cr√©dit</th>
    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
    </tr>
    </thead>
    <tbody id="entryLinesTable" class="bg-white dark:bg-gray-700">
    <!-- Les lignes seront ajout√©es dynamiquement -->
    </tbody>
    <tfoot class="bg-gray-100 dark:bg-gray-600 font-medium">
    <tr>
    <td colspan="2" class="px-3 py-2 text-right text-gray-700 dark:text-gray-300">Totaux :</td>
    <td class="px-3 py-2 text-right text-gray-700 dark:text-gray-300" id="totalDebit">0.00</td>
    <td class="px-3 py-2 text-right text-gray-700 dark:text-gray-300" id="totalCredit">0.00</td>
    <td class="px-3 py-2 text-center">
    <span id="balanceStatus" class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600 dark:bg-gray-500 dark:text-gray-300">Non √©quilibr√©e</span>
    </td>
    </tr>
    </tfoot>
    </table>
    </div>
    </div>

    <!-- Informations compl√©mentaires -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-info">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
    <i class="fas fa-info-circle text-info mr-2"></i>
    Informations Compl√©mentaires
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mode de paiement</label>
    <select id="paymentMethod" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-info focus:border-transparent">
    <option value="">-- S√©lectionner --</option>
    <option value="especes">Esp√®ces</option>
    <option value="cheque">Ch√®que</option>
    <option value="virement">Virement</option>
    <option value="carte">Carte bancaire</option>
    <option value="mobile">Paiement mobile</option>
    <option value="autre">Autre</option>
    </select>
    </div>
    <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">√âch√©ance</label>
    <input type="date" id="dueDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-info focus:border-transparent">
    </div>
    <div class="md:col-span-2">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Observations</label>
    <textarea id="entryNotes" rows="3" placeholder="Informations compl√©mentaires..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-info focus:border-transparent"></textarea>
    </div>
    </div>
    </div>

    <!-- Boutons d'action -->
    <div class="flex justify-between items-center pt-6 border-t border-gray-200 dark:border-gray-700">
    <div class="flex items-center space-x-4">
    <label class="flex items-center">
    <input type="checkbox" id="saveAsDraft" class="text-info focus:ring-info border-gray-300 rounded">
    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Sauvegarder comme brouillon</span>
    </label>
    <div class="text-sm text-gray-500 dark:text-gray-400">
    <i class="fas fa-info-circle mr-1"></i>
    <span id="validationStatus">L'√©criture doit √™tre √©quilibr√©e pour √™tre valid√©e</span>
    </div>
    </div>
    <div class="flex space-x-3">
    <button type="button" onclick="closeEntryModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
    Annuler
    </button>
    <button type="submit" class="px-6 py-2 bg-info hover:bg-info/90 text-white rounded-lg transition-colors flex items-center">
    <i class="fas fa-save mr-2"></i>
    Enregistrer
    </button>
    </div>
    </div>
    </form>
    </div>
    </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHtml;

    // Ajouter deux lignes par d√©faut
    window.entryLineCounter = 0;
    addEntryLine();
    addEntryLine();

    // Gestionnaire de soumission du formulaire
    document.getElementById('newEntryForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const totalDebit = parseFloat(document.getElementById('totalDebit').textContent);
        const totalCredit = parseFloat(document.getElementById('totalCredit').textContent);

        if (totalDebit !== totalCredit) {
            window.unifiedManager.notificationManager.show('error', '√âcriture non √©quilibr√©e',
                'Les totaux d√©bit et cr√©dit doivent √™tre √©gaux');
            return;
        }

        const lines = getEntryLines();
        if (lines.length < 2) {
            window.unifiedManager.notificationManager.show('error', '√âcriture incompl√®te',
                'Une √©criture doit contenir au moins 2 lignes');
            return;
        }

        const entryData = {
            id: `entry_${Date.now()}`,
            companyId: window.app.currentCompanyId,
            date: document.getElementById('entryDate').value,
            journal: document.getElementById('entryJournal').value,
            reference: document.getElementById('entryReference').value,
            label: document.getElementById('entryLabel').value,
            lines: lines,
            paymentMethod: document.getElementById('paymentMethod').value,
            dueDate: document.getElementById('dueDate').value,
            notes: document.getElementById('entryNotes').value,
            isDraft: document.getElementById('saveAsDraft').checked,
            totalDebit: totalDebit,
            totalCredit: totalCredit,
            createdBy: window.app.currentUser.id,
            createdAt: new Date().toISOString()
        };

        window.app.entries.push(entryData);

        const isDraft = entryData.isDraft;
        window.unifiedManager.notificationManager.show('success',
            isDraft ? 'Brouillon sauvegard√©' : '√âcriture enregistr√©e',
            `L'√©criture "${entryData.label}" a √©t√© ${isDraft ? 'sauvegard√©e comme brouillon' : 'enregistr√©e avec succ√®s'}`);
        closeEntryModal();
    });

    // Affichage de la modal
    const modal = document.getElementById('newEntryModal');
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.add('show');
        modal.querySelector('.modal').classList.add('show');
    }, 10);
}
        
// FONCTION 4: showNewAccountModal() - EXTRACTION COMPL√àTE

function showNewAccountModal() {
    if (window.app.currentProfile === 'caissier') {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Les caissiers ne peuvent pas cr√©er de comptes');
        return;
    }

    const modalContent = `
    <form id="newAccountForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Code compte*</label>
                <input type="text" id="accountCode" required maxlength="6" pattern="[0-9]{6}"
                    placeholder="Ex: 512001"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
                <p class="text-xs text-gray-500 mt-1">6 chiffres selon SYSCOHADA</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Classe SYSCOHADA*</label>
                <select id="accountClass" required onchange="updateClassInfo()"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
                    <option value="">S√©lectionner</option>
                    <option value="1">Classe 1 - Ressources durables</option>
                    <option value="2">Classe 2 - Actif immobilis√©</option>
                    <option value="3">Classe 3 - Stocks</option>
                    <option value="4">Classe 4 - Tiers</option>
                    <option value="5">Classe 5 - Tr√©sorerie</option>
                    <option value="6">Classe 6 - Charges</option>
                    <option value="7">Classe 7 - Produits</option>
                    <option value="8">Classe 8 - R√©sultats</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom du compte*</label>
            <input type="text" id="accountName" required
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cat√©gorie*</label>
            <input type="text" id="accountCategory" required
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type*</label>
                <select id="accountType" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
                    <option value="">S√©lectionner</option>
                    <option value="Actif">Actif</option>
                    <option value="Passif">Passif</option>
                    <option value="Charge">Charge</option>
                    <option value="Produit">Produit</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nature*</label>
                <select id="accountNature" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
                    <option value="">S√©lectionner</option>
                    <option value="Debit">D√©biteur</option>
                    <option value="Credit">Cr√©diteur</option>
                </select>
            </div>
        </div>

        <div class="flex items-center">
            <input type="checkbox" id="accountActive" checked class="rounded border-gray-300 dark:border-gray-600">
            <label for="accountActive" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                Compte actif
            </label>
        </div>

        <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400">
                Annuler
            </button>
            <button type="submit"
                class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90">
                <i class="fas fa-save mr-2"></i>Cr√©er le compte
            </button>
        </div>
    </form>
    `;

    window.unifiedManager.modalManager.show('Nouveau Compte SYSCOHADA', modalContent);

    // Gestionnaire de soumission
    setTimeout(() => {
        document.getElementById('newAccountForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const code = document.getElementById('accountCode').value;
            const name = document.getElementById('accountName').value;
            const category = document.getElementById('accountCategory').value;
            const type = document.getElementById('accountType').value;
            const nature = document.getElementById('accountNature').value;
            const isActive = document.getElementById('accountActive').checked;

            // Validation du code
            if (window.app.accounts.find(a => a.code === code)) {
                window.unifiedManager.notificationManager.show('error', 'Code existant', 'Ce code de compte existe d√©j√†');
                return;
            }

            const newAccount = {
                code: code,
                name: name,
                category: category,
                type: type,
                nature: nature,
                isActive: isActive,
                createdAt: new Date().toISOString(),
                createdBy: window.app.currentUser.id
            };

            window.app.accounts.push(newAccount);
            window.unifiedManager.modalManager.hide();
            window.unifiedManager.notificationManager.show('success', 'Compte cr√©√©', `Le compte ${code} - ${name} a √©t√© cr√©√©`);

            // Recharger la page des comptes si visible
            if (document.getElementById('mainContent').innerHTML.includes('Plan Comptable')) {
                window.unifiedManager.loadAccountsPage();
            }
        });
    }, 100);
}       

// FONCTION 5: showNewCashRegisterModal() - EXTRACTION COMPL√àTE

function showNewCashRegisterModal() {
    if (!window.app.currentCompanyId) {
        window.unifiedManager.notificationManager.show('warning', 'Entreprise requise', 'S√©lectionnez une entreprise pour cr√©er une caisse');
        return;
    }

    const users = window.unifiedManager.data.getCompanyUsers(window.app.currentCompanyId);
    const availableUsers = users.filter(u => u.profile === 'caissier' || u.profile === 'user');

    const modalContent = `
    <form id="newCashRegisterForm" class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom de la caisse*</label>
            <input type="text" id="cashName" required
                placeholder="Ex: Caisse Principale, Caisse Ventes..."
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Responsable</label>
            <select id="cashResponsible"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
                <option value="">Aucun responsable assign√©</option>
                ${availableUsers.map(user => `
                <option value="${user.id}">${user.name} (${user.role})</option>
                `).join('')}
            </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Solde d'ouverture (FCFA)</label>
                <input type="number" id="openingBalance" min="0" step="0.01" value="0"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Limite maximum (FCFA)</label>
                <input type="number" id="maxLimit" min="0" step="0.01" value="1000000"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type de caisse</label>
            <select id="cashType"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
                <option value="Principale">Caisse Principale</option>
                <option value="Secondaire">Caisse Secondaire</option>
                <option value="Petite monnaie">Petite Monnaie</option>
                <option value="Recettes">Caisse Recettes</option>
                <option value="D√©penses">Caisse D√©penses</option>
            </select>
        </div>

        <div class="flex items-center">
            <input type="checkbox" id="cashActive" checked class="rounded border-gray-300 dark:border-gray-600">
            <label for="cashActive" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                Ouvrir imm√©diatement cette caisse
            </label>
        </div>

        <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400">
                Annuler
            </button>
            <button type="submit"
                class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90">
                <i class="fas fa-save mr-2"></i>Cr√©er la caisse
            </button>
        </div>
    </form>
    `;

    window.unifiedManager.modalManager.show('Nouvelle Caisse', modalContent);

    setTimeout(() => {
        document.getElementById('newCashRegisterForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const name = document.getElementById('cashName').value;
            const responsibleId = document.getElementById('cashResponsible').value;
            const openingBalance = parseFloat(document.getElementById('openingBalance').value) || 0;
            const maxLimit = parseFloat(document.getElementById('maxLimit').value) || 1000000;
            const type = document.getElementById('cashType').value;
            const isActive = document.getElementById('cashActive').checked;

            const responsible = responsibleId ? users.find(u => u.id == responsibleId) : null;

            const newCashRegister = {
                id: Date.now(),
                name: name,
                companyId: window.app.currentCompanyId,
                responsibleId: responsibleId || null,
                responsibleName: responsible ? responsible.name : 'Non assign√©',
                balance: openingBalance,
                openingBalance: openingBalance,
                dailyReceipts: 0,
                dailyExpenses: 0,
                status: isActive ? 'Ouvert' : 'Ferm√©',
                type: type,
                maxLimit: maxLimit,
                currency: 'FCFA',
                lastOperation: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                createdBy: window.app.currentUser.id
            };

            window.app.cashRegisters.push(newCashRegister);
            window.unifiedManager.modalManager.hide();
            window.unifiedManager.notificationManager.show('success', 'Caisse cr√©√©e', `La caisse "${name}" a √©t√© cr√©√©e avec succ√®s`);

            if (document.getElementById('mainContent').innerHTML.includes('Gestion des Caisses')) {
                window.unifiedManager.loadCaissePage();
            }
        });
    }, 100);
}

// FONCTION GESTION UTILISATEURS 1: editUser(id) - EXTRACTION COMPL√àTE

function editUser(id) {
    const user = window.app.users.find(u => u.id === id);
    if (!user) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Utilisateur introuvable');
        return;
    }

    if (!window.unifiedManager.canManageUser(user)) {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Vous ne pouvez pas modifier cet utilisateur');
        return;
    }

    const availableRoles = window.unifiedManager.getAvailableRoles();
    const accessibleCompanies = window.unifiedManager.getAccessibleCompanies();

    // Fonction d'√©chappement pour s√©curiser l'injection HTML
    const escapeHTML = (str) => str.replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        "'": '&#39;',
        '"': '&quot;'
    }[tag]));

    const modalContent = `
    <form id="editUserForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nom complet*</label>
                <input type="text" id="editUserName" value="${escapeHTML(user.name)}" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email*</label>
                <input type="email" id="editUserEmail" value="${escapeHTML(user.email)}" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">T√©l√©phone</label>
                <input type="tel" id="editUserPhone" value="${escapeHTML(user.phone || '')}"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Statut</label>
                <select id="editUserStatus"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
                    ${['Actif', 'Inactif', 'Suspendu'].map(status =>
                        `<option value="${status}" ${user.status === status ? 'selected' : ''}>${status}</option>`
                    ).join('')}
                </select>
            </div>
        </div>

        ${window.app.currentUser.profile === 'admin' ? `
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">R√¥le</label>
            <select id="editUserRole"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white text-base">
                <option value="${escapeHTML(user.profile)}">${escapeHTML(user.role)}</option>
                ${availableRoles.map(role =>
                    role.profile !== user.profile ? `<option value="${role.profile}">${escapeHTML(role.name)}</option>` : ''
                ).join('')}
            </select>
        </div>` : `
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">R√¥le actuel</label>
            <input type="text" value="${escapeHTML(user.role)}" readonly
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white text-base">
        </div>`}

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Entreprises assign√©es</label>
            <div class="space-y-2 max-h-32 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-3">
                ${accessibleCompanies.map(company => `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="companies" value="${company.id}"
                        ${user.companies && user.companies.includes(company.id) ? 'checked' : ''}
                        class="rounded border-gray-300 text-primary focus:ring-primary">
                    <span class="text-sm text-gray-700 dark:text-gray-300">${escapeHTML(company.name)}</span>
                </label>
                `).join('')}
            </div>
        </div>

        <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Annuler
            </button>
            <button type="submit"
                class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                Sauvegarder
            </button>
        </div>
    </form>
    `;

    window.unifiedManager.modalManager.show(`Modifier ${escapeHTML(user.name)}`, modalContent);

    document.getElementById('editUserForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const name = document.getElementById('editUserName').value.trim();
        const email = document.getElementById('editUserEmail').value.trim();
        const phone = document.getElementById('editUserPhone').value.trim();
        const status = document.getElementById('editUserStatus').value;
        const roleElement = document.getElementById('editUserRole');
        const newRole = roleElement ? roleElement.value : user.profile;
        const selectedCompanies = Array.from(document.querySelectorAll('input[name="companies"]:checked'))
            .map(input => parseInt(input.value));

        if (!name || !email) {
            window.unifiedManager.notificationManager.show('error', 'Erreur', 'Le nom et l\'email sont obligatoires');
            return;
        }

        const existingUser = window.app.users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.id !== id);
        if (existingUser) {
            window.unifiedManager.notificationManager.show('error', 'Erreur', 'Cet email est d√©j√† utilis√©');
            return;
        }

        user.name = name;
        user.email = email;
        user.phone = phone;
        user.status = status;
        user.companies = selectedCompanies;
        user.assignedCompanies = selectedCompanies;

        if (newRole !== user.profile && window.app.currentUser.profile === 'admin') {
            const roleInfo = availableRoles.find(r => r.profile === newRole) ||
                { name: user.role, profile: user.profile };
            user.profile = roleInfo.profile;
            user.role = roleInfo.name;
            user.permissions = window.unifiedManager.getDefaultPermissions(roleInfo.profile);
        }

        window.unifiedManager.modalManager.hide();
        window.unifiedManager.notificationManager.show('success', 'Utilisateur modifi√©', `${escapeHTML(name)} a √©t√© mis √† jour avec succ√®s`);

        if (document.getElementById('mainContent').innerHTML.includes('Gestion d\'√âquipe')) {
            window.unifiedManager.showTeamManagement();
        }
    });
}

// FONCTION GESTION UTILISATEURS 2: manageUserAccess(id) - EXTRACTION COMPL√àTE

function manageUserAccess(id) {
    const user = window.app.users.find(u => u.id === id);
    if (!user) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Utilisateur introuvable');
        return;
    }

    if (!window.unifiedManager.canManageUser(user)) {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Vous ne pouvez pas g√©rer les acc√®s de cet utilisateur');
        return;
    }

    const escapeHTML = (str) => str ? str.toString().replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
    }[tag])) : '';

    const modalContent = `
    <div class="space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-primary text-white rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-key text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Gestion des Acc√®s</h3>
            <p class="text-gray-600 dark:text-gray-400">${escapeHTML(user.name)} ‚Ä¢ ${escapeHTML(user.role)}</p>
            <span class="inline-block px-3 py-1 mt-2 text-xs rounded-full ${user.status === 'Actif' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
                ${escapeHTML(user.status)}
            </span>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="font-medium text-gray-900 dark:text-white mb-3">Niveau de S√©curit√©</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="text-gray-600 dark:text-gray-400">Niveau hi√©rarchique:</span>
                    <span class="font-bold text-primary ml-2">Niveau ${window.unifiedManager.security.profileHierarchy[user.profile]}</span>
                </div>
                <div>
                    <span class="text-gray-600 dark:text-gray-400">Profil:</span>
                    <span class="font-medium ml-2">${escapeHTML(user.role)}</span>
                </div>
                <div>
                    <span class="text-gray-600 dark:text-gray-400">Derni√®re connexion:</span>
                    <span class="font-medium ml-2">${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('fr-FR') : 'Jamais'}</span>
                </div>
                <div>
                    <span class="text-gray-600 dark:text-gray-400">Membre depuis:</span>
                    <span class="font-medium ml-2">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('fr-FR') : 'N/A'}</span>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="font-medium text-gray-900 dark:text-white mb-3">Permissions Actuelles</h4>
            <div class="space-y-2">
                ${user.permissions.map(permission => `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check text-success"></i>
                    <span class="text-sm text-gray-700 dark:text-gray-300">${escapeHTML(window.unifiedManager.getPermissionLabel(permission))}</span>
                </div>
                `).join('')}
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="font-medium text-gray-900 dark:text-white mb-3">Entreprises Accessibles (${user.companies ? user.companies.length : 0})</h4>
            <div class="space-y-2 max-h-32 overflow-y-auto">
                ${user.companies && user.companies.length > 0 ? user.companies.map(companyId => {
                    const company = window.app.companies.find(c => c.id === companyId);
                    return company ? `
                    <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-600 rounded">
                        <span class="text-sm text-gray-700 dark:text-gray-300">${escapeHTML(company.name)}</span>
                        <span class="px-2 py-1 text-xs rounded-full ${window.unifiedManager.getStatusColor(company.status)}">${escapeHTML(company.status)}</span>
                    </div>
                    ` : '';
                }).join('') : '<p class="text-sm text-gray-500">Aucune entreprise assign√©e</p>'}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="resetUserPassword(${user.id})"
                class="bg-warning text-white px-4 py-2 rounded-lg hover:bg-warning/90 transition-colors">
                <i class="fas fa-unlock mr-2"></i>R√©initialiser mot de passe
            </button>
            <button onclick="toggleUserStatus(${user.id})"
                class="bg-info text-white px-4 py-2 rounded-lg hover:bg-info/90 transition-colors">
                <i class="fas fa-toggle-on mr-2"></i>Changer statut
            </button>
            <button onclick="generateUserReport(${user.id})"
                class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/90 transition-colors">
                <i class="fas fa-chart-bar mr-2"></i>Rapport d'activit√©
            </button>
            <button onclick="sendNotificationToUser(${user.id})"
                class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                <i class="fas fa-envelope mr-2"></i>Envoyer notification
            </button>
        </div>

        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-600">
            <button onclick="editUser(${user.id}); window.unifiedManager.modalManager.hide()"
                class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                <i class="fas fa-edit mr-2"></i>Modifier utilisateur
            </button>
            <button onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Fermer
            </button>
        </div>
    </div>
    `;

    window.unifiedManager.modalManager.show(`Acc√®s - ${escapeHTML(user.name)}`, modalContent);
}

// FONCTION GESTION UTILISATEURS 3: viewUserDetails(id) - EXTRACTION COMPL√àTE

function viewUserDetails(id) {
    const user = window.app.users.find(u => u.id === id);
    if (!user) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Utilisateur introuvable');
        return;
    }

    if (!window.unifiedManager.canViewUserDetails(user)) {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Vous ne pouvez pas consulter les d√©tails de cet utilisateur');
        return;
    }

    const escapeHTML = (str) => str ? str.toString().replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
    }[tag])) : '';

    const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('fr-FR', {
        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
    }) : 'Non d√©fini';

    const getActivityStatus = (lastLogin) => {
        if (!lastLogin) return { class: 'bg-gray-500', text: 'Jamais connect√©' };
        const daysSince = Math.floor((Date.now() - new Date(lastLogin)) / (1000 * 60 * 60 * 24));
        if (daysSince === 0) return { class: 'bg-success', text: 'Actif aujourd\'hui' };
        if (daysSince <= 7) return { class: 'bg-warning', text: `Actif il y a ${daysSince} jour(s)` };
        if (daysSince <= 30) return { class: 'bg-orange-500', text: `Actif il y a ${daysSince} jour(s)` };
        return { class: 'bg-danger', text: `Inactif depuis ${daysSince} jours` };
    };

    const activityStatus = getActivityStatus(user.lastLogin);

    const modalContent = `
    <div class="space-y-6">
        <div class="text-center">
            <div class="relative inline-block">
                <div class="w-20 h-20 bg-gradient-to-br from-primary to-primary/70 text-white rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user text-3xl"></i>
                </div>
                <div class="absolute -bottom-1 -right-1 w-6 h-6 ${activityStatus.class} rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center">
                    <i class="fas fa-circle text-xs text-white"></i>
                </div>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">${escapeHTML(user.name)}</h3>
            <p class="text-primary font-medium">${escapeHTML(user.role)}</p>
            <span class="inline-block px-3 py-1 mt-2 text-sm rounded-full ${user.status === 'Actif' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
                ${escapeHTML(user.status)}
            </span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Informations Personnelles -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <i class="fas fa-user-circle mr-2 text-primary"></i>
                    Informations Personnelles
                </h4>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Email:</span>
                        <span class="font-medium text-right">${escapeHTML(user.email)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">T√©l√©phone:</span>
                        <span class="font-medium text-right">${escapeHTML(user.phone || 'Non renseign√©')}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">D√©partement:</span>
                        <span class="font-medium text-right">${escapeHTML(user.department || 'Non assign√©')}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Manager:</span>
                        <span class="font-medium text-right">${escapeHTML(user.manager || 'Aucun')}</span>
                    </div>
                </div>
            </div>

            <!-- Activit√© & S√©curit√© -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <i class="fas fa-shield-alt mr-2 text-primary"></i>
                    Activit√© & S√©curit√©
                </h4>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 dark:text-gray-400">Statut d'activit√©:</span>
                        <span class="px-2 py-1 text-xs rounded-full ${activityStatus.class} text-white">
                            ${activityStatus.text}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Derni√®re connexion:</span>
                        <span class="font-medium text-right">${formatDate(user.lastLogin)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Membre depuis:</span>
                        <span class="font-medium text-right">${formatDate(user.createdAt)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Niveau hi√©rarchique:</span>
                        <span class="font-bold text-primary">Niveau ${window.unifiedManager.security.profileHierarchy[user.profile]}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Permissions D√©taill√©es -->
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-key mr-2 text-primary"></i>
                Permissions D√©taill√©es (${user.permissions.length})
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                ${user.permissions.map(permission => `
                <div class="flex items-center space-x-2 p-2 bg-white dark:bg-gray-600 rounded">
                    <i class="fas fa-check-circle text-success text-sm"></i>
                    <span class="text-sm text-gray-700 dark:text-gray-300">${escapeHTML(window.unifiedManager.getPermissionLabel(permission))}</span>
                </div>
                `).join('')}
            </div>
        </div>

        <!-- Entreprises et Acc√®s -->
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-building mr-2 text-primary"></i>
                Entreprises Accessibles (${user.companies ? user.companies.length : 0})
            </h4>
            <div class="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto">
                ${user.companies && user.companies.length > 0 ? user.companies.map(companyId => {
                    const company = window.app.companies.find(c => c.id === companyId);
                    return company ? `
                    <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-600 rounded-lg border border-gray-200 dark:border-gray-500">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-primary/20 text-primary rounded-full flex items-center justify-center">
                                <i class="fas fa-building text-sm"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white text-sm">${escapeHTML(company.name)}</p>
                                <p class="text-xs text-gray-500">${escapeHTML(company.sector || 'Secteur non d√©fini')}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${window.unifiedManager.getStatusColor(company.status)}">${escapeHTML(company.status)}</span>
                    </div>
                    ` : '';
                }).join('') : '<p class="text-sm text-gray-500 text-center py-4">Aucune entreprise assign√©e</p>'}
            </div>
        </div>

        <!-- Statistiques d'utilisation -->
        <div class="bg-gradient-to-r from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 p-4 rounded-lg border border-primary/20">
            <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-primary"></i>
                Statistiques d'Utilisation
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                    <p class="text-2xl font-bold text-primary">${user.stats?.logins || 0}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Connexions</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-primary">${user.stats?.actions || 0}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Actions</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-primary">${user.stats?.documents || 0}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Documents</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-primary">${user.stats?.reports || 0}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Rapports</p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
            <div class="flex space-x-2">
                <button onclick="manageUserAccess(${user.id}); window.unifiedManager.modalManager.hide()"
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors text-sm">
                    <i class="fas fa-key mr-2"></i>G√©rer Acc√®s
                </button>
                <button onclick="editUser(${user.id}); window.unifiedManager.modalManager.hide()"
                    class="bg-warning text-white px-4 py-2 rounded-lg hover:bg-warning/90 transition-colors text-sm">
                    <i class="fas fa-edit mr-2"></i>Modifier
                </button>
            </div>
            <button onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Fermer
            </button>
        </div>
    </div>
    `;

    window.unifiedManager.modalManager.show(`D√©tails - ${escapeHTML(user.name)}`, modalContent, 'large');
}

// FONCTION GESTION UTILISATEURS 4: updateUserProfile() - EXTRACTION COMPL√àTE

function updateUserProfile() {
    const currentUser = window.unifiedManager.getCurrentUser();
    if (!currentUser) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Session utilisateur invalide');
        return;
    }

    const escapeHTML = (str) => str ? str.toString().replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
    }[tag])) : '';

    const modalContent = `
    <div class="space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-gradient-to-br from-primary to-primary/70 text-white rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user-edit text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Mon Profil</h3>
            <p class="text-gray-600 dark:text-gray-400">Modifier mes informations personnelles</p>
        </div>

        <form id="updateProfileForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-user mr-1"></i>Nom complet *
                    </label>
                    <input type="text" id="profileName" value="${escapeHTML(currentUser.name)}" required
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-envelope mr-1"></i>Email *
                    </label>
                    <input type="email" id="profileEmail" value="${escapeHTML(currentUser.email)}" required
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-phone mr-1"></i>T√©l√©phone
                    </label>
                    <input type="tel" id="profilePhone" value="${escapeHTML(currentUser.phone || '')}"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-building mr-1"></i>D√©partement
                    </label>
                    <select id="profileDepartment"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="">S√©lectionner un d√©partement</option>
                        <option value="Direction" ${currentUser.department === 'Direction' ? 'selected' : ''}>Direction</option>
                        <option value="Ressources Humaines" ${currentUser.department === 'Ressources Humaines' ? 'selected' : ''}>Ressources Humaines</option>
                        <option value="Comptabilit√©" ${currentUser.department === 'Comptabilit√©' ? 'selected' : ''}>Comptabilit√©</option>
                        <option value="Commercial" ${currentUser.department === 'Commercial' ? 'selected' : ''}>Commercial</option>
                        <option value="Technique" ${currentUser.department === 'Technique' ? 'selected' : ''}>Technique</option>
                        <option value="Support" ${currentUser.department === 'Support' ? 'selected' : ''}>Support</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>Bio / Description
                </label>
                <textarea id="profileBio" rows="3" placeholder="Quelques mots sur vous..."
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base resize-none">${escapeHTML(currentUser.bio || '')}</textarea>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                    <i class="fas fa-cog mr-2"></i>Pr√©f√©rences
                </h4>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-700 dark:text-gray-300">Notifications par email</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="emailNotifications" ${currentUser.preferences?.emailNotifications !== false ? 'checked' : ''}
                                class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 dark:peer-focus:ring-primary/50 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-700 dark:text-gray-300">Notifications push</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="pushNotifications" ${currentUser.preferences?.pushNotifications !== false ? 'checked' : ''}
                                class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 dark:peer-focus:ring-primary/50 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-700 dark:text-gray-300">Mode sombre automatique</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoDarkMode" ${currentUser.preferences?.autoDarkMode === true ? 'checked' : ''}
                                class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 dark:peer-focus:ring-primary/50 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 p-4 rounded-lg">
                <h4 class="font-medium text-yellow-800 dark:text-yellow-200 mb-2 flex items-center">
                    <i class="fas fa-lock mr-2"></i>Modifier le mot de passe
                </h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-yellow-700 dark:text-yellow-300 mb-1">Mot de passe actuel</label>
                        <input type="password" id="currentPassword" placeholder="Saisir le mot de passe actuel"
                            class="w-full px-3 py-2 border border-yellow-300 dark:border-yellow-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-yellow-700 dark:text-yellow-300 mb-1">Nouveau mot de passe</label>
                            <input type="password" id="newPassword" placeholder="Nouveau mot de passe"
                                class="w-full px-3 py-2 border border-yellow-300 dark:border-yellow-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-yellow-700 dark:text-yellow-300 mb-1">Confirmer nouveau mot de passe</label>
                            <input type="password" id="confirmPassword" placeholder="Confirmer le mot de passe"
                                class="w-full px-3 py-2 border border-yellow-300 dark:border-yellow-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        </div>
                    </div>
                    <p class="text-xs text-yellow-600 dark:text-yellow-400">
                        <i class="fas fa-info-circle mr-1"></i>
                        Laissez vide pour conserver le mot de passe actuel
                    </p>
                </div>
            </div>
        </form>

        <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
            <button type="button" onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Annuler
            </button>
            <div class="flex space-x-3">
                <button type="button" onclick="resetProfileForm()"
                    class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-undo mr-2"></i>R√©initialiser
                </button>
                <button type="button" onclick="saveUserProfile()"
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                    <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
    `;

    window.unifiedManager.modalManager.show('Mon Profil', modalContent, 'large');
}

// Fonction auxiliaire pour r√©initialiser le formulaire
function resetProfileForm() {
    const currentUser = window.unifiedManager.getCurrentUser();
    document.getElementById('profileName').value = currentUser.name;
    document.getElementById('profileEmail').value = currentUser.email;
    document.getElementById('profilePhone').value = currentUser.phone || '';
    document.getElementById('profileDepartment').value = currentUser.department || '';
    document.getElementById('profileBio').value = currentUser.bio || '';
    document.getElementById('emailNotifications').checked = currentUser.preferences?.emailNotifications !== false;
    document.getElementById('pushNotifications').checked = currentUser.preferences?.pushNotifications !== false;
    document.getElementById('autoDarkMode').checked = currentUser.preferences?.autoDarkMode === true;
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
}

// Fonction auxiliaire pour sauvegarder le profil
function saveUserProfile() {
    const formData = {
        name: document.getElementById('profileName').value.trim(),
        email: document.getElementById('profileEmail').value.trim(),
        phone: document.getElementById('profilePhone').value.trim(),
        department: document.getElementById('profileDepartment').value,
        bio: document.getElementById('profileBio').value.trim(),
        preferences: {
            emailNotifications: document.getElementById('emailNotifications').checked,
            pushNotifications: document.getElementById('pushNotifications').checked,
            autoDarkMode: document.getElementById('autoDarkMode').checked
        }
    };

    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Validation basique
    if (!formData.name || !formData.email) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Le nom et l\'email sont obligatoires');
        return;
    }

    // Validation email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(formData.email)) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Format d\'email invalide');
        return;
    }

    // Validation mot de passe si fourni
    if (currentPassword || newPassword || confirmPassword) {
        if (!currentPassword) {
            window.unifiedManager.notificationManager.show('error', 'Erreur', 'Mot de passe actuel requis');
            return;
        }
        if (!newPassword) {
            window.unifiedManager.notificationManager.show('error', 'Erreur', 'Nouveau mot de passe requis');
            return;
        }
        if (newPassword !== confirmPassword) {
            window.unifiedManager.notificationManager.show('error', 'Erreur', 'Les mots de passe ne correspondent pas');
            return;
        }
        if (newPassword.length < 8) {
            window.unifiedManager.notificationManager.show('error', 'Erreur', 'Le mot de passe doit contenir au moins 8 caract√®res');
            return;
        }
        formData.passwordData = { currentPassword, newPassword };
    }

    // Simulation de la sauvegarde
    const currentUser = window.unifiedManager.getCurrentUser();
    
    try {
        // Mise √† jour des donn√©es utilisateur
        Object.assign(currentUser, formData);
        
        // Simulation d'appel API
        setTimeout(() => {
            window.unifiedManager.notificationManager.show('success', 'Succ√®s', 'Profil mis √† jour avec succ√®s');
            window.unifiedManager.modalManager.hide();
            
            // Rafra√Æchir l'affichage si n√©cessaire
            if (typeof refreshUserInterface === 'function') {
                refreshUserInterface();
            }
        }, 500);
        
    } catch (error) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Erreur lors de la mise √† jour du profil');
    }
}

// FONCTION AUXILIAIRE 1: resetUserPassword(id) - EXTRACTION COMPL√àTE

function resetUserPassword(id) {
    const user = window.app.users.find(u => u.id === id);
    if (!user) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Utilisateur introuvable');
        return;
    }

    if (!window.unifiedManager.canManageUser(user)) {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Vous ne pouvez pas r√©initialiser le mot de passe de cet utilisateur');
        return;
    }

    const escapeHTML = (str) => str ? str.toString().replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
    }[tag])) : '';

    const modalContent = `
    <div class="space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-warning text-white rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-unlock-alt text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">R√©initialiser le Mot de Passe</h3>
            <p class="text-gray-600 dark:text-gray-400">${escapeHTML(user.name)} ‚Ä¢ ${escapeHTML(user.role)}</p>
        </div>

        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 p-4 rounded-lg">
            <div class="flex items-start space-x-3">
                <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 mt-1"></i>
                <div>
                    <h4 class="font-medium text-yellow-800 dark:text-yellow-200">Attention</h4>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">
                        Cette action va g√©n√©rer un nouveau mot de passe temporaire qui sera envoy√© √† l'utilisateur par email.
                        L'utilisateur devra le changer lors de sa prochaine connexion.
                    </p>
                </div>
            </div>
        </div>

        <form id="resetPasswordForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-key mr-1"></i>Type de r√©initialisation
                    </label>
                    <select id="resetType" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-warning focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="temporary">Mot de passe temporaire</option>
                        <option value="custom">Mot de passe personnalis√©</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-clock mr-1"></i>Expiration
                    </label>
                    <select id="expiration"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-warning focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="24h">24 heures</option>
                        <option value="72h">72 heures</option>
                        <option value="7d">7 jours</option>
                        <option value="30d">30 jours</option>
                    </select>
                </div>
            </div>

            <div id="customPasswordSection" class="hidden">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-lock mr-1"></i>Mot de passe personnalis√©
                </label>
                <input type="password" id="customPassword" placeholder="Saisir le nouveau mot de passe"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-warning focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                <p class="text-xs text-gray-500 mt-1">Minimum 8 caract√®res avec au moins une majuscule, une minuscule et un chiffre</p>
            </div>

            <div class="space-y-3">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="forceChange" checked class="rounded border-gray-300 text-warning focus:ring-warning">
                    <label for="forceChange" class="text-sm text-gray-700 dark:text-gray-300">
                        Forcer le changement √† la prochaine connexion
                    </label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="sendEmail" checked class="rounded border-gray-300 text-warning focus:ring-warning">
                    <label for="sendEmail" class="text-sm text-gray-700 dark:text-gray-300">
                        Envoyer le nouveau mot de passe par email
                    </label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="revokeOtherSessions" class="rounded border-gray-300 text-warning focus:ring-warning">
                    <label for="revokeOtherSessions" class="text-sm text-gray-700 dark:text-gray-300">
                        D√©connecter toutes les autres sessions actives
                    </label>
                </div>
            </div>
        </form>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center">
                <i class="fas fa-info-circle mr-2 text-primary"></i>
                Informations de S√©curit√©
            </h4>
            <div class="text-sm space-y-1 text-gray-600 dark:text-gray-400">
                <p>‚Ä¢ Cette action sera enregistr√©e dans les logs de s√©curit√©</p>
                <p>‚Ä¢ L'utilisateur recevra une notification de changement de mot de passe</p>
                <p>‚Ä¢ Le mot de passe actuel sera imm√©diatement invalid√©</p>
            </div>
        </div>

        <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
            <button type="button" onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Annuler
            </button>
            <button type="button" onclick="executePasswordReset(${user.id})"
                class="bg-warning text-white px-4 py-2 rounded-lg hover:bg-warning/90 transition-colors">
                <i class="fas fa-unlock-alt mr-2"></i>R√©initialiser le Mot de Passe
            </button>
        </div>
    </div>
    `;

    window.unifiedManager.modalManager.show(`R√©initialiser - ${escapeHTML(user.name)}`, modalContent);

    // Gestion du changement de type
    document.getElementById('resetType').addEventListener('change', function() {
        const customSection = document.getElementById('customPasswordSection');
        if (this.value === 'custom') {
            customSection.classList.remove('hidden');
        } else {
            customSection.classList.add('hidden');
        }
    });
}

function executePasswordReset(userId) {
    const user = window.app.users.find(u => u.id === userId);
    const resetType = document.getElementById('resetType').value;
    const expiration = document.getElementById('expiration').value;
    const customPassword = document.getElementById('customPassword')?.value;
    const forceChange = document.getElementById('forceChange').checked;
    const sendEmail = document.getElementById('sendEmail').checked;
    const revokeOtherSessions = document.getElementById('revokeOtherSessions').checked;

    // Validation
    if (resetType === 'custom' && (!customPassword || customPassword.length < 8)) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Le mot de passe personnalis√© doit contenir au moins 8 caract√®res');
        return;
    }

    try {
        // Simulation de r√©initialisation
        const newPassword = resetType === 'custom' ? customPassword : generateTemporaryPassword();
        
        // Mise √† jour des donn√©es utilisateur
        user.passwordReset = {
            date: new Date().toISOString(),
            byUser: window.unifiedManager.getCurrentUser().id,
            forceChange: forceChange,
            expiration: expiration
        };

        window.unifiedManager.notificationManager.show('success', 'Succ√®s', 
            `Mot de passe r√©initialis√© pour ${user.name}. ${sendEmail ? 'Email envoy√©.' : 'Nouveau mot de passe: ' + newPassword}`);
        
        window.unifiedManager.modalManager.hide();
        
        // Log de s√©curit√©
        console.log(`Password reset for user ${userId} by ${window.unifiedManager.getCurrentUser().id}`);
        
    } catch (error) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Erreur lors de la r√©initialisation du mot de passe');
    }
}

function generateTemporaryPassword() {
    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
    let password = '';
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

// FONCTION AUXILIAIRE 2: toggleUserStatus(id) - EXTRACTION COMPL√àTE

function toggleUserStatus(id) {
    const user = window.app.users.find(u => u.id === id);
    if (!user) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Utilisateur introuvable');
        return;
    }

    if (!window.unifiedManager.canManageUser(user)) {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Vous ne pouvez pas modifier le statut de cet utilisateur');
        return;
    }

    const escapeHTML = (str) => str ? str.toString().replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
    }[tag])) : '';

    const newStatus = user.status === 'Actif' ? 'Inactif' : 'Actif';
    const actionColor = newStatus === 'Actif' ? 'success' : 'warning';
    const actionIcon = newStatus === 'Actif' ? 'fa-check-circle' : 'fa-pause-circle';

    const modalContent = `
    <div class="space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-${actionColor} text-white rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas ${actionIcon} text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                ${newStatus === 'Actif' ? 'Activer' : 'D√©sactiver'} l'Utilisateur
            </h3>
            <p class="text-gray-600 dark:text-gray-400">${escapeHTML(user.name)} ‚Ä¢ ${escapeHTML(user.role)}</p>
            <div class="flex items-center justify-center space-x-3 mt-4">
                <span class="px-3 py-1 text-sm rounded-full ${user.status === 'Actif' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
                    Statut actuel: ${escapeHTML(user.status)}
                </span>
                <i class="fas fa-arrow-right text-gray-400"></i>
                <span class="px-3 py-1 text-sm rounded-full ${newStatus === 'Actif' ? 'bg-success/20 text-success' : 'bg-warning/20 text-warning'}">
                    Nouveau statut: ${newStatus}
                </span>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                <i class="fas fa-info-circle mr-2 text-primary"></i>
                Cons√©quences de cette action
            </h4>
            ${newStatus === 'Inactif' ? `
            <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-times-circle text-danger"></i>
                    <span>L'utilisateur ne pourra plus se connecter</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-times-circle text-danger"></i>
                    <span>Toutes les sessions actives seront ferm√©es</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-times-circle text-danger"></i>
                    <span>Les acc√®s aux ressources seront r√©voqu√©s</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-envelope text-info"></i>
                    <span>L'utilisateur recevra une notification de d√©sactivation</span>
                </div>
            </div>
            ` : `
            <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle text-success"></i>
                    <span>L'utilisateur pourra de nouveau se connecter</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle text-success"></i>
                    <span>Les permissions seront restaur√©es</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle text-success"></i>
                    <span>L'acc√®s aux ressources autoris√©es sera r√©tabli</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-envelope text-info"></i>
                    <span>L'utilisateur recevra une notification de r√©activation</span>
                </div>
            </div>
            `}
        </div>

        <form id="statusChangeForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-comment mr-1"></i>Motif du changement de statut
                </label>
                <textarea id="statusReason" rows="3" placeholder="Indiquez la raison de ce changement de statut..."
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base resize-none"></textarea>
            </div>

            <div class="space-y-3">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="notifyUser" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="notifyUser" class="text-sm text-gray-700 dark:text-gray-300">
                        Notifier l'utilisateur par email
                    </label>
                </div>
                ${newStatus === 'Inactif' ? `
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="closeActiveSessions" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="closeActiveSessions" class="text-sm text-gray-700 dark:text-gray-300">
                        Fermer toutes les sessions actives
                    </label>
                </div>
                ` : ''}
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="logAction" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="logAction" class="text-sm text-gray-700 dark:text-gray-300">
                        Enregistrer dans les logs d'audit
                    </label>
                </div>
            </div>
        </form>

        <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
            <button type="button" onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Annuler
            </button>
            <button type="button" onclick="executeStatusChange(${user.id}, '${newStatus}')"
                class="bg-${actionColor} text-white px-4 py-2 rounded-lg hover:bg-${actionColor}/90 transition-colors">
                <i class="fas ${actionIcon} mr-2"></i>${newStatus === 'Actif' ? 'Activer' : 'D√©sactiver'} l'Utilisateur
            </button>
        </div>
    </div>
    `;

    window.unifiedManager.modalManager.show(`${newStatus === 'Actif' ? 'Activer' : 'D√©sactiver'} - ${escapeHTML(user.name)}`, modalContent);
}

function executeStatusChange(userId, newStatus) {
    const user = window.app.users.find(u => u.id === userId);
    const reason = document.getElementById('statusReason').value.trim();
    const notifyUser = document.getElementById('notifyUser').checked;
    const closeActiveSessions = document.getElementById('closeActiveSessions')?.checked || false;
    const logAction = document.getElementById('logAction').checked;

    if (!reason) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Veuillez indiquer le motif du changement de statut');
        return;
    }

    try {
        // Mise √† jour du statut
        const oldStatus = user.status;
        user.status = newStatus;
        user.statusHistory = user.statusHistory || [];
        user.statusHistory.push({
            date: new Date().toISOString(),
            oldStatus: oldStatus,
            newStatus: newStatus,
            reason: reason,
            changedBy: window.unifiedManager.getCurrentUser().id
        });

        // Actions sp√©cifiques selon le statut
        if (newStatus === 'Inactif' && closeActiveSessions) {
            // Simulation de fermeture des sessions
            user.activeSessions = [];
        }

        window.unifiedManager.notificationManager.show('success', 'Succ√®s', 
            `Statut de ${user.name} chang√© vers "${newStatus}" avec succ√®s`);
        
        window.unifiedManager.modalManager.hide();

        // Log d'audit
        if (logAction) {
            console.log(`User status changed: ${userId} from ${oldStatus} to ${newStatus} by ${window.unifiedManager.getCurrentUser().id}`);
        }

        // Rafra√Æchir l'affichage si n√©cessaire
        if (typeof refreshUserList === 'function') {
            refreshUserList();
        }
        
    } catch (error) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Erreur lors du changement de statut');
    }
}

// FONCTION AUXILIAIRE 3: generateUserReport(id) - EXTRACTION COMPL√àTE

function generateUserReport(id) {
    const user = window.app.users.find(u => u.id === id);
    if (!user) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Utilisateur introuvable');
        return;
    }

    if (!window.unifiedManager.canViewUserDetails(user)) {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Vous ne pouvez pas g√©n√©rer de rapport pour cet utilisateur');
        return;
    }

    const escapeHTML = (str) => str ? str.toString().replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
    }[tag])) : '';

    const modalContent = `
    <div class="space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-success text-white rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-chart-bar text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Rapport d'Activit√©</h3>
            <p class="text-gray-600 dark:text-gray-400">${escapeHTML(user.name)} ‚Ä¢ ${escapeHTML(user.role)}</p>
        </div>

        <form id="reportForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>P√©riode de d√©but
                    </label>
                    <input type="date" id="startDate" value="${new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>P√©riode de fin
                    </label>
                    <input type="date" id="endDate" value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-list mr-1"></i>Type de rapport
                </label>
                <select id="reportType" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                    <option value="complete">Rapport complet</option>
                    <option value="activity">Activit√© seulement</option>
                    <option value="security">S√©curit√© et acc√®s</option>
                    <option value="permissions">Permissions et droits</option>
                    <option value="performance">Performance</option>
                </select>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-medium text-gray-900 dark:text-white mb-3">Sections √† inclure</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="includeLogins" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="includeLogins" class="text-sm text-gray-700 dark:text-gray-300">Connexions</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="includeActions" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="includeActions" class="text-sm text-gray-700 dark:text-gray-300">Actions effectu√©es</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="includePermissions" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="includePermissions" class="text-sm text-gray-700 dark:text-gray-300">Permissions</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="includeCompanies" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="includeCompanies" class="text-sm text-gray-700 dark:text-gray-300">Entreprises</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="includeErrors" class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="includeErrors" class="text-sm text-gray-700 dark:text-gray-300">Erreurs/Incidents</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="includeChanges" class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="includeChanges" class="text-sm text-gray-700 dark:text-gray-300">Modifications</label>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-file-alt mr-1"></i>Format de sortie
                    </label>
                    <select id="outputFormat"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel (XLSX)</option>
                        <option value="csv">CSV</option>
                        <option value="html">HTML</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-cog mr-1"></i>Options
                    </label>
                    <select id="reportOptions"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="detailed">D√©taill√©</option>
                        <option value="summary">R√©sum√©</option>
                        <option value="executive">Synth√®se ex√©cutive</option>
                    </select>
                </div>
            </div>
        </form>

        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 p-4 rounded-lg">
            <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2 flex items-center">
                <i class="fas fa-info-circle mr-2"></i>Aper√ßu du rapport
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center text-sm">
                <div>
                    <p class="text-2xl font-bold text-blue-600">${user.stats?.logins || 0}</p>
                    <p class="text-blue-700 dark:text-blue-300">Connexions</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-blue-600">${user.stats?.actions || 0}</p>
                    <p class="text-blue-700 dark:text-blue-300">Actions</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-blue-600">${user.permissions?.length || 0}</p>
                    <p class="text-blue-700 dark:text-blue-300">Permissions</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-blue-600">${user.companies?.length || 0}</p>
                    <p class="text-blue-700 dark:text-blue-300">Entreprises</p>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
            <button type="button" onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Annuler
            </button>
            <div class="flex space-x-3">
                <button type="button" onclick="previewUserReport(${user.id})"
                    class="bg-info text-white px-4 py-2 rounded-lg hover:bg-info/90 transition-colors">
                    <i class="fas fa-eye mr-2"></i>Aper√ßu
                </button>
                <button type="button" onclick="executeReportGeneration(${user.id})"
                    class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/90 transition-colors">
                    <i class="fas fa-download mr-2"></i>G√©n√©rer le Rapport
                </button>
            </div>
        </div>
    </div>
    `;

    window.unifiedManager.modalManager.show(`Rapport - ${escapeHTML(user.name)}`, modalContent, 'large');
}

function executeReportGeneration(userId) {
    const user = window.app.users.find(u => u.id === userId);
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const reportType = document.getElementById('reportType').value;
    const outputFormat = document.getElementById('outputFormat').value;
    const reportOptions = document.getElementById('reportOptions').value;

    const sections = {
        logins: document.getElementById('includeLogins').checked,
        actions: document.getElementById('includeActions').checked,
        permissions: document.getElementById('includePermissions').checked,
        companies: document.getElementById('includeCompanies').checked,
        errors: document.getElementById('includeErrors').checked,
        changes: document.getElementById('includeChanges').checked
    };

    if (!startDate || !endDate) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Veuillez s√©lectionner une p√©riode valide');
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'La date de d√©but doit √™tre ant√©rieure √† la date de fin');
        return;
    }

    try {
        // Simulation de g√©n√©ration de rapport
        const reportData = {
            user: user,
            period: { start: startDate, end: endDate },
            type: reportType,
            format: outputFormat,
            options: reportOptions,
            sections: sections,
            generatedBy: window.unifiedManager.getCurrentUser().id,
            generatedAt: new Date().toISOString()
        };

        // Simulation du t√©l√©chargement
        const fileName = `rapport_${user.name.replace(/\s+/g, '_')}_${startDate}_${endDate}.${outputFormat}`;
        
        window.unifiedManager.notificationManager.show('success', 'Succ√®s', 
            `Rapport g√©n√©r√© avec succ√®s: ${fileName}`);
        
        window.unifiedManager.modalManager.hide();

        // Simulation du t√©l√©chargement de fichier
        setTimeout(() => {
            console.log(`Downloading report: ${fileName}`, reportData);
        }, 1000);
        
    } catch (error) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Erreur lors de la g√©n√©ration du rapport');
    }
}

function previewUserReport(userId) {
    window.unifiedManager.notificationManager.show('info', 'Aper√ßu', 'Fonctionnalit√© d\'aper√ßu en cours de d√©veloppement');
}

// FONCTION AUXILIAIRE 4: sendNotificationToUser(id) - EXTRACTION COMPL√àTE

function sendNotificationToUser(id) {
    const user = window.app.users.find(u => u.id === id);
    if (!user) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Utilisateur introuvable');
        return;
    }

    if (!window.unifiedManager.canManageUser(user)) {
        window.unifiedManager.notificationManager.show('error', 'Acc√®s refus√©', 'Vous ne pouvez pas envoyer de notification √† cet utilisateur');
        return;
    }

    const escapeHTML = (str) => str ? str.toString().replace(/[&<>'"]/g, (tag) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
    }[tag])) : '';

    const modalContent = `
    <div class="space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-primary text-white rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-envelope text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Envoyer une Notification</h3>
            <p class="text-gray-600 dark:text-gray-400">${escapeHTML(user.name)} ‚Ä¢ ${escapeHTML(user.email)}</p>
        </div>

        <form id="notificationForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-tag mr-1"></i>Type de notification
                    </label>
                    <select id="notificationType"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="info">Information</option>
                        <option value="warning">Avertissement</option>
                        <option value="urgent">Urgent</option>
                        <option value="reminder">Rappel</option>
                        <option value="security">S√©curit√©</option>
                        <option value="system">Syst√®me</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-star mr-1"></i>Priorit√©
                    </label>
                    <select id="priority"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="low">Basse</option>
                        <option value="normal" selected>Normale</option>
                        <option value="high">√âlev√©e</option>
                        <option value="critical">Critique</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-heading mr-1"></i>Objet *
                </label>
                <input type="text" id="notificationSubject" placeholder="Objet de la notification" required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-align-left mr-1"></i>Message *
                </label>
                <textarea id="notificationMessage" rows="5" placeholder="Contenu de la notification..." required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base resize-none"></textarea>
                <p class="text-xs text-gray-500 mt-1">Vous pouvez utiliser du markdown pour la mise en forme</p>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-medium text-gray-900 dark:text-white mb-3">Canaux de diffusion</h4>
                <div class="space-y-3">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="sendEmail" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="sendEmail" class="text-sm text-gray-700 dark:text-gray-300">
                            <i class="fas fa-envelope mr-1"></i>Email
                        </label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="sendInApp" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="sendInApp" class="text-sm text-gray-700 dark:text-gray-300">
                            <i class="fas fa-bell mr-1"></i>Notification dans l'application
                        </label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="sendSMS" class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="sendSMS" class="text-sm text-gray-700 dark:text-gray-300">
                            <i class="fas fa-sms mr-1"></i>SMS (si urgent ou critique)
                        </label>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-clock mr-1"></i>Programmation
                    </label>
                    <select id="scheduleOption"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="now">Envoyer maintenant</option>
                        <option value="schedule">Programmer l'envoi</option>
                    </select>
                </div>
                <div id="scheduleDateTime" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i>Date et heure
                    </label>
                    <input type="datetime-local" id="scheduledTime"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="requireAcknowledgment" class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="requireAcknowledgment" class="text-sm text-gray-700 dark:text-gray-300">
                        Demander un accus√© de r√©ception
                    </label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="trackOpening" class="rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="trackOpening" class="text-sm text-gray-700 dark:text-gray-300">
                        Suivre l'ouverture de la notification
                    </label>
                </div>
            </div>
        </form>

        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 p-4 rounded-lg">
            <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2 flex items-center">
                <i class="fas fa-eye mr-2"></i>Aper√ßu de la notification
            </h4>
            <div id="notificationPreview" class="bg-white dark:bg-gray-800 p-3 rounded border">
                <p class="text-sm text-gray-500">L'aper√ßu appara√Ætra ici...</p>
            </div>
        </div>

        <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
            <button type="button" onclick="window.unifiedManager.modalManager.hide()"
                class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                Annuler
            </button>
            <div class="flex space-x-3">
                <button type="button" onclick="previewNotification()"
                    class="bg-info text-white px-4 py-2 rounded-lg hover:bg-info/90 transition-colors">
                    <i class="fas fa-eye mr-2"></i>Aper√ßu
                </button>
                <button type="button" onclick="executeSendNotification(${user.id})"
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                    <i class="fas fa-paper-plane mr-2"></i>Envoyer
                </button>
            </div>
        </div>
    </div>
    `;

    window.unifiedManager.modalManager.show(`Notification - ${escapeHTML(user.name)}`, modalContent, 'large');

    // Gestion de la programmation
    document.getElementById('scheduleOption').addEventListener('change', function() {
        const scheduleDiv = document.getElementById('scheduleDateTime');
        if (this.value === 'schedule') {
            scheduleDiv.classList.remove('hidden');
        } else {
            scheduleDiv.classList.add('hidden');
        }
    });

    // Aper√ßu en temps r√©el
    ['notificationSubject', 'notificationMessage'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateNotificationPreview);
    });
}

function updateNotificationPreview() {
    const subject = document.getElementById('notificationSubject').value;
    const message = document.getElementById('notificationMessage').value;
    const type = document.getElementById('notificationType').value;
    
    const preview = document.getElementById('notificationPreview');
    
    if (subject || message) {
        const typeIcons = {
            info: 'fa-info-circle text-blue-500',
            warning: 'fa-exclamation-triangle text-yellow-500',
            urgent: 'fa-exclamation-circle text-red-500',
            reminder: 'fa-bell text-purple-500',
            security: 'fa-shield-alt text-orange-500',
            system: 'fa-cog text-gray-500'
        };
        
        preview.innerHTML = `
            <div class="flex items-start space-x-3">
                <i class="fas ${typeIcons[type]} mt-1"></i>
                <div class="flex-1">
                    <h5 class="font-medium text-gray-900 dark:text-white">${subject || 'Objet de la notification'}</h5>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${message || 'Message de la notification...'}</p>
                </div>
            </div>
        `;
    } else {
        preview.innerHTML = '<p class="text-sm text-gray-500">L\'aper√ßu appara√Ætra ici...</p>';
    }
}

function previewNotification() {
    updateNotificationPreview();
    window.unifiedManager.notificationManager.show('info', 'Aper√ßu', 'Aper√ßu mis √† jour dans la section correspondante');
}

function executeSendNotification(userId) {
    const user = window.app.users.find(u => u.id === userId);
    const subject = document.getElementById('notificationSubject').value.trim();
    const message = document.getElementById('notificationMessage').value.trim();
    const type = document.getElementById('notificationType').value;
    const priority = document.getElementById('priority').value;
    const scheduleOption = document.getElementById('scheduleOption').value;
    const scheduledTime = document.getElementById('scheduledTime')?.value;

    const channels = {
        email: document.getElementById('sendEmail').checked,
        inApp: document.getElementById('sendInApp').checked,
        sms: document.getElementById('sendSMS').checked
    };

    const options = {
        requireAcknowledgment: document.getElementById('requireAcknowledgment').checked,
        trackOpening: document.getElementById('trackOpening').checked
    };

    // Validation
    if (!subject || !message) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'L\'objet et le message sont obligatoires');
        return;
    }

    if (!channels.email && !channels.inApp && !channels.sms) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Veuillez s√©lectionner au moins un canal de diffusion');
        return;
    }

    if (scheduleOption === 'schedule' && !scheduledTime) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Veuillez sp√©cifier la date et l\'heure d\'envoi');
        return;
    }

    try {
        const notificationData = {
            to: userId,
            subject: subject,
            message: message,
            type: type,
            priority: priority,
            channels: channels,
            options: options,
            sentBy: window.unifiedManager.getCurrentUser().id,
            sentAt: scheduleOption === 'now' ? new Date().toISOString() : scheduledTime
        };

        // Simulation d'envoi
        if (scheduleOption === 'now') {
            window.unifiedManager.notificationManager.show('success', 'Succ√®s', 
                `Notification envoy√©e √† ${user.name} avec succ√®s`);
        } else {
            window.unifiedManager.notificationManager.show('success', 'Programm√©', 
                `Notification programm√©e pour ${new Date(scheduledTime).toLocaleString('fr-FR')}`);
        }

        window.unifiedManager.modalManager.hide();

        // Log de l'envoi
        console.log(`Notification sent to user ${userId}:`, notificationData);
        
    } catch (error) {
        window.unifiedManager.notificationManager.show('error', 'Erreur', 'Erreur lors de l\'envoi de la notification');
    }
}

        /**
 * √âTATS FINANCIERS SYSCOHADA R√âVIS√â
 * Fichier : etats-financiers-syscohada.js
 * Description : Fonctions de g√©n√©ration des √©tats financiers conformes SYSCOHADA
 * Version : 1.0
 * Conformit√© : SYSCOHADA R√©vis√© 2017
 */

// ============================================================================
// 0. GESTIONNAIRE D'INT√âGRATION ET S√âCURIT√â
// ============================================================================

/**
 * Gestionnaire de s√©curit√© pour l'int√©gration entre couches
 */
const SYSCOHADAIntegrationManager = {
    // V√©rification de l'√©tat des d√©pendances
    validateDependencies() {
        const errors = [];
        
        if (typeof window === 'undefined') {
            errors.push('Environnement window non disponible');
        }
        
        if (!window.app) {
            errors.push('Module principal (window.app) non initialis√©');
        }
        
        if (!window.unifiedManager) {
            errors.push('Gestionnaire unifi√© (window.unifiedManager) non disponible');
        }
        
        if (window.app && !window.app.currentCompanyId) {
            errors.push('Aucune entreprise s√©lectionn√©e');
        }
        
        if (errors.length > 0) {
            throw new Error(`Erreurs d'int√©gration d√©tect√©es: ${errors.join(', ')}`);
        }
        
        return true;
    },
    
    // V√©rification s√©curis√©e de l'existence des donn√©es
    checkDataAvailability() {
        try {
            this.validateDependencies();
            
            if (!window.app.filteredData) {
                throw new Error('Donn√©es filtr√©es non disponibles');
            }
            
            if (!window.app.filteredData.entries || !Array.isArray(window.app.filteredData.entries)) {
                throw new Error('√âcritures comptables non disponibles');
            }
            
            if (!window.app.accounts || !Array.isArray(window.app.accounts)) {
                throw new Error('Plan comptable non disponible');
            }
            
            return true;
        } catch (error) {
            this.handleIntegrationError(error, 'V√©rification des donn√©es');
            return false;
        }
    },
    
    // Gestionnaire d'erreur unifi√©
    handleIntegrationError(error, context = 'Op√©ration SYSCOHADA') {
        console.error(`[SYSCOHADA Integration Error] ${context}:`, error);
        
        // Notification s√©curis√©e
        if (window.unifiedManager && window.unifiedManager.notificationManager) {
            window.unifiedManager.notificationManager.show(
                'error',
                'Erreur d\'int√©gration SYSCOHADA',
                `${context}: ${error.message}`
            );
        } else {
            // Fallback si le syst√®me de notification n'est pas disponible
            console.log(`‚ùå ERREUR SYSCOHADA - ${context}: ${error.message}`);
        }
    },
    
    // Notification s√©curis√©e
    showNotification(type, title, message) {
        try {
            if (window.unifiedManager && window.unifiedManager.notificationManager) {
                window.unifiedManager.notificationManager.show(type, title, message);
            } else {
                // Fallback
                console.log(`[${type.toUpperCase()}] ${title}: ${message}`);
            }
        } catch (error) {
            console.error('Erreur syst√®me de notification:', error);
        }
    },
    
    // Modal s√©curis√©e
    showModal(title, content) {
        try {
            if (window.unifiedManager && window.unifiedManager.modalManager) {
                window.unifiedManager.modalManager.show(title, content);
                return true;
            } else {
                throw new Error('Syst√®me de modal non disponible');
            }
        } catch (error) {
            this.handleIntegrationError(error, 'Affichage modal');
            return false;
        }
    },
    
    // Obtenir le nom de l'entreprise s√©lectionn√©e de mani√®re s√©curis√©e
    getSelectedCompanyName() {
        try {
            if (window.unifiedManager && typeof window.unifiedManager.getSelectedCompanyName === 'function') {
                return window.unifiedManager.getSelectedCompanyName();
            } else if (window.app && window.app.companies && window.app.currentCompanyId) {
                const company = window.app.companies.find(c => c.id === window.app.currentCompanyId);
                return company ? company.name : 'Entreprise inconnue';
            } else {
                return 'Entreprise non d√©finie';
            }
        } catch (error) {
            console.error('Erreur r√©cup√©ration nom entreprise:', error);
            return 'Entreprise (erreur)';
        }
    }
};

// ============================================================================
// 1. BILAN SYSCOHADA R√âVIS√â CONFORME
// ============================================================================
/**
* G√©n√®re le bilan SYSCOHADA R√©vis√© conforme
*/
/**
* G√©n√®re le bilan SYSCOHADA R√©vis√© conforme
*/
function generateBilanSYSCOHADA() {
    try {
        // V√©rification s√©curis√©e des d√©pendances
        if (!SYSCOHADAIntegrationManager.checkDataAvailability()) {
            return; // L'erreur a d√©j√† √©t√© g√©r√©e
        }

        SYSCOHADAIntegrationManager.showNotification('info', 'G√©n√©ration en cours', 'Pr√©paration du bilan SYSCOHADA R√©vis√©...');

        setTimeout(() => {
            try {
                const companyName = SYSCOHADAIntegrationManager.getSelectedCompanyName();
                const bilanData = calculateBilanSYSCOHADA();

                const modalContent = `
                <div class="space-y-6">
                    <!-- En-t√™te officiel -->
                    <div class="text-center border-b border-gray-200 dark:border-gray-600 pb-4">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">BILAN - SYSCOHADA R√âVIS√â</h2>
                        <p class="text-gray-600 dark:text-gray-400">${companyName}</p>
                        <p class="text-sm text-gray-500">Exercice clos le ${new Date().toLocaleDateString('fr-FR')} (en FCFA)</p>
                    </div>

                    <!-- Bilan conforme SYSCOHADA -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- ACTIF -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="bg-primary text-white p-4 rounded-t-lg">
                                <h3 class="font-bold text-center">ACTIF</h3>
                            </div>
                            <div class="p-4">
                                <div class="space-y-2 text-sm">
                                    <!-- ACTIF IMMOBILIS√â -->
                                    <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1">
                                        ACTIF IMMOBILIS√â
                                    </div>
                                    
                                    <div class="flex justify-between">
                                        <span class="pl-2">AB - Charges immobilis√©es</span>
                                        <span class="font-mono">${bilanData.actif.AB.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">AC - Immobilisations incorporelles</span>
                                        <span class="font-mono">${bilanData.actif.AC.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">AD - Immobilisations corporelles</span>
                                        <span class="font-mono">${bilanData.actif.AD.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">AE - Avances/acomptes sur immobilisations</span>
                                        <span class="font-mono">${bilanData.actif.AE.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">AF - Immobilisations financi√®res</span>
                                        <span class="font-mono">${bilanData.actif.AF.toLocaleString('fr-FR')}</span>
                                    </div>
                                    
                                    <div class="flex justify-between font-semibold border-t border-gray-200 dark:border-gray-600 pt-1">
                                        <span>TOTAL ACTIF IMMOBILIS√â</span>
                                        <span class="font-mono">${bilanData.actif.totalImmobilise.toLocaleString('fr-FR')}</span>
                                    </div>

                                    <!-- ACTIF CIRCULANT -->
                                    <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1 mt-4">
                                        ACTIF CIRCULANT
                                    </div>
                                    
                                    <div class="flex justify-between">
                                        <span class="pl-2">AG - Stocks et en-cours</span>
                                        <span class="font-mono">${bilanData.actif.AG.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">AH - Cr√©ances et emplois assimil√©s</span>
                                        <span class="font-mono">${bilanData.actif.AH.toLocaleString('fr-FR')}</span>
                                    </div>
                                    
                                    <div class="flex justify-between font-semibold border-t border-gray-200 dark:border-gray-600 pt-1">
                                        <span>TOTAL ACTIF CIRCULANT HAO</span>
                                        <span class="font-mono">${bilanData.actif.totalCirculantHAO.toLocaleString('fr-FR')}</span>
                                    </div>

                                    <!-- TR√âSORERIE ACTIF -->
                                    <div class="flex justify-between">
                                        <span class="pl-2">AI - Tr√©sorerie-Actif</span>
                                        <span class="font-mono">${bilanData.actif.AI.toLocaleString('fr-FR')}</span>
                                    </div>

                                    <!-- √âCARTS DE CONVERSION -->
                                    <div class="flex justify-between">
                                        <span class="pl-2">AJ - √âcarts de conversion-Actif</span>
                                        <span class="font-mono">${bilanData.actif.AJ.toLocaleString('fr-FR')}</span>
                                    </div>

                                    <div class="flex justify-between font-bold text-lg border-t-2 border-primary pt-2 mt-3">
                                        <span>TOTAL G√âN√âRAL ACTIF</span>
                                        <span class="font-mono text-primary">${bilanData.actif.totalGeneral.toLocaleString('fr-FR')}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PASSIF -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="bg-success text-white p-4 rounded-t-lg">
                                <h3 class="font-bold text-center">PASSIF</h3>
                            </div>
                            <div class="p-4">
                                <div class="space-y-2 text-sm">
                                    <!-- CAPITAUX PROPRES -->
                                    <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1">
                                        CAPITAUX PROPRES ET RESSOURCES ASSIMIL√âES
                                    </div>
                                    
                                    <div class="flex justify-between">
                                        <span class="pl-2">BA - Capital</span>
                                        <span class="font-mono">${bilanData.passif.BA.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BB - Primes et r√©serves</span>
                                        <span class="font-mono">${bilanData.passif.BB.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BC - √âcarts de r√©√©valuation</span>
                                        <span class="font-mono">${bilanData.passif.BC.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BD - R√©sultat net de l'exercice</span>
                                        <span class="font-mono ${bilanData.passif.BD >= 0 ? 'text-success' : 'text-danger'}">${bilanData.passif.BD.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BE - Autres capitaux propres</span>
                                        <span class="font-mono">${bilanData.passif.BE.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BF - Subventions d'investissement</span>
                                        <span class="font-mono">${bilanData.passif.BF.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BG - Provisions r√©glement√©es</span>
                                        <span class="font-mono">${bilanData.passif.BG.toLocaleString('fr-FR')}</span>
                                    </div>
                                    
                                    <div class="flex justify-between font-semibold border-t border-gray-200 dark:border-gray-600 pt-1">
                                        <span>TOTAL CAPITAUX PROPRES</span>
                                        <span class="font-mono">${bilanData.passif.totalCapitaux.toLocaleString('fr-FR')}</span>
                                    </div>

                                    <!-- DETTES FINANCI√àRES -->
                                    <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1 mt-4">
                                        DETTES FINANCI√àRES ET RESSOURCES ASSIMIL√âES
                                    </div>
                                    
                                    <div class="flex justify-between">
                                        <span class="pl-2">BH - Emprunts et dettes financi√®res</span>
                                        <span class="font-mono">${bilanData.passif.BH.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BI - Dettes circulantes HAO</span>
                                        <span class="font-mono">${bilanData.passif.BI.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BJ - Provisions pour risques et charges</span>
                                        <span class="font-mono">${bilanData.passif.BJ.toLocaleString('fr-FR')}</span>
                                    </div>
                                    
                                    <!-- PASSIF CIRCULANT -->
                                    <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1 mt-4">
                                        PASSIF CIRCULANT
                                    </div>
                                    
                                    <div class="flex justify-between">
                                        <span class="pl-2">BK - Dettes circulantes</span>
                                        <span class="font-mono">${bilanData.passif.BK.toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="pl-2">BL - Tr√©sorerie-Passif</span>
                                        <span class="font-mono">${bilanData.passif.BL.toLocaleString('fr-FR')}</span>
                                    </div>

                                    <div class="flex justify-between font-bold text-lg border-t-2 border-success pt-2 mt-3">
                                        <span>TOTAL G√âN√âRAL PASSIF</span>
                                        <span class="font-mono text-success">${bilanData.passif.totalGeneral.toLocaleString('fr-FR')}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contr√¥le d'√©quilibre -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-900 dark:text-white">Contr√¥le d'√©quilibre SYSCOHADA:</span>
                            <span class="font-bold ${bilanData.actif.totalGeneral === bilanData.passif.totalGeneral ? 'text-success' : 'text-danger'}">
                                ${bilanData.actif.totalGeneral === bilanData.passif.totalGeneral ? '‚úì BILAN √âQUILIBR√â' : '‚ö† BILAN D√âS√âQUILIBR√â'}
                            </span>
                        </div>
                        ${bilanData.actif.totalGeneral !== bilanData.passif.totalGeneral ? `
                        <div class="mt-2 text-sm text-danger">
                            √âcart: ${Math.abs(bilanData.actif.totalGeneral - bilanData.passif.totalGeneral).toLocaleString('fr-FR')} FCFA
                        </div>
                        ` : ''}
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
                        <div class="flex space-x-3">
                            <button onclick="exportBilanSYSCOHADA()" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/90 transition-colors">
                                <i class="fas fa-download mr-2"></i>Export PDF SYSCOHADA
                            </button>
                            <button onclick="printBilanSYSCOHADA()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                <i class="fas fa-print mr-2"></i>Imprimer
                            </button>
                        </div>
                        <button onclick="closeModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                            Fermer
                        </button>
                    </div>
                </div>
                `;

                if (SYSCOHADAIntegrationManager.showModal('Bilan SYSCOHADA R√©vis√©', modalContent)) {
                    SYSCOHADAIntegrationManager.showNotification('success', 'Bilan SYSCOHADA g√©n√©r√©', 'Le bilan conforme SYSCOHADA R√©vis√© a √©t√© g√©n√©r√©');
                }
            } catch (error) {
                SYSCOHADAIntegrationManager.handleIntegrationError(error, 'G√©n√©ration du bilan');
            }
        }, 2000);
        
    } catch (error) {
        SYSCOHADAIntegrationManager.handleIntegrationError(error, 'Initialisation g√©n√©ration bilan');
    }
}

/**
* Calcule le bilan selon la structure SYSCOHADA R√©vis√©
*/
function calculateBilanSYSCOHADA() {
    const entries = window.app.filteredData.entries.filter(e => e.status === 'Valid√©');
    const accounts = window.app.accounts;
    
    // Calculer les soldes par classe de comptes SYSCOHADA
    const soldes = calculateSoldesByClass(entries, accounts);
    
    const actif = {
        // Charges immobilis√©es (classe 20)
        AB: getSoldeByClassRange(soldes, '201', '209'),
        // Immobilisations incorporelles (classe 21)
        AC: getSoldeByClassRange(soldes, '210', '219'),
        // Immobilisations corporelles (classes 22, 23, 24)
        AD: getSoldeByClassRange(soldes, '220', '249'),
        // Avances et acomptes vers√©s sur immobilisations (classe 25)
        AE: getSoldeByClassRange(soldes, '250', '259'),
        // Immobilisations financi√®res (classes 26, 27)
        AF: getSoldeByClassRange(soldes, '260', '279'),
        // Stocks (classe 3)
        AG: getSoldeByClassRange(soldes, '300', '399'),
        // Cr√©ances et emplois assimil√©s (classe 4 - d√©biteur)
        AH: getSoldeByClassRange(soldes, '400', '499', 'debiteur'),
        // Tr√©sorerie-Actif (classe 5 - actif)
        AI: getSoldeByClassRange(soldes, '500', '589'),
        // √âcarts de conversion-Actif
        AJ: 0
    };
    
    actif.totalImmobilise = actif.AB + actif.AC + actif.AD + actif.AE + actif.AF;
    actif.totalCirculantHAO = actif.AG + actif.AH;
    actif.totalGeneral = actif.totalImmobilise + actif.totalCirculantHAO + actif.AI + actif.AJ;
    
    const passif = {
        // Capital (classe 10)
        BA: getSoldeByClassRange(soldes, '101', '109'),
        // Primes et r√©serves (classes 11, 12)
        BB: getSoldeByClassRange(soldes, '110', '129'),
        // √âcarts de r√©√©valuation (classe 105)
        BC: getSoldeByClassRange(soldes, '105', '105'),
        // R√©sultat net (calcul√©)
        BD: calculateResultatNet(entries, accounts),
        // Autres capitaux propres (classe 13)
        BE: getSoldeByClassRange(soldes, '130', '139'),
        // Subventions d'investissement (classe 14)
        BF: getSoldeByClassRange(soldes, '140', '149'),
        // Provisions r√©glement√©es (classe 15)
        BG: getSoldeByClassRange(soldes, '150', '159'),
        // Emprunts et dettes financi√®res (classe 16)
        BH: getSoldeByClassRange(soldes, '160', '169'),
        // Dettes circulantes HAO
        BI: 0,
        // Provisions pour risques et charges (classe 19)
        BJ: getSoldeByClassRange(soldes, '190', '199'),
        // Dettes circulantes (classe 4 - cr√©diteur)
        BK: getSoldeByClassRange(soldes, '400', '499', 'crediteur'),
        // Tr√©sorerie-Passif (classe 5 - passif)
        BL: getSoldeByClassRange(soldes, '590', '599')
    };
    
    passif.totalCapitaux = passif.BA + passif.BB + passif.BC + passif.BD + passif.BE + passif.BF + passif.BG;
    passif.totalGeneral = passif.totalCapitaux + passif.BH + passif.BI + passif.BJ + passif.BK + passif.BL;
    
    return { actif, passif };
}

/**
* Calcule les soldes par classe de comptes
*/
function calculateSoldesByClass(entries, accounts) {
    const soldes = {};
    
    entries.forEach(entry => {
        entry.lines.forEach(line => {
            const account = accounts.find(a => a.code === line.account);
            if (account) {
                if (!soldes[line.account]) soldes[line.account] = 0;
                
                // Selon la nature du compte (D√©bit/Cr√©dit)
                if (account.nature === 'Debit') {
                    soldes[line.account] += (line.debit || 0) - (line.credit || 0);
                } else {
                    soldes[line.account] += (line.credit || 0) - (line.debit || 0);
                }
            }
        });
    });
    
    return soldes;
}

/**
* Obtient le solde par plage de classe SYSCOHADA
*/
function getSoldeByClassRange(soldes, start, end, sens = 'normal') {
    let total = 0;
    
    Object.keys(soldes).forEach(code => {
        if (code >= start && code <= end) {
            const solde = soldes[code];
            if (sens === 'debiteur' && solde > 0) {
                total += solde;
            } else if (sens === 'crediteur' && solde < 0) {
                total += Math.abs(solde);
            } else if (sens === 'normal') {
                total += Math.abs(solde);
            }
        }
    });
    
    return total;
}

/**
* Calcule le r√©sultat net selon SYSCOHADA
*/
function calculateResultatNet(entries, accounts) {
    let produits = 0;
    let charges = 0;
    
    entries.forEach(entry => {
        entry.lines.forEach(line => {
            const account = accounts.find(a => a.code === line.account);
            if (account) {
                // Classe 7 = Produits
                if (line.account.startsWith('7')) {
                    produits += (line.credit || 0);
                }
                // Classe 6 = Charges
                if (line.account.startsWith('6')) {
                    charges += (line.debit || 0);
                }
            }
        });
    });
    
    return produits - charges;
}

// ============================================================================
// SYST√àME D'EXPORT PDF R√âEL SYSCOHADA
// ============================================================================

/**
 * Gestionnaire d'export PDF pour les √©tats financiers SYSCOHADA
 */
const SYSCOHADAPDFExporter = {
    
    /**
     * Configuration de base pour les PDF SYSCOHADA
     */
    config: {
        format: 'a4',
        orientation: 'portrait',
        margins: { top: 20, right: 15, bottom: 20, left: 15 },
        fontSize: {
            title: 16,
            subtitle: 14,
            normal: 10,
            small: 8
        },
        colors: {
            primary: '#5D5CDE',
            success: '#10B981',
            danger: '#EF4444',
            gray: '#6B7280'
        }
    },
    
    /**
     * G√©n√®re l'en-t√™te standard SYSCOHADA
     */
    generateHeader(doc, companyName, reportTitle, exercice) {
        const pageWidth = doc.internal.pageSize.getWidth();
        
        // Titre de l'entreprise
        doc.setFontSize(this.config.fontSize.title);
        doc.setFont('helvetica', 'bold');
        doc.text(companyName, pageWidth / 2, 30, { align: 'center' });
        
        // Titre du rapport
        doc.setFontSize(this.config.fontSize.subtitle);
        doc.text(reportTitle, pageWidth / 2, 45, { align: 'center' });
        
        // Exercice
        doc.setFontSize(this.config.fontSize.normal);
        doc.setFont('helvetica', 'normal');
        doc.text(`Exercice ${exercice} - Syst√®me Comptable SYSCOHADA R√©vis√©`, pageWidth / 2, 55, { align: 'center' });
        
        // Ligne de s√©paration
        doc.setLineWidth(0.5);
        doc.line(15, 65, pageWidth - 15, 65);
        
        return 70; // Position Y pour le contenu
    },
    
    /**
     * G√©n√®re le pied de page standard
     */
    generateFooter(doc) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        doc.setFontSize(this.config.fontSize.small);
        doc.setFont('helvetica', 'normal');
        
        // Date d'√©dition
        const dateEdition = new Date().toLocaleDateString('fr-FR') + ' √† ' + new Date().toLocaleTimeString('fr-FR');
        doc.text(`√âdit√© le ${dateEdition}`, 15, pageHeight - 15);
        
        // Signature logiciel
        doc.text('DOUK√à Compta Pro - Conforme SYSCOHADA R√©vis√©', pageWidth - 15, pageHeight - 15, { align: 'right' });
        
        // Num√©ro de page
        const pageNumber = doc.internal.getNumberOfPages();
        doc.text(`Page ${pageNumber}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
    },
    
    /**
     * Cr√©e un tableau format√© pour les √©tats financiers
     */
    createTable(doc, startY, headers, data, options = {}) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const margins = this.config.margins;
        const tableWidth = pageWidth - margins.left - margins.right;
        
        // Configuration par d√©faut
        const config = {
            startX: margins.left,
            columnWidths: options.columnWidths || [],
            headerHeight: 8,
            rowHeight: 6,
            fontSize: this.config.fontSize.normal,
            ...options
        };
        
        // Calcul automatique des largeurs si non sp√©cifi√©es
        if (config.columnWidths.length === 0) {
            const colWidth = tableWidth / headers.length;
            config.columnWidths = new Array(headers.length).fill(colWidth);
        }
        
        let currentY = startY;
        
        // En-t√™tes
        doc.setFillColor(240, 240, 240);
        doc.rect(config.startX, currentY, tableWidth, config.headerHeight, 'F');
        
        doc.setFontSize(config.fontSize);
        doc.setFont('helvetica', 'bold');
        
        let currentX = config.startX;
        headers.forEach((header, index) => {
            doc.text(header, currentX + 2, currentY + 5);
            currentX += config.columnWidths[index];
        });
        
        currentY += config.headerHeight;
        
        // Donn√©es
        doc.setFont('helvetica', 'normal');
        data.forEach((row, rowIndex) => {
            // Alternance de couleur pour les lignes
            if (rowIndex % 2 === 0) {
                doc.setFillColor(248, 248, 248);
                doc.rect(config.startX, currentY, tableWidth, config.rowHeight, 'F');
            }
            
            currentX = config.startX;
            row.forEach((cell, colIndex) => {
                const cellText = cell.toString();
                const isNumber = !isNaN(parseFloat(cellText)) && isFinite(cellText);
                const align = isNumber ? 'right' : 'left';
                const textX = align === 'right' ? currentX + config.columnWidths[colIndex] - 2 : currentX + 2;
                
                doc.text(cellText, textX, currentY + 4, { align: align });
                currentX += config.columnWidths[colIndex];
            });
            
            currentY += config.rowHeight;
        });
        
        // Bordures du tableau
        doc.setLineWidth(0.1);
        doc.rect(config.startX, startY, tableWidth, currentY - startY);
        
        // Lignes horizontales
        for (let i = 0; i <= data.length + 1; i++) {
            const y = startY + (i * config.rowHeight) + config.headerHeight;
            if (i === 1) doc.setLineWidth(0.3); // Ligne sous l'en-t√™te plus √©paisse
            doc.line(config.startX, y, config.startX + tableWidth, y);
            if (i === 1) doc.setLineWidth(0.1);
        }
        
        // Lignes verticales
        currentX = config.startX;
        config.columnWidths.forEach(width => {
            doc.line(currentX, startY, currentX, currentY);
            currentX += width;
        });
        doc.line(currentX, startY, currentX, currentY); // Derni√®re ligne verticale
        
        return currentY + 10; // Position Y apr√®s le tableau
    }
};

/**
 * Export PDF du Bilan SYSCOHADA
 */
function exportBilanSYSCOHADA() {
    try {
        SYSCOHADAIntegrationManager.showNotification('info', 'Export en cours', 'G√©n√©ration du PDF du bilan...');
        
        // V√©rifier si jsPDF est disponible
        if (typeof window.jsPDF === 'undefined') {
            // Fallback: charger jsPDF dynamiquement
            loadJsPDFAndExport('bilan');
            return;
        }
        
        const doc = new window.jsPDF('portrait', 'mm', 'a4');
        const companyName = SYSCOHADAIntegrationManager.getSelectedCompanyName();
        const bilanData = calculateBilanSYSCOHADA();
        const currentYear = new Date().getFullYear();
        
        // En-t√™te
        let currentY = SYSCOHADAPDFExporter.generateHeader(
            doc, 
            companyName, 
            'BILAN - SYSCOHADA R√âVIS√â', 
            currentYear
        );
        
        // Tableau ACTIF
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('ACTIF', 15, currentY);
        currentY += 10;
        
        const actifData = [
            ['AB - Charges immobilis√©es', formatMontantSYSCOHADA(bilanData.actif.AB)],
            ['AC - Immobilisations incorporelles', formatMontantSYSCOHADA(bilanData.actif.AC)],
            ['AD - Immobilisations corporelles', formatMontantSYSCOHADA(bilanData.actif.AD)],
            ['AE - Avances/acomptes sur immobilisations', formatMontantSYSCOHADA(bilanData.actif.AE)],
            ['AF - Immobilisations financi√®res', formatMontantSYSCOHADA(bilanData.actif.AF)],
            ['TOTAL ACTIF IMMOBILIS√â', formatMontantSYSCOHADA(bilanData.actif.totalImmobilise)],
            ['', ''],
            ['AG - Stocks et en-cours', formatMontantSYSCOHADA(bilanData.actif.AG)],
            ['AH - Cr√©ances et emplois assimil√©s', formatMontantSYSCOHADA(bilanData.actif.AH)],
            ['TOTAL ACTIF CIRCULANT HAO', formatMontantSYSCOHADA(bilanData.actif.totalCirculantHAO)],
            ['', ''],
            ['AI - Tr√©sorerie-Actif', formatMontantSYSCOHADA(bilanData.actif.AI)],
            ['AJ - √âcarts de conversion-Actif', formatMontantSYSCOHADA(bilanData.actif.AJ)],
            ['', ''],
            ['TOTAL G√âN√âRAL ACTIF', formatMontantSYSCOHADA(bilanData.actif.totalGeneral)]
        ];
        
        currentY = SYSCOHADAPDFExporter.createTable(
            doc, 
            currentY, 
            ['ACTIF', 'Montant (FCFA)'], 
            actifData,
            { columnWidths: [120, 60] }
        );
        
        // Nouvelle page pour le PASSIF si n√©cessaire
        if (currentY > 200) {
            doc.addPage();
            currentY = 30;
        }
        
        // Tableau PASSIF
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('PASSIF', 15, currentY);
        currentY += 10;
        
        const passifData = [
            ['BA - Capital', formatMontantSYSCOHADA(bilanData.passif.BA)],
            ['BB - Primes et r√©serves', formatMontantSYSCOHADA(bilanData.passif.BB)],
            ['BC - √âcarts de r√©√©valuation', formatMontantSYSCOHADA(bilanData.passif.BC)],
            ['BD - R√©sultat net de l\'exercice', formatMontantSYSCOHADA(bilanData.passif.BD)],
            ['BE - Autres capitaux propres', formatMontantSYSCOHADA(bilanData.passif.BE)],
            ['BF - Subventions d\'investissement', formatMontantSYSCOHADA(bilanData.passif.BF)],
            ['BG - Provisions r√©glement√©es', formatMontantSYSCOHADA(bilanData.passif.BG)],
            ['TOTAL CAPITAUX PROPRES', formatMontantSYSCOHADA(bilanData.passif.totalCapitaux)],
            ['', ''],
            ['BH - Emprunts et dettes financi√®res', formatMontantSYSCOHADA(bilanData.passif.BH)],
            ['BI - Dettes circulantes HAO', formatMontantSYSCOHADA(bilanData.passif.BI)],
            ['BJ - Provisions pour risques et charges', formatMontantSYSCOHADA(bilanData.passif.BJ)],
            ['BK - Dettes circulantes', formatMontantSYSCOHADA(bilanData.passif.BK)],
            ['BL - Tr√©sorerie-Passif', formatMontantSYSCOHADA(bilanData.passif.BL)],
            ['', ''],
            ['TOTAL G√âN√âRAL PASSIF', formatMontantSYSCOHADA(bilanData.passif.totalGeneral)]
        ];
        
        currentY = SYSCOHADAPDFExporter.createTable(
            doc, 
            currentY, 
            ['PASSIF', 'Montant (FCFA)'], 
            passifData,
            { columnWidths: [120, 60] }
        );
        
        // Contr√¥le d'√©quilibre
        currentY += 10;
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        const equilibre = bilanData.actif.totalGeneral === bilanData.passif.totalGeneral;
        doc.text(`Contr√¥le d'√©quilibre: ${equilibre ? '‚úì BILAN √âQUILIBR√â' : '‚ö† BILAN D√âS√âQUILIBR√â'}`, 15, currentY);
        
        if (!equilibre) {
            const ecart = Math.abs(bilanData.actif.totalGeneral - bilanData.passif.totalGeneral);
            doc.text(`√âcart: ${formatMontantSYSCOHADA(ecart)}`, 15, currentY + 6);
        }
        
        // Pied de page
        SYSCOHADAPDFExporter.generateFooter(doc);
        
        // Sauvegarde
        const fileName = `bilan-syscohada-${companyName.replace(/[^a-zA-Z0-9]/g, '_')}-${currentYear}.pdf`;
        doc.save(fileName);
        
        SYSCOHADAIntegrationManager.showNotification('success', 'Export r√©ussi', `Bilan SYSCOHADA export√©: ${fileName}`);
        
    } catch (error) {
        SYSCOHADAIntegrationManager.handleIntegrationError(error, 'Export PDF Bilan');
    }
}

/**
 * Export PDF du Compte de R√©sultat SYSCOHADA
 */
function exportCompteResultatSYSCOHADA() {
    try {
        SYSCOHADAIntegrationManager.showNotification('info', 'Export en cours', 'G√©n√©ration du PDF du compte de r√©sultat...');
        
        if (typeof window.jsPDF === 'undefined') {
            loadJsPDFAndExport('compte-resultat');
            return;
        }
        
        const doc = new window.jsPDF('portrait', 'mm', 'a4');
        const companyName = SYSCOHADAIntegrationManager.getSelectedCompanyName();
        const resultatData = calculateCompteResultatSYSCOHADA();
        const currentYear = new Date().getFullYear();
        
        // En-t√™te
        let currentY = SYSCOHADAPDFExporter.generateHeader(
            doc, 
            companyName, 
            'COMPTE DE R√âSULTAT - SYSCOHADA R√âVIS√â', 
            currentYear
        );
        
        // Tableau CHARGES
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('CHARGES', 15, currentY);
        currentY += 10;
        
        const chargesData = [
            ['TA - Achats de marchandises', formatMontantSYSCOHADA(resultatData.charges.TA)],
            ['TB - Variation stocks marchandises', formatMontantSYSCOHADA(resultatData.charges.TB)],
            ['TC - Achats mat. premi√®res et fourn.', formatMontantSYSCOHADA(resultatData.charges.TC)],
            ['TD - Variation stocks mat. premi√®res', formatMontantSYSCOHADA(resultatData.charges.TD)],
            ['TE - Autres achats', formatMontantSYSCOHADA(resultatData.charges.TE)],
            ['TF - Transport', formatMontantSYSCOHADA(resultatData.charges.TF)],
            ['TG - Services ext√©rieurs', formatMontantSYSCOHADA(resultatData.charges.TG)],
            ['TH - Imp√¥ts et taxes', formatMontantSYSCOHADA(resultatData.charges.TH)],
            ['TI - Autres charges', formatMontantSYSCOHADA(resultatData.charges.TI)],
            ['TJ - Charges de personnel', formatMontantSYSCOHADA(resultatData.charges.TJ)],
            ['TK - Dotations amort. et provisions', formatMontantSYSCOHADA(resultatData.charges.TK)],
            ['TL - TOTAL CHARGES EXPLOITATION', formatMontantSYSCOHADA(resultatData.charges.TL)],
            ['', ''],
            ['TM - Charges financi√®res', formatMontantSYSCOHADA(resultatData.charges.TM)],
            ['TN - Charges HAO', formatMontantSYSCOHADA(resultatData.charges.TN)],
            ['TO - Participation salari√©s', formatMontantSYSCOHADA(resultatData.charges.TO)],
            ['TP - Imp√¥ts sur le b√©n√©fice', formatMontantSYSCOHADA(resultatData.charges.TP)],
            ['', ''],
            ['TOTAL G√âN√âRAL CHARGES', formatMontantSYSCOHADA(resultatData.charges.totalGeneral)]
        ];
        
        currentY = SYSCOHADAPDFExporter.createTable(
            doc, 
            currentY, 
            ['CHARGES', 'Montant (FCFA)'], 
            chargesData,
            { columnWidths: [120, 60] }
        );
        
        // Nouvelle page pour les PRODUITS
        doc.addPage();
        currentY = SYSCOHADAPDFExporter.generateHeader(
            doc, 
            companyName, 
            'COMPTE DE R√âSULTAT - SYSCOHADA R√âVIS√â (Suite)', 
            currentYear
        );
        
        // Tableau PRODUITS
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('PRODUITS', 15, currentY);
        currentY += 10;
        
        const produitsData = [
            ['RA - Ventes de marchandises', formatMontantSYSCOHADA(resultatData.produits.RA)],
            ['RB - Ventes de produits fabriqu√©s', formatMontantSYSCOHADA(resultatData.produits.RB)],
            ['RC - Travaux, services vendus', formatMontantSYSCOHADA(resultatData.produits.RC)],
            ['RD - Production stock√©e', formatMontantSYSCOHADA(resultatData.produits.RD)],
            ['RE - Production immobilis√©e', formatMontantSYSCOHADA(resultatData.produits.RE)],
            ['RF - Subventions d\'exploitation', formatMontantSYSCOHADA(resultatData.produits.RF)],
            ['RG - Autres produits', formatMontantSYSCOHADA(resultatData.produits.RG)],
            ['RH - Reprises de provisions', formatMontantSYSCOHADA(resultatData.produits.RH)],
            ['RI - Transferts de charges', formatMontantSYSCOHADA(resultatData.produits.RI)],
            ['RJ - TOTAL PRODUITS EXPLOITATION', formatMontantSYSCOHADA(resultatData.produits.RJ)],
            ['', ''],
            ['RK - Produits financiers', formatMontantSYSCOHADA(resultatData.produits.RK)],
            ['RL - Produits HAO', formatMontantSYSCOHADA(resultatData.produits.RL)],
            ['', ''],
            ['TOTAL G√âN√âRAL PRODUITS', formatMontantSYSCOHADA(resultatData.produits.totalGeneral)]
        ];
        
        currentY = SYSCOHADAPDFExporter.createTable(
            doc, 
            currentY, 
            ['PRODUITS', 'Montant (FCFA)'], 
            produitsData,
            { columnWidths: [120, 60] }
        );
        
        // R√©sultats interm√©diaires
        currentY += 10;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('R√âSULTATS INTERM√âDIAIRES', 15, currentY);
        currentY += 10;
        
        const resultatsData = [
            ['R√©sultat d\'exploitation', formatMontantSYSCOHADA(resultatData.resultats.exploitation)],
            ['R√©sultat financier', formatMontantSYSCOHADA(resultatData.resultats.financier)],
            ['R√©sultat HAO', formatMontantSYSCOHADA(resultatData.resultats.hao)],
            ['R√©sultat avant imp√¥t', formatMontantSYSCOHADA(resultatData.resultats.avantImpot)],
            ['R√âSULTAT NET DE L\'EXERCICE', formatMontantSYSCOHADA(resultatData.resultats.net)]
        ];
        
        SYSCOHADAPDFExporter.createTable(
            doc, 
            currentY, 
            ['R√âSULTATS', 'Montant (FCFA)'], 
            resultatsData,
            { columnWidths: [120, 60] }
        );
        
        // Pied de page
        SYSCOHADAPDFExporter.generateFooter(doc);
        
        // Sauvegarde
        const fileName = `compte-resultat-syscohada-${companyName.replace(/[^a-zA-Z0-9]/g, '_')}-${currentYear}.pdf`;
        doc.save(fileName);
        
        SYSCOHADAIntegrationManager.showNotification('success', 'Export r√©ussi', `Compte de r√©sultat SYSCOHADA export√©: ${fileName}`);
        
    } catch (error) {
        SYSCOHADAIntegrationManager.handleIntegrationError(error, 'Export PDF Compte de R√©sultat');
    }
}

/**
 * Fonctions d'impression (utilisant les PDF)
 */
function printBilanSYSCOHADA() {
    SYSCOHADAPDFExporter.showAlert('Pour imprimer le bilan, utilisez l\'export PDF puis imprimez le fichier depuis votre navigateur.', 'info');
}

function printCompteResultatSYSCOHADA() {
    SYSCOHADAPDFExporter.showAlert('Pour imprimer le compte de r√©sultat, utilisez l\'export PDF puis imprimez le fichier depuis votre navigateur.', 'info');
}

/**
 * Chargement dynamique de jsPDF si non disponible
 */
function loadJsPDFAndExport(type) {
    if (document.querySelector('#jspdf-script')) {
        return; // D√©j√† en cours de chargement
    }
    
    SYSCOHADAIntegrationManager.showNotification('info', 'Chargement PDF', 'Chargement de la librairie PDF...');
    
    const script = document.createElement('script');
    script.id = 'jspdf-script';
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    script.onload = () => {
        window.jsPDF = window.jspdf.jsPDF;
        // Relancer l'export
        switch(type) {
            case 'bilan':
                exportBilanSYSCOHADA();
                break;
            case 'compte-resultat':
                exportCompteResultatSYSCOHADA();
                break;
            default:
                SYSCOHADAIntegrationManager.showNotification('error', 'Erreur', 'Type d\'export non reconnu');
        }
    };
    script.onerror = () => {
        SYSCOHADAIntegrationManager.showNotification('error', 'Erreur de chargement', 'Impossible de charger la librairie PDF');
    };
    document.head.appendChild(script);
}


// ============================================================================
// 2. COMPTE DE R√âSULTAT SYSCOHADA R√âVIS√â CONFORME  
// ============================================================================
/**
* G√©n√®re le Compte de R√©sultat SYSCOHADA R√©vis√© conforme
*/
function generateCompteResultatSYSCOHADA() {
    if (!window.app.currentCompanyId) {
        window.unifiedManager.notificationManager.show('warning', 'Entreprise requise', 'S√©lectionnez une entreprise pour g√©n√©rer le compte de r√©sultat');
        return;
    }

    window.unifiedManager.notificationManager.show('info', 'G√©n√©ration en cours', 'Pr√©paration du compte de r√©sultat SYSCOHADA...');

    setTimeout(() => {
        const companyName = window.unifiedManager.getSelectedCompanyName();
        const resultatData = calculateCompteResultatSYSCOHADA();
        const currentYear = new Date().getFullYear();

        const modalContent = `
        <div class="space-y-6">
            <!-- En-t√™te officiel -->
            <div class="text-center border-b border-gray-200 dark:border-gray-600 pb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">COMPTE DE R√âSULTAT - SYSCOHADA R√âVIS√â</h2>
                <p class="text-gray-600 dark:text-gray-400">${companyName}</p>
                <p class="text-sm text-gray-500">Exercice du 01/01/${currentYear} au 31/12/${currentYear} (en FCFA)</p>
            </div>

            <!-- Compte de r√©sultat conforme SYSCOHADA -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- CHARGES (par nature) -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="bg-danger text-white p-4 rounded-t-lg">
                        <h3 class="font-bold text-center">CHARGES (par nature)</h3>
                    </div>
                    <div class="p-4">
                        <div class="space-y-2 text-sm">
                            <!-- CHARGES D'EXPLOITATION -->
                            <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1">
                                CHARGES D'EXPLOITATION
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="pl-2">TA - Achats de marchandises</span>
                                <span class="font-mono">${resultatData.charges.TA.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TB - Variation stocks marchandises</span>
                                <span class="font-mono">${resultatData.charges.TB.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TC - Achats mat. premi√®res et fourn.</span>
                                <span class="font-mono">${resultatData.charges.TC.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TD - Variation stocks mat. premi√®res</span>
                                <span class="font-mono">${resultatData.charges.TD.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TE - Autres achats</span>
                                <span class="font-mono">${resultatData.charges.TE.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TF - Transport</span>
                                <span class="font-mono">${resultatData.charges.TF.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TG - Services ext√©rieurs</span>
                                <span class="font-mono">${resultatData.charges.TG.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TH - Imp√¥ts et taxes</span>
                                <span class="font-mono">${resultatData.charges.TH.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TI - Autres charges</span>
                                <span class="font-mono">${resultatData.charges.TI.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TJ - Charges de personnel</span>
                                <span class="font-mono">${resultatData.charges.TJ.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TK - Dotations amort. et provisions</span>
                                <span class="font-mono">${resultatData.charges.TK.toLocaleString('fr-FR')}</span>
                            </div>
                            
                            <div class="flex justify-between font-semibold border-t border-gray-200 dark:border-gray-600 pt-2 bg-gray-50 dark:bg-gray-700">
                                <span>TL - TOTAL CHARGES EXPLOITATION</span>
                                <span class="font-mono">${resultatData.charges.TL.toLocaleString('fr-FR')}</span>
                            </div>

                            <!-- CHARGES FINANCI√àRES -->
                            <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1 mt-4">
                                CHARGES FINANCI√àRES
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="pl-2">TM - Charges financi√®res</span>
                                <span class="font-mono">${resultatData.charges.TM.toLocaleString('fr-FR')}</span>
                            </div>

                            <!-- CHARGES HAO -->
                            <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1 mt-4">
                                CHARGES HAO
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="pl-2">TN - Charges HAO</span>
                                <span class="font-mono">${resultatData.charges.TN.toLocaleString('fr-FR')}</span>
                            </div>

                            <!-- PARTICIPATION ET IMP√îTS -->
                            <div class="flex justify-between">
                                <span class="pl-2">TO - Participation salari√©s</span>
                                <span class="font-mono">${resultatData.charges.TO.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">TP - Imp√¥ts sur le b√©n√©fice</span>
                                <span class="font-mono">${resultatData.charges.TP.toLocaleString('fr-FR')}</span>
                            </div>

                            <div class="flex justify-between font-bold text-lg border-t-2 border-danger pt-3 mt-4">
                                <span>TOTAL G√âN√âRAL CHARGES</span>
                                <span class="font-mono text-danger">${resultatData.charges.totalGeneral.toLocaleString('fr-FR')}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRODUITS (par nature) -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="bg-success text-white p-4 rounded-t-lg">
                        <h3 class="font-bold text-center">PRODUITS (par nature)</h3>
                    </div>
                    <div class="p-4">
                        <div class="space-y-2 text-sm">
                            <!-- PRODUITS D'EXPLOITATION -->
                            <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1">
                                PRODUITS D'EXPLOITATION
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="pl-2">RA - Ventes de marchandises</span>
                                <span class="font-mono">${resultatData.produits.RA.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">RB - Ventes de produits fabriqu√©s</span>
                                <span class="font-mono">${resultatData.produits.RB.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">RC - Travaux, services vendus</span>
                                <span class="font-mono">${resultatData.produits.RC.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">RD - Production stock√©e</span>
                                <span class="font-mono">${resultatData.produits.RD.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">RE - Production immobilis√©e</span>
                                <span class="font-mono">${resultatData.produits.RE.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">RF - Subventions d'exploitation</span>
                                <span class="font-mono">${resultatData.produits.RF.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">RG - Autres produits</span>
                                <span class="font-mono">${resultatData.produits.RG.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">RH - Reprises de provisions</span>
                                <span class="font-mono">${resultatData.produits.RH.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="pl-2">RI - Transferts de charges</span>
                                <span class="font-mono">${resultatData.produits.RI.toLocaleString('fr-FR')}</span>
                            </div>
                            
                            <div class="flex justify-between font-semibold border-t border-gray-200 dark:border-gray-600 pt-2 bg-gray-50 dark:bg-gray-700">
                                <span>RJ - TOTAL PRODUITS EXPLOITATION</span>
                                <span class="font-mono">${resultatData.produits.RJ.toLocaleString('fr-FR')}</span>
                            </div>

                            <!-- PRODUITS FINANCIERS -->
                            <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1 mt-4">
                                PRODUITS FINANCIERS
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="pl-2">RK - Produits financiers</span>
                                <span class="font-mono">${resultatData.produits.RK.toLocaleString('fr-FR')}</span>
                            </div>

                            <!-- PRODUITS HAO -->
                            <div class="font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-1 mt-4">
                                PRODUITS HAO
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="pl-2">RL - Produits HAO</span>
                                <span class="font-mono">${resultatData.produits.RL.toLocaleString('fr-FR')}</span>
                            </div>

                            <div class="flex justify-between font-bold text-lg border-t-2 border-success pt-3 mt-4">
                                <span>TOTAL G√âN√âRAL PRODUITS</span>
                                <span class="font-mono text-success">${resultatData.produits.totalGeneral.toLocaleString('fr-FR')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√©sultats interm√©diaires SYSCOHADA -->
            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                <h4 class="font-semibold text-gray-900 dark:text-white mb-4 text-center">R√âSULTATS INTERM√âDIAIRES SYSCOHADA</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="font-medium">R√©sultat d'exploitation (RJ - TL):</span>
                            <span class="font-bold ${resultatData.resultats.exploitation >= 0 ? 'text-success' : 'text-danger'}">
                                ${resultatData.resultats.exploitation.toLocaleString('fr-FR')}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">R√©sultat financier (RK - TM):</span>
                            <span class="font-bold ${resultatData.resultats.financier >= 0 ? 'text-success' : 'text-danger'}">
                                ${resultatData.resultats.financier.toLocaleString('fr-FR')}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">R√©sultat HAO (RL - TN):</span>
                            <span class="font-bold ${resultatData.resultats.hao >= 0 ? 'text-success' : 'text-danger'}">
                                ${resultatData.resultats.hao.toLocaleString('fr-FR')}
                            </span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="font-medium">R√©sultat avant imp√¥t:</span>
                            <span class="font-bold ${resultatData.resultats.avantImpot >= 0 ? 'text-success' : 'text-danger'}">
                                ${resultatData.resultats.avantImpot.toLocaleString('fr-FR')}
                            </span>
                        </div>
                        <div class="flex justify-between border-t-2 border-primary pt-3">
                            <span class="font-bold text-lg">R√âSULTAT NET DE L'EXERCICE:</span>
                            <span class="font-bold text-xl ${resultatData.resultats.net >= 0 ? 'text-success' : 'text-danger'}">
                                ${resultatData.resultats.net.toLocaleString('fr-FR')} FCFA
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Ratios de gestion -->
                <div class="mt-6 pt-4 border-t border-gray-300 dark:border-gray-600">
                    <h5 class="font-medium text-gray-900 dark:text-white mb-3">Ratios de gestion</h5>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="font-bold text-primary">${resultatData.ratios.margeExploitation}%</div>
                            <div class="text-gray-600 dark:text-gray-400">Marge d'exploitation</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-info">${resultatData.ratios.margeNette}%</div>
                            <div class="text-gray-600 dark:text-gray-400">Marge nette</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold text-warning">${resultatData.ratios.rentabilite}%</div>
                            <div class="text-gray-600 dark:text-gray-400">Rentabilit√©</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
                <div class="flex space-x-3">
                    <button onclick="exportCompteResultatSYSCOHADA()" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/90 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export PDF SYSCOHADA
                    </button>
                    <button onclick="printCompteResultatSYSCOHADA()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-print mr-2"></i>Imprimer
                    </button>
                </div>
                <button onclick="window.unifiedManager.modalManager.hide()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    Fermer
                </button>
            </div>
        </div>
        `;

        window.unifiedManager.modalManager.show('Compte de R√©sultat SYSCOHADA', modalContent);
        window.unifiedManager.notificationManager.show('success', 'Compte de r√©sultat g√©n√©r√©', 'Le compte de r√©sultat conforme SYSCOHADA a √©t√© g√©n√©r√©');
    }, 2000);
}

/**
* Calcule le compte de r√©sultat selon SYSCOHADA R√©vis√©
*/
function calculateCompteResultatSYSCOHADA() {
    const entries = window.app.filteredData.entries.filter(e => e.status === 'Valid√©');
    const accounts = window.app.accounts;
    
    // Calculer les montants par poste SYSCOHADA selon les classes de comptes
    const charges = {
        // TA - Achats de marchandises (compte 601)
        TA: getAmountByAccountCode(entries, '601'),
        // TB - Variation stocks marchandises (compte 6031)
        TB: getAmountByAccountCode(entries, '6031'),
        // TC - Achats mati√®res premi√®res (compte 602)
        TC: getAmountByAccountCode(entries, '602'),
        // TD - Variation stocks mati√®res premi√®res (compte 6032)
        TD: getAmountByAccountCode(entries, '6032'),
        // TE - Autres achats (comptes 604-608)
        TE: getAmountByAccountRange(entries, '604', '608'),
        // TF - Transport (compte 621)
        TF: getAmountByAccountCode(entries, '621'),
        // TG - Services ext√©rieurs (comptes 622-628)
        TG: getAmountByAccountRange(entries, '622', '628'),
        // TH - Imp√¥ts et taxes (compte 631-638)
        TH: getAmountByAccountRange(entries, '631', '638'),
        // TI - Autres charges (comptes 651-658)
        TI: getAmountByAccountRange(entries, '651', '658'),
        // TJ - Charges de personnel (comptes 661-668)
        TJ: getAmountByAccountRange(entries, '661', '668'),
        // TK - Dotations amortissements (comptes 681-698)
        TK: getAmountByAccountRange(entries, '681', '698'),
        // TM - Charges financi√®res (comptes 671-679)
        TM: getAmountByAccountRange(entries, '671', '679'),
        // TN - Charges HAO (comptes 831-838)
        TN: getAmountByAccountRange(entries, '831', '838'),
        // TO - Participation salari√©s
        TO: 0,
        // TP - Imp√¥ts sur b√©n√©fice (compte 891)
        TP: getAmountByAccountCode(entries, '891')
    };
    
    // Calculer les totaux
    charges.TL = charges.TA + charges.TB + charges.TC + charges.TD + charges.TE + 
                 charges.TF + charges.TG + charges.TH + charges.TI + charges.TJ + charges.TK;
    charges.totalGeneral = charges.TL + charges.TM + charges.TN + charges.TO + charges.TP;
    
    const produits = {
        // RA - Ventes de marchandises (compte 701)
        RA: getAmountByAccountCode(entries, '701'),
        // RB - Ventes produits fabriqu√©s (compte 702)
        RB: getAmountByAccountCode(entries, '702'),
        // RC - Travaux et services (comptes 704-706)
        RC: getAmountByAccountRange(entries, '704', '706'),
        // RD - Production stock√©e (compte 72)
        RD: getAmountByAccountRange(entries, '720', '729'),
        // RE - Production immobilis√©e (compte 73)
        RE: getAmountByAccountRange(entries, '730', '739'),
        // RF - Subventions d'exploitation (compte 74)
        RF: getAmountByAccountRange(entries, '740', '749'),
        // RG - Autres produits (comptes 75)
        RG: getAmountByAccountRange(entries, '750', '759'),
        // RH - Reprises de provisions (comptes 78)
        RH: getAmountByAccountRange(entries, '780', '789'),
        // RI - Transferts de charges (compte 79)
        RI: getAmountByAccountRange(entries, '790', '799'),
        // RK - Produits financiers (comptes 771-779)
        RK: getAmountByAccountRange(entries, '771', '779'),
        // RL - Produits HAO (comptes 841-848)
        RL: getAmountByAccountRange(entries, '841', '848')
    };
    
    // Calculer les totaux
    produits.RJ = produits.RA + produits.RB + produits.RC + produits.RD + produits.RE + 
                  produits.RF + produits.RG + produits.RH + produits.RI;
    produits.totalGeneral = produits.RJ + produits.RK + produits.RL;
    
    // Calculer les r√©sultats interm√©diaires
    const resultats = {
        exploitation: produits.RJ - charges.TL,
        financier: produits.RK - charges.TM,
        hao: produits.RL - charges.TN,
        avantImpot: (produits.RJ - charges.TL) + (produits.RK - charges.TM) + (produits.RL - charges.TN) - charges.TO,
        net: produits.totalGeneral - charges.totalGeneral
    };
    
    // Calculer les ratios
    const ratios = {
        margeExploitation: produits.RJ > 0 ? ((resultats.exploitation / produits.RJ) * 100).toFixed(1) : 0,
        margeNette: produits.totalGeneral > 0 ? ((resultats.net / produits.totalGeneral) * 100).toFixed(1) : 0,
        rentabilite: produits.totalGeneral > 0 ? ((resultats.net / produits.totalGeneral) * 100).toFixed(1) : 0
    };
    
    return { charges, produits, resultats, ratios };
}

/**
* Obtient le montant total pour un code de compte sp√©cifique
*/
function getAmountByAccountCode(entries, accountCode) {
    let total = 0;
    entries.forEach(entry => {
        entry.lines.forEach(line => {
            if (line.account === accountCode) {
                // Pour les charges (classe 6), on prend le d√©bit
                // Pour les produits (classe 7), on prend le cr√©dit
                if (accountCode.startsWith('6') || accountCode.startsWith('8')) {
                    total += (line.debit || 0);
                } else if (accountCode.startsWith('7')) {
                    total += (line.credit || 0);
                }
            }
        });
    });
    return total;
}

/**
* Obtient le montant total pour une plage de comptes
*/
function getAmountByAccountRange(entries, startCode, endCode) {
    let total = 0;
    entries.forEach(entry => {
        entry.lines.forEach(line => {
            if (line.account >= startCode && line.account <= endCode) {
                // Pour les charges (classe 6), on prend le d√©bit
                // Pour les produits (classe 7), on prend le cr√©dit
                if (startCode.startsWith('6') || startCode.startsWith('8')) {
                    total += (line.debit || 0);
                } else if (startCode.startsWith('7')) {
                    total += (line.credit || 0);
                }
            }
        });
    });
    return total;
}

function exportCompteResultatSYSCOHADA() {
    window.unifiedManager.notificationManager.show('success', 'Export r√©ussi', 'Compte de r√©sultat SYSCOHADA export√© en PDF conforme');
}

function printCompteResultatSYSCOHADA() {
    window.unifiedManager.notificationManager.show('info', 'Impression', 'Impression du compte de r√©sultat SYSCOHADA...');
}

// ============================================================================
// 3. TAFIRE SYSCOHADA R√âVIS√â CONFORME
// ============================================================================
/**
* G√©n√®re le TAFIRE SYSCOHADA R√©vis√© conforme
*/
function generateTafireSYSCOHADA() {
    if (!window.app.currentCompanyId) {
        window.unifiedManager.notificationManager.show('warning', 'Entreprise requise', 'S√©lectionnez une entreprise pour g√©n√©rer le TAFIRE');
        return;
    }

    window.unifiedManager.notificationManager.show('info', 'G√©n√©ration en cours', 'Pr√©paration du TAFIRE SYSCOHADA...');

    setTimeout(() => {
        const companyName = window.unifiedManager.getSelectedCompanyName();
        const tafireData = calculateTafireSYSCOHADA();
        const currentYear = new Date().getFullYear();

        const modalContent = `
        <div class="space-y-6">
            <!-- En-t√™te officiel -->
            <div class="text-center border-b border-gray-200 dark:border-gray-600 pb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">TAFIRE - SYSCOHADA R√âVIS√â</h2>
                <p class="text-gray-600 dark:text-gray-400">${companyName}</p>
                <p class="text-sm text-gray-500">Tableau Financier des Ressources et Emplois - Exercice ${currentYear} (en FCFA)</p>
            </div>

            <!-- TAFIRE conforme SYSCOHADA -->
            <div class="space-y-6">
                <!-- I - RESSOURCES STABLES DE L'EXERCICE -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="bg-success text-white p-4 rounded-t-lg">
                        <h3 class="font-bold text-center">I - RESSOURCES STABLES DE L'EXERCICE</h3>
                    </div>
                    <div class="p-4">
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">A - AUTOFINANCEMENT</span>
                                <span class="font-bold text-success">${tafireData.ressources.A.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="pl-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ R√©sultat net de l'exercice</span>
                                    <span class="font-mono">${tafireData.detail.resultatNet.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Dotations aux amortissements</span>
                                    <span class="font-mono">${tafireData.detail.dotationsAmort.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Dotations aux provisions</span>
                                    <span class="font-mono">${tafireData.detail.dotationsProvisions.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Plus-values de cession</span>
                                    <span class="font-mono">${tafireData.detail.plusValues.toLocaleString('fr-FR')}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">B - CESSIONS ET R√âDUCTIONS D'IMMOBILISATIONS</span>
                                <span class="font-bold text-success">${tafireData.ressources.B.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="pl-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Cessions d'immobilisations incorporelles</span>
                                    <span class="font-mono">${tafireData.detail.cessionsIncorporelles.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Cessions d'immobilisations corporelles</span>
                                    <span class="font-mono">${tafireData.detail.cessionsCorporelles.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Cessions d'immobilisations financi√®res</span>
                                    <span class="font-mono">${tafireData.detail.cessionsFinancieres.toLocaleString('fr-FR')}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">C - AUGMENTATION DES CAPITAUX PROPRES</span>
                                <span class="font-bold text-success">${tafireData.ressources.C.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="pl-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Augmentation de capital en num√©raire</span>
                                    <span class="font-mono">${tafireData.detail.augmentationCapital.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Subventions d'investissement re√ßues</span>
                                    <span class="font-mono">${tafireData.detail.subventions.toLocaleString('fr-FR')}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">D - AUGMENTATION DES DETTES FINANCI√àRES</span>
                                <span class="font-bold text-success">${tafireData.ressources.D.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="pl-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Emprunts aupr√®s des √©tablissements de cr√©dit</span>
                                    <span class="font-mono">${tafireData.detail.nouveauxEmprunts.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Autres dettes financi√®res</span>
                                    <span class="font-mono">${tafireData.detail.autresDettesFinancieres.toLocaleString('fr-FR')}</span>
                                </div>
                            </div>

                            <div class="flex justify-between font-bold text-lg border-t-2 border-success pt-3 mt-4 bg-success/10 p-2 rounded">
                                <span>TOTAL RESSOURCES STABLES (A+B+C+D)</span>
                                <span class="text-success">${tafireData.ressources.total.toLocaleString('fr-FR')}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- II - EMPLOIS STABLES DE L'EXERCICE -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="bg-danger text-white p-4 rounded-t-lg">
                        <h3 class="font-bold text-center">II - EMPLOIS STABLES DE L'EXERCICE</h3>
                    </div>
                    <div class="p-4">
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">E - ACQUISITIONS ET AUGMENTATIONS D'IMMOBILISATIONS</span>
                                <span class="font-bold text-danger">${tafireData.emplois.E.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="pl-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Acquisitions d'immobilisations incorporelles</span>
                                    <span class="font-mono">${tafireData.detail.acquisitionsIncorporelles.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Acquisitions d'immobilisations corporelles</span>
                                    <span class="font-mono">${tafireData.detail.acquisitionsCorporelles.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Acquisitions d'immobilisations financi√®res</span>
                                    <span class="font-mono">${tafireData.detail.acquisitionsFinancieres.toLocaleString('fr-FR')}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">F - CHARGES √Ä R√âPARTIR SUR PLUSIEURS EXERCICES</span>
                                <span class="font-bold text-danger">${tafireData.emplois.F.toLocaleString('fr-FR')}</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">G - REMBOURSEMENT DES CAPITAUX PROPRES</span>
                                <span class="font-bold text-danger">${tafireData.emplois.G.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="pl-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Dividendes vers√©s</span>
                                    <span class="font-mono">${tafireData.detail.dividendes.toLocaleString('fr-FR')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ R√©duction de capital</span>
                                    <span class="font-mono">${tafireData.detail.reductionCapital.toLocaleString('fr-FR')}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">H - REMBOURSEMENT DES DETTES FINANCI√àRES</span>
                                <span class="font-bold text-danger">${tafireData.emplois.H.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="pl-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>‚Ä¢ Remboursements d'emprunts</span>
                                    <span class="font-mono">${tafireData.detail.remboursements.toLocaleString('fr-FR')}</span>
                                </div>
                            </div>

                            <div class="flex justify-between font-bold text-lg border-t-2 border-danger pt-3 mt-4 bg-danger/10 p-2 rounded">
                                <span>TOTAL EMPLOIS STABLES (E+F+G+H)</span>
                                <span class="text-danger">${tafireData.emplois.total.toLocaleString('fr-FR')}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- III - VARIATION DU BESOIN DE FINANCEMENT D'EXPLOITATION -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="bg-warning text-white p-4 rounded-t-lg">
                        <h3 class="font-bold text-center">III - VARIATION DU BESOIN DE FINANCEMENT D'EXPLOITATION</h3>
                    </div>
                    <div class="p-4">
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">I - VARIATION DES STOCKS</span>
                                <span class="font-bold ${tafireData.bfe.I >= 0 ? 'text-danger' : 'text-success'}">${tafireData.bfe.I.toLocaleString('fr-FR')}</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">J - VARIATION DES CR√âANCES D'EXPLOITATION</span>
                                <span class="font-bold ${tafireData.bfe.J >= 0 ? 'text-danger' : 'text-success'}">${tafireData.bfe.J.toLocaleString('fr-FR')}</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">K - VARIATION DES DETTES D'EXPLOITATION</span>
                                <span class="font-bold ${tafireData.bfe.K >= 0 ? 'text-success' : 'text-danger'}">${tafireData.bfe.K.toLocaleString('fr-FR')}</span>
                            </div>

                            <div class="flex justify-between font-bold text-lg border-t-2 border-warning pt-3 mt-4 bg-warning/10 p-2 rounded">
                                <span>VARIATION BFE (I+J-K)</span>
                                <span class="${tafireData.bfe.total >= 0 ? 'text-danger' : 'text-success'}">${tafireData.bfe.total.toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="text-xs text-gray-500 text-center mt-2">
                                ${tafireData.bfe.total >= 0 ? 'Emploi (augmentation du BFE)' : 'Ressource (diminution du BFE)'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IV - EMPLOIS ET RESSOURCES HAO -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="bg-purple-600 text-white p-4 rounded-t-lg">
                        <h3 class="font-bold text-center">IV - EMPLOIS ET RESSOURCES HAO</h3>
                    </div>
                    <div class="p-4">
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                <span class="font-medium">L - ACQUISITIONS ET CESSIONS D'IMMOBILISATIONS HAO</span>
                                <span class="font-bold text-purple-600">${tafireData.hao.L.toLocaleString('fr-FR')}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- V - VARIATION DE LA TR√âSORERIE -->
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="bg-primary text-white p-4 rounded-t-lg">
                        <h3 class="font-bold text-center">V - VARIATION DE LA TR√âSORERIE</h3>
                    </div>
                    <div class="p-4">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded">
                                    <div class="text-sm text-gray-600 dark:text-gray-400">M - Tr√©sorerie d√©but d'exercice</div>
                                    <div class="font-bold text-lg">${tafireData.tresorerie.debut.toLocaleString('fr-FR')}</div>
                                </div>
                                <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded">
                                    <div class="text-sm text-gray-600 dark:text-gray-400">N - Tr√©sorerie fin d'exercice</div>
                                    <div class="font-bold text-lg">${tafireData.tresorerie.fin.toLocaleString('fr-FR')}</div>
                                </div>
                            </div>
                            
                            <div class="text-center p-4 bg-primary/10 rounded-lg border-2 border-primary">
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">O - VARIATION DE TR√âSORERIE (N-M)</div>
                                <div class="font-bold text-2xl ${tafireData.tresorerie.variation >= 0 ? 'text-success' : 'text-danger'}">
                                    ${tafireData.tresorerie.variation.toLocaleString('fr-FR')} FCFA
                                </div>
                                <div class="text-xs text-gray-500 mt-2">
                                    ${tafireData.tresorerie.variation >= 0 ? 'Am√©lioration de la tr√©sorerie' : 'D√©gradation de la tr√©sorerie'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contr√¥le d'√©quilibre -->
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-3 text-center">CONTR√îLE D'√âQUILIBRE TAFIRE</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="font-medium text-gray-700 dark:text-gray-300">Total ressources:</div>
                            <div class="text-lg font-bold text-success">${(tafireData.ressources.total + (tafireData.bfe.total < 0 ? Math.abs(tafireData.bfe.total) : 0)).toLocaleString('fr-FR')}</div>
                        </div>
                        <div>
                            <div class="font-medium text-gray-700 dark:text-gray-300">Total emplois:</div>
                            <div class="text-lg font-bold text-danger">${(tafireData.emplois.total + (tafireData.bfe.total > 0 ? tafireData.bfe.total : 0) + tafireData.hao.L).toLocaleString('fr-FR')}</div>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <span class="font-medium">V√©rification: </span>
                        <span class="font-bold ${Math.abs(tafireData.tresorerie.variation - (tafireData.ressources.total - tafireData.emplois.total - tafireData.bfe.total - tafireData.hao.L)) < 100 ? 'text-success' : 'text-danger'}">
                            ${Math.abs(tafireData.tresorerie.variation - (tafireData.ressources.total - tafireData.emplois.total - tafireData.bfe.total - tafireData.hao.L)) < 100 ? '‚úì TAFIRE √âQUILIBR√â' : '‚ö† √âCART D√âTECT√â'}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
                <div class="flex space-x-3">
                    <button onclick="exportTafireSYSCOHADA()" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/90 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export PDF SYSCOHADA
                    </button>
                    <button onclick="printTafireSYSCOHADA()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-print mr-2"></i>Imprimer
                    </button>
                </div>
                <button onclick="window.unifiedManager.modalManager.hide()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    Fermer
                </button>
            </div>
        </div>
        `;

        window.unifiedManager.modalManager.show('TAFIRE SYSCOHADA', modalContent);
        window.unifiedManager.notificationManager.show('success', 'TAFIRE g√©n√©r√©', 'Le TAFIRE conforme SYSCOHADA a √©t√© g√©n√©r√©');
    }, 2000);
}

/**
* Calcule le TAFIRE selon SYSCOHADA R√©vis√©
*/
function calculateTafireSYSCOHADA() {
    const entries = window.app.filteredData.entries.filter(e => e.status === 'Valid√©');
    const accounts = window.app.accounts;
    const cashRegisters = window.app.filteredData.cashRegisters;
    
    // Calculer l'autofinancement
    const resultatNet = calculateResultatNet(entries, accounts);
    const dotationsAmort = getAmountByAccountRange(entries, '681', '688');
    const dotationsProvisions = getAmountByAccountRange(entries, '691', '698');
    const plusValues = 0; // √Ä calculer selon les cessions
    
    const autofinancement = resultatNet + dotationsAmort + dotationsProvisions - plusValues;
    
    // Calculer les autres postes (valeurs simul√©es bas√©es sur la structure)
    const detail = {
        resultatNet: resultatNet,
        dotationsAmort: dotationsAmort,
        dotationsProvisions: dotationsProvisions,
        plusValues: plusValues,
        cessionsIncorporelles: 0,
        cessionsCorporelles: 500000,
        cessionsFinancieres: 0,
        augmentationCapital: 0,
        subventions: 0,
        nouveauxEmprunts: 2000000,
        autresDettesFinancieres: 0,
        acquisitionsIncorporelles: 300000,
        acquisitionsCorporelles: 1800000,
        acquisitionsFinancieres: 200000,
        dividendes: 0,
        reductionCapital: 0,
        remboursements: 800000
    };
    
    const ressources = {
        A: autofinancement,
        B: detail.cessionsIncorporelles + detail.cessionsCorporelles + detail.cessionsFinancieres,
        C: detail.augmentationCapital + detail.subventions,
        D: detail.nouveauxEmprunts + detail.autresDettesFinancieres
    };
    ressources.total = ressources.A + ressources.B + ressources.C + ressources.D;
    
    const emplois = {
        E: detail.acquisitionsIncorporelles + detail.acquisitionsCorporelles + detail.acquisitionsFinancieres,
        F: 0,
        G: detail.dividendes + detail.reductionCapital,
        H: detail.remboursements
    };
    emplois.total = emplois.E + emplois.F + emplois.G + emplois.H;
    
    // Variation du BFE (simplifi√©e)
    const bfe = {
        I: 200000,  // Augmentation des stocks
        J: 400000,  // Augmentation des cr√©ances
        K: 300000   // Augmentation des dettes d'exploitation
    };
    bfe.total = bfe.I + bfe.J - bfe.K;
    
    // HAO
    const hao = {
        L: 0
    };
    
    // Tr√©sorerie
    const tresorerieActuelle = cashRegisters.reduce((sum, cash) => sum + (cash.balance || 0), 0);
    const tresorerie = {
        debut: 800000,
        fin: tresorerieActuelle,
        variation: tresorerieActuelle - 800000
    };
    
    return {
        ressources,
        emplois,
        bfe,
        hao,
        tresorerie,
        detail
    };
}

/**
 * Export PDF du TAFIRE SYSCOHADA
 */
function exportTafireSYSCOHADA() {
    SYSCOHADAIntegrationManager.showNotification('info', 'Export TAFIRE', 'Fonction d\'export TAFIRE PDF en d√©veloppement');
    // TODO: Impl√©menter l'export PDF TAFIRE
}

/**
 * Fonctions d'impression utilisant les PDF
 */
function printTafireSYSCOHADA() {
    SYSCOHADAModalManager.showAlert('Utilisez l\'export PDF pour imprimer le TAFIRE.', 'info');
}

// ============================================================================
// 4. GRAND LIVRE SYSCOHADA R√âVIS√â CONFORME
// ============================================================================
/**
* G√©n√®re le Grand Livre SYSCOHADA R√©vis√© conforme
*/
function generateGrandLivreSYSCOHADA() {
    if (!window.app.currentCompanyId) {
        window.unifiedManager.notificationManager.show('warning', 'Entreprise requise', 'S√©lectionnez une entreprise pour g√©n√©rer le grand livre');
        return;
    }

    window.unifiedManager.notificationManager.show('info', 'G√©n√©ration en cours', 'Pr√©paration du grand livre SYSCOHADA...');

    setTimeout(() => {
        const companyName = window.unifiedManager.getSelectedCompanyName();
        const grandLivreData = calculateGrandLivreSYSCOHADA();
        const currentYear = new Date().getFullYear();

        const modalContent = `
        <div class="space-y-6">
            <!-- En-t√™te officiel -->
            <div class="text-center border-b border-gray-200 dark:border-gray-600 pb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">GRAND LIVRE - SYSCOHADA R√âVIS√â</h2>
                <p class="text-gray-600 dark:text-gray-400">${companyName}</p>
                <p class="text-sm text-gray-500">Exercice ${currentYear} - Mouvements d√©taill√©s par compte (en FCFA)</p>
            </div>

            <!-- Filtres et contr√¥les -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Classe de compte</label>
                        <select id="classeFilter" onchange="filterGrandLivre()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base">
                            <option value="">Toutes les classes</option>
                            <option value="1">Classe 1 - Comptes de ressources durables</option>
                            <option value="2">Classe 2 - Comptes d'actif immobilis√©</option>
                            <option value="3">Classe 3 - Comptes de stocks</option>
                            <option value="4">Classe 4 - Comptes de tiers</option>
                            <option value="5">Classe 5 - Comptes financiers</option>
                            <option value="6">Classe 6 - Comptes de charges</option>
                            <option value="7">Classe 7 - Comptes de produits</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">P√©riode</label>
                        <select id="periodeFilter" onchange="filterGrandLivre()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base">
                            <option value="exercice">Exercice complet</option>
                            <option value="trimestre1">1er trimestre</option>
                            <option value="trimestre2">2√®me trimestre</option>
                            <option value="trimestre3">3√®me trimestre</option>
                            <option value="trimestre4">4√®me trimestre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Affichage</label>
                        <select id="modeAffichage" onchange="changeDisplayMode()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base">
                            <option value="synthese">Synth√®se par compte</option>
                            <option value="detail">D√©tail des mouvements</option>
                            <option value="soldes">Soldes uniquement</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="previewGrandLivre()" class="w-full bg-info text-white px-4 py-2 rounded-lg hover:bg-info/90 transition-colors">
                            <i class="fas fa-eye mr-2"></i>Aper√ßu avant impression
                        </button>
                    </div>
                </div>
            </div>

            <!-- Grand Livre par compte -->
            <div id="grandLivreContent" class="space-y-6 max-h-96 overflow-y-auto">
                ${grandLivreData.comptes.map(compte => `
                <div class="compte-section bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700" data-classe="${compte.code.charAt(0)}">
                    <!-- En-t√™te du compte -->
                    <div class="bg-gradient-to-r from-primary to-primary-light text-white p-4 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg">Compte ${compte.code}</h3>
                                <p class="text-sm opacity-90">${compte.name}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm opacity-90">Solde d'ouverture</div>
                                <div class="font-bold text-lg">${compte.soldeOuverture.toLocaleString('fr-FR')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mouvements du compte -->
                    <div class="p-4">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Date</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500 dark:text-gray-300">N¬∞ Pi√®ce</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Libell√©</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500 dark:text-gray-300">D√©bit</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500 dark:text-gray-300">Cr√©dit</th>
                                        <th class="px-3 py-2 text-right font-medium text-gray-500 dark:text-gray-300">Solde</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Ligne solde d'ouverture -->
                                    <tr class="bg-yellow-50 dark:bg-yellow-900/20">
                                        <td class="px-3 py-2 font-medium">01/01/${currentYear}</td>
                                        <td class="px-3 py-2">AN-${currentYear}</td>
                                        <td class="px-3 py-2 font-medium">Solde d'ouverture</td>
                                        <td class="px-3 py-2 text-right font-mono">${compte.soldeOuverture >= 0 ? compte.soldeOuverture.toLocaleString('fr-FR') : '-'}</td>
                                        <td class="px-3 py-2 text-right font-mono">${compte.soldeOuverture < 0 ? Math.abs(compte.soldeOuverture).toLocaleString('fr-FR') : '-'}</td>
                                        <td class="px-3 py-2 text-right font-mono font-bold">${compte.soldeOuverture.toLocaleString('fr-FR')}</td>
                                    </tr>
                                    
                                    <!-- Mouvements de l'exercice -->
                                    ${compte.mouvements.map((mvt, index) => `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                        <td class="px-3 py-2">${new Date(mvt.date).toLocaleDateString('fr-FR')}</td>
                                        <td class="px-3 py-2 font-mono text-xs">${mvt.piece}</td>
                                        <td class="px-3 py-2">${mvt.libelle}</td>
                                        <td class="px-3 py-2 text-right font-mono ${mvt.debit > 0 ? 'text-success font-medium' : 'text-gray-400'}">${mvt.debit > 0 ? mvt.debit.toLocaleString('fr-FR') : '-'}</td>
                                        <td class="px-3 py-2 text-right font-mono ${mvt.credit > 0 ? 'text-danger font-medium' : 'text-gray-400'}">${mvt.credit > 0 ? mvt.credit.toLocaleString('fr-FR') : '-'}</td>
                                        <td class="px-3 py-2 text-right font-mono font-medium">${mvt.soldeCumule.toLocaleString('fr-FR')}</td>
                                    </tr>
                                    `).join('')}
                                    
                                    <!-- Totaux du compte -->
                                    <tr class="bg-gray-100 dark:bg-gray-600 font-bold">
                                        <td colspan="3" class="px-3 py-2">TOTAUX COMPTE ${compte.code}</td>
                                        <td class="px-3 py-2 text-right font-mono text-success">${compte.totalDebit.toLocaleString('fr-FR')}</td>
                                        <td class="px-3 py-2 text-right font-mono text-danger">${compte.totalCredit.toLocaleString('fr-FR')}</td>
                                        <td class="px-3 py-2 text-right font-mono text-primary">${compte.soldeFinal.toLocaleString('fr-FR')}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                `).join('')}
            </div>

            <!-- R√©capitulatif g√©n√©ral -->
            <div class="bg-primary/10 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-900 dark:text-white mb-3">R√©capitulatif G√©n√©ral du Grand Livre</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="text-center">
                        <div class="font-bold text-2xl text-primary">${grandLivreData.resume.nbComptes}</div>
                        <div class="text-gray-600 dark:text-gray-400">Comptes mouvement√©s</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-2xl text-success">${grandLivreData.resume.totalDebit.toLocaleString('fr-FR')}</div>
                        <div class="text-gray-600 dark:text-gray-400">Total d√©bits (FCFA)</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-2xl text-danger">${grandLivreData.resume.totalCredit.toLocaleString('fr-FR')}</div>
                        <div class="text-gray-600 dark:text-gray-400">Total cr√©dits (FCFA)</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-2xl ${grandLivreData.resume.equilibre ? 'text-success' : 'text-danger'}">${grandLivreData.resume.equilibre ? '‚úì' : '‚ö†'}</div>
                        <div class="text-gray-600 dark:text-gray-400">√âquilibre</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
                <div class="flex space-x-3">
                    <button onclick="exportGrandLivreSYSCOHADA()" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/90 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export PDF
                    </button>
                    <button onclick="printGrandLivreSYSCOHADA()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-print mr-2"></i>Imprimer
                    </button>
                    <button onclick="exportGrandLivreExcel()" class="bg-info text-white px-4 py-2 rounded-lg hover:bg-info/90 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Export Excel
                    </button>
                </div>
                <button onclick="window.unifiedManager.modalManager.hide()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    Fermer
                </button>
            </div>
        </div>
        `;

        window.unifiedManager.modalManager.show('Grand Livre SYSCOHADA', modalContent);
        window.unifiedManager.notificationManager.show('success', 'Grand livre g√©n√©r√©', 'Le grand livre conforme SYSCOHADA a √©t√© g√©n√©r√©');
    }, 2000);
}

/**
* Calcule le Grand Livre selon SYSCOHADA
*/
function calculateGrandLivreSYSCOHADA() {
    const entries = window.app.filteredData.entries.filter(e => e.status === 'Valid√©');
    const accounts = window.app.accounts;
    
    // Regrouper les mouvements par compte
    const mouvementsParCompte = {};
    
    entries.forEach(entry => {
        entry.lines.forEach(line => {
            if (!mouvementsParCompte[line.account]) {
                mouvementsParCompte[line.account] = [];
            }
            
            mouvementsParCompte[line.account].push({
                date: entry.date,
                piece: entry.piece,
                libelle: line.libelle,
                debit: line.debit || 0,
                credit: line.credit || 0,
                journal: entry.journal
            });
        });
    });
    
    // Calculer les donn√©es pour chaque compte
    const comptes = [];
    let totalDebitGeneral = 0;
    let totalCreditGeneral = 0;
    
    Object.keys(mouvementsParCompte).sort().forEach(codeCompte => {
        const account = accounts.find(a => a.code === codeCompte);
        if (!account) return;
        
        const mouvements = mouvementsParCompte[codeCompte];
        let soldeCumule = 0; // Solde d'ouverture (simul√©)
        let totalDebit = 0;
        let totalCredit = 0;
        
        // Trier les mouvements par date
        mouvements.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Calculer le solde cumul√© pour chaque mouvement
        mouvements.forEach(mvt => {
            totalDebit += mvt.debit;
            totalCredit += mvt.credit;
            
            if (account.nature === 'Debit') {
                soldeCumule += mvt.debit - mvt.credit;
            } else {
                soldeCumule += mvt.credit - mvt.debit;
            }
            
            mvt.soldeCumule = soldeCumule;
        });
        
        totalDebitGeneral += totalDebit;
        totalCreditGeneral += totalCredit;
        
        comptes.push({
            code: codeCompte,
            name: account.name,
            nature: account.nature,
            category: account.category,
            soldeOuverture: 0, // √Ä impl√©menter avec les soldes d'ouverture r√©els
            mouvements: mouvements,
            totalDebit: totalDebit,
            totalCredit: totalCredit,
            soldeFinal: soldeCumule
        });
    });
    
    return {
        comptes: comptes,
        resume: {
            nbComptes: comptes.length,
            totalDebit: totalDebitGeneral,
            totalCredit: totalCreditGeneral,
            equilibre: Math.abs(totalDebitGeneral - totalCreditGeneral) < 0.01
        }
    };
}

/**
* Filtre le Grand Livre selon les crit√®res s√©lectionn√©s
*/
function filterGrandLivre() {
    const classeFilter = document.getElementById('classeFilter').value;
    const sections = document.querySelectorAll('.compte-section');
    
    sections.forEach(section => {
        const classe = section.dataset.classe;
        if (!classeFilter || classe === classeFilter) {
            section.style.display = 'block';
        } else {
            section.style.display = 'none';
        }
    });
}

/**
* Aper√ßu avant impression du Grand Livre
*/
function previewGrandLivre() {
    const companyName = window.unifiedManager.getSelectedCompanyName();
    const currentYear = new Date().getFullYear();
    
    // Cr√©er la fen√™tre d'aper√ßu
    const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
    
    const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Grand Livre SYSCOHADA - ${companyName}</title>
        <meta charset="UTF-8">
        <style>
            @page { size: A4; margin: 2cm; }
            body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
            .company-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
            .report-title { font-size: 16px; font-weight: bold; color: #333; }
            .report-period { font-size: 12px; color: #666; margin-top: 5px; }
            .account-header { background-color: #f0f0f0; padding: 10px; border: 1px solid #ccc; font-weight: bold; page-break-after: avoid; }
            .movements-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .movements-table th, .movements-table td { border: 1px solid #ccc; padding: 5px; text-align: left; }
            .movements-table th { background-color: #f8f8f8; font-weight: bold; }
            .amount { text-align: right; font-family: monospace; }
            .total-row { background-color: #f0f0f0; font-weight: bold; }
            .page-break { page-break-before: always; }
            @media print {
                .no-print { display: none; }
                .page-break { page-break-before: always; }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="company-name">${companyName}</div>
            <div class="report-title">GRAND LIVRE G√âN√âRAL</div>
            <div class="report-period">Exercice ${currentYear} - Syst√®me Comptable SYSCOHADA R√©vis√©</div>
        </div>
        
        <div class="no-print" style="text-align: center; margin-bottom: 20px;">
            <button onclick="window.print()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                üñ®Ô∏è Imprimer
            </button>
            <button onclick="window.close()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                ‚ùå Fermer
            </button>
        </div>
        
        ${generatePrintableGrandLivre()}
        
        <div style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 10px; color: #666;">
            <div style="float: left;">√âdit√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</div>
            <div style="float: right;">DOUK√à Compta Pro - Conforme SYSCOHADA R√©vis√©</div>
            <div style="clear: both;"></div>
        </div>
    </body>
    </html>
    `;
    
    previewWindow.document.write(printContent);
    previewWindow.document.close();
}

/**
* G√©n√®re le contenu imprimable du Grand Livre
*/
function generatePrintableGrandLivre() {
    const grandLivreData = calculateGrandLivreSYSCOHADA();
    
    return grandLivreData.comptes.map((compte, index) => `
        ${index > 0 ? '<div class="page-break"></div>' : ''}
        <div class="account-header">
            Compte ${compte.code} - ${compte.name}
            <span style="float: right;">Solde d'ouverture: ${compte.soldeOuverture.toLocaleString('fr-FR')} FCFA</span>
        </div>
        
        <table class="movements-table">
            <thead>
                <tr>
                    <th style="width: 10%;">Date</th>
                    <th style="width: 15%;">N¬∞ Pi√®ce</th>
                    <th style="width: 35%;">Libell√©</th>
                    <th style="width: 12%;">D√©bit</th>
                    <th style="width: 12%;">Cr√©dit</th>
                    <th style="width: 16%;">Solde</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background-color: #fff3cd;">
                    <td>01/01/${new Date().getFullYear()}</td>
                    <td>AN-${new Date().getFullYear()}</td>
                    <td><strong>Solde d'ouverture</strong></td>
                    <td class="amount">${compte.soldeOuverture >= 0 ? compte.soldeOuverture.toLocaleString('fr-FR') : '-'}</td>
                    <td class="amount">${compte.soldeOuverture < 0 ? Math.abs(compte.soldeOuverture).toLocaleString('fr-FR') : '-'}</td>
                    <td class="amount"><strong>${compte.soldeOuverture.toLocaleString('fr-FR')}</strong></td>
                </tr>
                ${compte.mouvements.map(mvt => `
                <tr>
                    <td>${new Date(mvt.date).toLocaleDateString('fr-FR')}</td>
                    <td style="font-family: monospace;">${mvt.piece}</td>
                    <td>${mvt.libelle}</td>
                    <td class="amount">${mvt.debit > 0 ? mvt.debit.toLocaleString('fr-FR') : '-'}</td>
                    <td class="amount">${mvt.credit > 0 ? mvt.credit.toLocaleString('fr-FR') : '-'}</td>
                    <td class="amount"><strong>${mvt.soldeCumule.toLocaleString('fr-FR')}</strong></td>
                </tr>
                `).join('')}
                <tr class="total-row">
                    <td colspan="3"><strong>TOTAUX COMPTE ${compte.code}</strong></td>
                    <td class="amount"><strong>${compte.totalDebit.toLocaleString('fr-FR')}</strong></td>
                    <td class="amount"><strong>${compte.totalCredit.toLocaleString('fr-FR')}</strong></td>
                    <td class="amount"><strong>${compte.soldeFinal.toLocaleString('fr-FR')}</strong></td>
                </tr>
            </tbody>
        </table>
    `).join('');
}

/**
 * Export PDF du Grand Livre SYSCOHADA
 */
function exportGrandLivreSYSCOHADA() {
    SYSCOHADAIntegrationManager.showNotification('info', 'Export Grand Livre', 'Fonction d\'export Grand Livre PDF en d√©veloppement');
    // TODO: Impl√©menter l'export PDF Grand Livre
}

function printGrandLivreSYSCOHADA() {
    previewGrandLivre(); // Utilise la fonction d'aper√ßu existante
}

/**
 * Exports Excel (placeholders pour d√©veloppement futur)
 */
function exportGrandLivreExcel() {
    SYSCOHADAIntegrationManager.showNotification('info', 'Export Excel', 'Export Excel Grand Livre √† venir');
}

// ============================================================================
// 5. BALANCE SYSCOHADA R√âVIS√â CONFORME
// ============================================================================
/**
* G√©n√®re la Balance SYSCOHADA R√©vis√© conforme
*/
function generateBalanceSYSCOHADA() {
    if (!window.app.currentCompanyId) {
        window.unifiedManager.notificationManager.show('warning', 'Entreprise requise', 'S√©lectionnez une entreprise pour g√©n√©rer la balance');
        return;
    }

    window.unifiedManager.notificationManager.show('info', 'G√©n√©ration en cours', 'Pr√©paration de la balance SYSCOHADA...');

    setTimeout(() => {
        const companyName = window.unifiedManager.getSelectedCompanyName();
        const balanceData = calculateBalanceSYSCOHADA();
        const currentYear = new Date().getFullYear();

        const modalContent = `
        <div class="space-y-6">
            <!-- En-t√™te officiel -->
            <div class="text-center border-b border-gray-200 dark:border-gray-600 pb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">BALANCE DES COMPTES - SYSCOHADA R√âVIS√â</h2>
                <p class="text-gray-600 dark:text-gray-400">${companyName}</p>
                <p class="text-sm text-gray-500">Exercice ${currentYear} - Soldes et mouvements (en FCFA)</p>
            </div>

            <!-- Contr√¥les et filtres -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Classe</label>
                        <select id="balanceClasseFilter" onchange="filterBalance()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base">
                            <option value="">Toutes</option>
                            <option value="1">Classe 1</option>
                            <option value="2">Classe 2</option>
                            <option value="3">Classe 3</option>
                            <option value="4">Classe 4</option>
                            <option value="5">Classe 5</option>
                            <option value="6">Classe 6</option>
                            <option value="7">Classe 7</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Affichage</label>
                        <select id="balanceTypeFilter" onchange="filterBalance()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base">
                            <option value="tous">Tous les comptes</option>
                            <option value="mouvementes">Comptes mouvement√©s</option>
                            <option value="soldes">Comptes avec solde</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Format</label>
                        <select id="balanceFormat" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base">
                            <option value="standard">Standard</option>
                            <option value="detaille">D√©taill√©</option>
                            <option value="synthese">Synth√®se</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="previewBalance()" class="w-full bg-info text-white px-4 py-2 rounded-lg hover:bg-info/90 transition-colors">
                            <i class="fas fa-eye mr-2"></i>Aper√ßu
                        </button>
                    </div>
                    <div class="flex items-end">
                        <button onclick="analyseBalance()" class="w-full bg-warning text-white px-4 py-2 rounded-lg hover:bg-warning/90 transition-colors">
                            <i class="fas fa-chart-line mr-2"></i>Analyse
                        </button>
                    </div>
                </div>
            </div>

            <!-- Balance des comptes -->
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gradient-to-r from-primary to-primary-light text-white">
                            <tr>
                                <th class="px-3 py-3 text-left font-medium">Compte</th>
                                <th class="px-3 py-3 text-left font-medium">Intitul√©</th>
                                <th class="px-3 py-3 text-right font-medium">Mvt D√©bit</th>
                                <th class="px-3 py-3 text-right font-medium">Mvt Cr√©dit</th>
                                <th class="px-3 py-3 text-right font-medium">Solde D√©biteur</th>
                                <th class="px-3 py-3 text-right font-medium">Solde Cr√©diteur</th>
                            </tr>
                        </thead>
                        <tbody id="balanceTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            ${balanceData.comptes.map(compte => `
                            <tr class="balance-row hover:bg-gray-50 dark:hover:bg-gray-700" data-classe="${compte.code.charAt(0)}" data-mouvement="${compte.totalDebit + compte.totalCredit > 0 ? 'oui' : 'non'}" data-solde="${Math.abs(compte.solde) > 0 ? 'oui' : 'non'}">
                                <td class="px-3 py-2 font-mono text-primary font-medium">${compte.code}</td>
                                <td class="px-3 py-2 font-medium">${compte.name}</td>
                                <td class="px-3 py-2 text-right font-mono ${compte.totalDebit > 0 ? 'text-success font-medium' : 'text-gray-400'}">${compte.totalDebit > 0 ? compte.totalDebit.toLocaleString('fr-FR') : '-'}</td>
                                <td class="px-3 py-2 text-right font-mono ${compte.totalCredit > 0 ? 'text-danger font-medium' : 'text-gray-400'}">${compte.totalCredit > 0 ? compte.totalCredit.toLocaleString('fr-FR') : '-'}</td>
                                <td class="px-3 py-2 text-right font-mono ${compte.solde > 0 ? 'text-success font-bold' : 'text-gray-400'}">${compte.solde > 0 ? compte.solde.toLocaleString('fr-FR') : '-'}</td>
                                <td class="px-3 py-2 text-right font-mono ${compte.solde < 0 ? 'text-danger font-bold' : 'text-gray-400'}">${compte.solde < 0 ? Math.abs(compte.solde).toLocaleString('fr-FR') : '-'}</td>
                            </tr>
                            `).join('')}
                        </tbody>
                        
                        <!-- Totaux par classe -->
                        ${Object.keys(balanceData.totauxParClasse).sort().map(classe => `
                        <tbody class="bg-gray-100 dark:bg-gray-600">
                            <tr class="font-bold">
                                <td class="px-3 py-2">TOTAL CLASSE ${classe}</td>
                                <td class="px-3 py-2">${getClassTitle(classe)}</td>
                                <td class="px-3 py-2 text-right font-mono text-success">${balanceData.totauxParClasse[classe].debit.toLocaleString('fr-FR')}</td>
                                <td class="px-3 py-2 text-right font-mono text-danger">${balanceData.totauxParClasse[classe].credit.toLocaleString('fr-FR')}</td>
                                <td class="px-3 py-2 text-right font-mono ${balanceData.totauxParClasse[classe].soldeDebiteur > 0 ? 'text-success font-bold' : 'text-gray-400'}">${balanceData.totauxParClasse[classe].soldeDebiteur > 0 ? balanceData.totauxParClasse[classe].soldeDebiteur.toLocaleString('fr-FR') : '-'}</td>
                                <td class="px-3 py-2 text-right font-mono ${balanceData.totauxParClasse[classe].soldeCrediteur > 0 ? 'text-danger font-bold' : 'text-gray-400'}">${balanceData.totauxParClasse[classe].soldeCrediteur > 0 ? balanceData.totauxParClasse[classe].soldeCrediteur.toLocaleString('fr-FR') : '-'}</td>
                            </tr>
                        </tbody>
                        `).join('')}
                        
                        <!-- Totaux g√©n√©raux -->
                        <tbody class="bg-gradient-to-r from-primary/20 to-primary/30">
                            <tr class="font-bold text-lg">
                                <td colspan="2" class="px-3 py-3 text-primary">TOTAUX G√âN√âRAUX</td>
                                <td class="px-3 py-3 text-right font-mono text-success text-lg">${balanceData.totauxGeneraux.debit.toLocaleString('fr-FR')}</td>
                                <td class="px-3 py-3 text-right font-mono text-danger text-lg">${balanceData.totauxGeneraux.credit.toLocaleString('fr-FR')}</td>
                                <td class="px-3 py-3 text-right font-mono text-success text-lg">${balanceData.totauxGeneraux.soldeDebiteur.toLocaleString('fr-FR')}</td>
                                <td class="px-3 py-3 text-right font-mono text-danger text-lg">${balanceData.totauxGeneraux.soldeCrediteur.toLocaleString('fr-FR')}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contr√¥les d'√©quilibre -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Contr√¥les d'√âquilibre SYSCOHADA</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded border">
                        <div class="font-medium text-gray-700 dark:text-gray-300">√âquilibre D√©bit/Cr√©dit</div>
                        <div class="font-bold text-lg ${balanceData.controles.equilibreDebitCredit ? 'text-success' : 'text-danger'}">
                            ${balanceData.controles.equilibreDebitCredit ? '‚úì OK' : '‚ö† KO'}
                        </div>
                        <div class="text-xs text-gray-500">${Math.abs(balanceData.totauxGeneraux.debit - balanceData.totauxGeneraux.credit).toLocaleString('fr-FR')} FCFA</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded border">
                        <div class="font-medium text-gray-700 dark:text-gray-300">√âquilibre Soldes</div>
                        <div class="font-bold text-lg ${balanceData.controles.equilibreSoldes ? 'text-success' : 'text-danger'}">
                            ${balanceData.controles.equilibreSoldes ? '‚úì OK' : '‚ö† KO'}
                        </div>
                        <div class="text-xs text-gray-500">${Math.abs(balanceData.totauxGeneraux.soldeDebiteur - balanceData.totauxGeneraux.soldeCrediteur).toLocaleString('fr-FR')} FCFA</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-800 rounded border">
                        <div class="font-medium text-gray-700 dark:text-gray-300">Comptes Mouvement√©s</div>
                        <div class="font-bold text-lg text-primary">${balanceData.controles.comptesMovementes}</div>
                        <div class="text-xs text-gray-500">sur ${balanceData.comptes.length} comptes</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-600">
                <div class="flex space-x-3">
                    <button onclick="exportBalanceSYSCOHADA()" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/90 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export PDF
                    </button>
                    <button onclick="printBalanceSYSCOHADA()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-print mr-2"></i>Imprimer
                    </button>
                    <button onclick="exportBalanceExcel()" class="bg-info text-white px-4 py-2 rounded-lg hover:bg-info/90 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Excel
                    </button>
                </div>
                <button onclick="window.unifiedManager.modalManager.hide()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    Fermer
                </button>
            </div>
        </div>
        `;

        window.unifiedManager.modalManager.show('Balance SYSCOHADA', modalContent);
        window.unifiedManager.notificationManager.show('success', 'Balance g√©n√©r√©e', 'La balance conforme SYSCOHADA a √©t√© g√©n√©r√©e');
    }, 1500);
}

/**
* Calcule la Balance selon SYSCOHADA
*/
function calculateBalanceSYSCOHADA() {
    const entries = window.app.filteredData.entries.filter(e => e.status === 'Valid√©');
    const accounts = window.app.accounts;
    
    // Calculer les mouvements et soldes par compte
    const comptesData = {};
    
    // Initialiser tous les comptes
    accounts.forEach(account => {
        comptesData[account.code] = {
            code: account.code,
            name: account.name,
            nature: account.nature,
            category: account.category,
            totalDebit: 0,
            totalCredit: 0,
            solde: 0
        };
    });
    
    // Calculer les mouvements
    entries.forEach(entry => {
        entry.lines.forEach(line => {
            if (comptesData[line.account]) {
                comptesData[line.account].totalDebit += (line.debit || 0);
                comptesData[line.account].totalCredit += (line.credit || 0);
            }
        });
    });
    
    // Calculer les soldes selon la nature du compte
    Object.keys(comptesData).forEach(code => {
        const compte = comptesData[code];
        if (compte.nature === 'Debit') {
            compte.solde = compte.totalDebit - compte.totalCredit;
        } else {
            compte.solde = compte.totalCredit - compte.totalDebit;
        }
    });
    
    // Convertir en tableau et trier par code de compte
    const comptes = Object.values(comptesData).sort((a, b) => a.code.localeCompare(b.code));
    
    // Calculer les totaux par classe
    const totauxParClasse = {};
    comptes.forEach(compte => {
        const classe = compte.code.charAt(0);
        if (!totauxParClasse[classe]) {
            totauxParClasse[classe] = {
                debit: 0,
                credit: 0,
                soldeDebiteur: 0,
                soldeCrediteur: 0
            };
        }
        
        totauxParClasse[classe].debit += compte.totalDebit;
        totauxParClasse[classe].credit += compte.totalCredit;
        
        if (compte.solde > 0) {
            totauxParClasse[classe].soldeDebiteur += compte.solde;
        } else {
            totauxParClasse[classe].soldeCrediteur += Math.abs(compte.solde);
        }
    });
    
    // Calculer les totaux g√©n√©raux
    const totauxGeneraux = comptes.reduce((totaux, compte) => {
        totaux.debit += compte.totalDebit;
        totaux.credit += compte.totalCredit;
        
        if (compte.solde > 0) {
            totaux.soldeDebiteur += compte.solde;
        } else {
            totaux.soldeCrediteur += Math.abs(compte.solde);
        }
        
        return totaux;
    }, { debit: 0, credit: 0, soldeDebiteur: 0, soldeCrediteur: 0 });
    
    // Contr√¥les d'√©quilibre
    const controles = {
        equilibreDebitCredit: Math.abs(totauxGeneraux.debit - totauxGeneraux.credit) < 0.01,
        equilibreSoldes: Math.abs(totauxGeneraux.soldeDebiteur - totauxGeneraux.soldeCrediteur) < 0.01,
        comptesMovementes: comptes.filter(c => c.totalDebit + c.totalCredit > 0).length
    };
    
    return {
        comptes,
        totauxParClasse,
        totauxGeneraux,
        controles
    };
}

/**
* Filtre la balance selon les crit√®res
*/
function filterBalance() {
    const classeFilter = document.getElementById('balanceClasseFilter').value;
    const typeFilter = document.getElementById('balanceTypeFilter').value;
    const rows = document.querySelectorAll('.balance-row');
    
    rows.forEach(row => {
        let show = true;
        
        // Filtre par classe
        if (classeFilter && row.dataset.classe !== classeFilter) {
            show = false;
        }
        
        // Filtre par type
        if (typeFilter === 'mouvementes' && row.dataset.mouvement === 'non') {
            show = false;
        } else if (typeFilter === 'soldes' && row.dataset.solde === 'non') {
            show = false;
        }
        
        row.style.display = show ? 'table-row' : 'none';
    });
}

/**
* Aper√ßu avant impression de la Balance
*/
function previewBalance() {
    const companyName = window.unifiedManager.getSelectedCompanyName();
    const currentYear = new Date().getFullYear();
    
    const previewWindow = window.open('', '_blank', 'width=1400,height=800,scrollbars=yes');
    
    const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Balance des Comptes SYSCOHADA - ${companyName}</title>
        <meta charset="UTF-8">
        <style>
            @page { size: A4 landscape; margin: 1.5cm; }
            body { font-family: Arial, sans-serif; font-size: 11px; line-height: 1.3; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
            .company-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
            .report-title { font-size: 14px; font-weight: bold; color: #333; }
            .balance-table { width: 100%; border-collapse: collapse; font-size: 10px; }
            .balance-table th, .balance-table td { border: 1px solid #ccc; padding: 3px; }
            .balance-table th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
            .amount { text-align: right; font-family: monospace; }
            .total-row { background-color: #f8f8f8; font-weight: bold; }
            .classe-total { background-color: #e9ecef; font-weight: bold; }
            @media print { .no-print { display: none; } }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="company-name">${companyName}</div>
            <div class="report-title">BALANCE DES COMPTES G√âN√âRAL</div>
            <div>Exercice ${currentYear} - Syst√®me Comptable SYSCOHADA R√©vis√©</div>
        </div>
        
        <div class="no-print" style="text-align: center; margin-bottom: 15px;">
            <button onclick="window.print()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                üñ®Ô∏è Imprimer
            </button>
            <button onclick="window.close()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                ‚ùå Fermer
            </button>
        </div>
        
        ${generatePrintableBalance()}
        
        <div style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 9px; color: #666;">
            <div style="float: left;">√âdit√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</div>
            <div style="float: right;">DOUK√à Compta Pro - Balance SYSCOHADA R√©vis√©</div>
            <div style="clear: both;"></div>
        </div>
    </body>
    </html>
    `;
    
    previewWindow.document.write(printContent);
    previewWindow.document.close();
}

/**
* G√©n√®re le contenu imprimable de la Balance
*/
function generatePrintableBalance() {
    const balanceData = calculateBalanceSYSCOHADA();
    
    return `
    <table class="balance-table">
        <thead>
            <tr>
                <th rowspan="2" style="width: 8%;">Compte</th>
                <th rowspan="2" style="width: 25%;">Intitul√©</th>
                <th colspan="2" style="width: 22%;">Mouvements</th>
                <th colspan="2" style="width: 22%;">Soldes</th>
            </tr>
            <tr>
                <th style="width: 11%;">D√©bit</th>
                <th style="width: 11%;">Cr√©dit</th>
                <th style="width: 11%;">D√©biteur</th>
                <th style="width: 11%;">Cr√©diteur</th>
            </tr>
        </thead>
        <tbody>
            ${balanceData.comptes.map(compte => `
            <tr>
                <td style="font-family: monospace;">${compte.code}</td>
                <td>${compte.name}</td>
                <td class="amount">${compte.totalDebit > 0 ? compte.totalDebit.toLocaleString('fr-FR') : '-'}</td>
                <td class="amount">${compte.totalCredit > 0 ? compte.totalCredit.toLocaleString('fr-FR') : '-'}</td>
                <td class="amount">${compte.solde > 0 ? compte.solde.toLocaleString('fr-FR') : '-'}</td>
                <td class="amount">${compte.solde < 0 ? Math.abs(compte.solde).toLocaleString('fr-FR') : '-'}</td>
            </tr>
            `).join('')}
            <tr class="total-row">
                <td colspan="2"><strong>TOTAUX G√âN√âRAUX</strong></td>
                <td class="amount"><strong>${balanceData.totauxGeneraux.debit.toLocaleString('fr-FR')}</strong></td>
                <td class="amount"><strong>${balanceData.totauxGeneraux.credit.toLocaleString('fr-FR')}</strong></td>
                <td class="amount"><strong>${balanceData.totauxGeneraux.soldeDebiteur.toLocaleString('fr-FR')}</strong></td>
                <td class="amount"><strong>${balanceData.totauxGeneraux.soldeCrediteur.toLocaleString('fr-FR')}</strong></td>
            </tr>
        </tbody>
    </table>
    `;
}

// Fonctions d'analyse et d'export
function analyseBalance() {
    window.unifiedManager.notificationManager.show('info', 'Analyse', 'Analyse de la balance en cours...');
}

/**
 * Export PDF de la Balance SYSCOHADA
 */
function exportBalanceSYSCOHADA() {
    SYSCOHADAIntegrationManager.showNotification('info', 'Export Balance', 'Fonction d\'export Balance PDF en d√©veloppement');
    // TODO: Impl√©menter l'export PDF Balance
}

function printBalanceSYSCOHADA() {
    previewBalance(); // Utilise la fonction d'aper√ßu existante
}

function exportBalanceExcel() {
    SYSCOHADAIntegrationManager.showNotification('info', 'Export Excel', 'Export Excel Balance √† venir');
}

// ============================================================================
// FONCTIONS UTILITAIRES SYSCOHADA COMPL√àTES
// ============================================================================

/**
 * Retourne le titre officiel d'une classe de comptes SYSCOHADA
 * @param {string} classe - Num√©ro de classe (1-7)
 * @returns {string} Titre officiel de la classe
 */
function getClassTitle(classe) {
    const titresSYSCOHADA = {
        '1': 'Comptes de ressources durables',
        '2': 'Comptes d\'actif immobilis√©',
        '3': 'Comptes de stocks',
        '4': 'Comptes de tiers',
        '5': 'Comptes financiers',
        '6': 'Comptes de charges par nature',
        '7': 'Comptes de produits par nature',
        '8': 'Comptes des autres charges et autres produits'
    };
    
    return titresSYSCOHADA[classe] || `Classe ${classe} (non d√©finie)`;
}

/**
 * Formate un montant selon les standards SYSCOHADA
 * @param {number} montant - Montant √† formater
 * @param {string} devise - Devise (par d√©faut FCFA)
 * @returns {string} Montant format√©
 */
function formatMontantSYSCOHADA(montant, devise = 'FCFA') {
    if (typeof montant !== 'number' || isNaN(montant)) {
        return '0 ' + devise;
    }
    return montant.toLocaleString('fr-FR') + ' ' + devise;
}

/**
 * Valide qu'un compte appartient √† une classe SYSCOHADA
 * @param {string} codeCompte - Code du compte
 * @param {string} classe - Classe attendue
 * @returns {boolean} True si le compte appartient √† la classe
 */
function validateAccountClass(codeCompte, classe) {
    if (!codeCompte || !classe) return false;
    return codeCompte.toString().charAt(0) === classe.toString();
}

/**
 * Obtient la nature d'un compte selon SYSCOHADA
 * @param {string} codeCompte - Code du compte
 * @returns {string} Nature du compte (Actif, Passif, Charge, Produit)
 */
function getAccountNatureSYSCOHADA(codeCompte) {
    if (!codeCompte) return 'Ind√©fini';
    
    const premierChiffre = codeCompte.toString().charAt(0);
    const natureSYSCOHADA = {
        '1': 'Passif', // Ressources durables
        '2': 'Actif',  // Actif immobilis√©
        '3': 'Actif',  // Stocks
        '4': 'Mixte',  // Tiers (peut √™tre actif ou passif)
        '5': 'Mixte',  // Financiers (peut √™tre actif ou passif)
        '6': 'Charge', // Charges
        '7': 'Produit', // Produits
        '8': 'Mixte'   // Autres charges et produits
    };
    
    return natureSYSCOHADA[premierChiffre] || 'Ind√©fini';
}

/**
 * Calcule la p√©riode d'exercice SYSCOHADA
 * @param {Date} dateDebut - Date de d√©but d'exercice
 * @param {Date} dateFin - Date de fin d'exercice
 * @returns {Object} Informations sur la p√©riode
 */
function getPeriodeExercice(dateDebut = null, dateFin = null) {
    const maintenant = new Date();
    const anneeActuelle = maintenant.getFullYear();
    
    // Par d√©faut : exercice civil (1er janvier au 31 d√©cembre)
    const debut = dateDebut || new Date(anneeActuelle, 0, 1); // 1er janvier
    const fin = dateFin || new Date(anneeActuelle, 11, 31);   // 31 d√©cembre
    
    return {
        dateDebut: debut,
        dateFin: fin,
        exercice: anneeActuelle,
        duree: Math.ceil((fin - debut) / (1000 * 60 * 60 * 24)), // Dur√©e en jours
        libelle: `Exercice ${anneeActuelle}`,
        periode: `du ${debut.toLocaleDateString('fr-FR')} au ${fin.toLocaleDateString('fr-FR')}`
    };
}

/**
 * Valide l'√©quilibrage d'une √©criture SYSCOHADA
 * @param {Array} lignes - Lignes d'√©criture
 * @returns {Object} R√©sultat de validation
 */
function validateEcritureEquilibrage(lignes) {
    if (!Array.isArray(lignes) || lignes.length === 0) {
        return { 
            valide: false, 
            erreur: 'Aucune ligne d\'√©criture fournie',
            totalDebit: 0,
            totalCredit: 0,
            ecart: 0
        };
    }
    
    let totalDebit = 0;
    let totalCredit = 0;
    
    lignes.forEach(ligne => {
        totalDebit += (ligne.debit || 0);
        totalCredit += (ligne.credit || 0);
    });
    
    const ecart = Math.abs(totalDebit - totalCredit);
    const tolerance = 0.01; // Tol√©rance de 1 centime
    
    return {
        valide: ecart <= tolerance,
        erreur: ecart > tolerance ? `√âcriture non √©quilibr√©e - √âcart: ${ecart.toFixed(2)} FCFA` : null,
        totalDebit: totalDebit,
        totalCredit: totalCredit,
        ecart: ecart
    };
}

/**
 * G√©n√®re un num√©ro de pi√®ce SYSCOHADA conforme
 * @param {string} journal - Code journal
 * @param {number} numero - Num√©ro s√©quentiel
 * @param {Date} date - Date de l'√©criture
 * @returns {string} Num√©ro de pi√®ce format√©
 */
function generateNumeroPiece(journal, numero, date = new Date()) {
    const annee = date.getFullYear();
    const mois = String(date.getMonth() + 1).padStart(2, '0');
    const numeroFormate = String(numero).padStart(4, '0');
    
    return `${journal}-${annee}${mois}-${numeroFormate}`;
}

function exportPDF() { ... }

// ============================================================================
// FONCTIONS UTILITAIRES S√âCURIS√âES
// ============================================================================

/**
 * Ferme la modal de mani√®re s√©curis√©e
 */
function closeModal() {
    try {
        if (window.unifiedManager && window.unifiedManager.modalManager) {
            window.unifiedManager.modalManager.hide();
        } else {
            // Fallback: fermer manuellement si possible
            const modal = document.querySelector('.modal, [role="dialog"]');
            if (modal) {
                modal.style.display = 'none';
                modal.remove();
            }
        }
    } catch (error) {
        console.error('Erreur fermeture modal:', error);
    }
}

// ============================================================================
// SYST√àME DE MODALES PERSONNALIS√âES SYSCOHADA
// ============================================================================

/**
 * Gestionnaire de modales personnalis√©es pour SYSCOHADA
 */
const SYSCOHADAModalManager = {
    /**
     * Affiche une modal de confirmation
     * @param {string} message - Message de confirmation
     * @param {Function} onConfirm - Callback de confirmation
     * @param {Function} onCancel - Callback d'annulation (optionnel)
     */
    showConfirmDialog(message, onConfirm, onCancel = null) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.style.zIndex = '9999';
        
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4 animate-fade-in">
                <div class="flex items-center mb-4">
                    <div class="bg-warning/20 p-2 rounded-full mr-3">
                        <i class="fas fa-exclamation-triangle text-warning text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Confirmation requise</h3>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        Annuler
                    </button>
                    <button id="confirmBtn" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg transition-colors">
                        Confirmer
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Gestion des √©v√©nements
        modal.querySelector('#confirmBtn').onclick = () => {
            modal.remove();
            if (typeof onConfirm === 'function') onConfirm();
        };
        
        modal.querySelector('#cancelBtn').onclick = () => {
            modal.remove();
            if (typeof onCancel === 'function') onCancel();
        };
        
        // Fermer avec Escape
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', handleEscape);
                if (typeof onCancel === 'function') onCancel();
            }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Fermer en cliquant √† l'ext√©rieur
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.remove();
                if (typeof onCancel === 'function') onCancel();
            }
        };
    },
    
    /**
     * Affiche une modal d'alerte
     * @param {string} message - Message d'alerte
     * @param {string} type - Type d'alerte (success, error, warning, info)
     * @param {Function} onClose - Callback de fermeture (optionnel)
     */
    showAlert(message, type = 'info', onClose = null) {
        const typeConfig = {
            success: { icon: 'fa-check-circle', color: 'text-success', bg: 'bg-success/20' },
            error: { icon: 'fa-times-circle', color: 'text-danger', bg: 'bg-danger/20' },
            warning: { icon: 'fa-exclamation-triangle', color: 'text-warning', bg: 'bg-warning/20' },
            info: { icon: 'fa-info-circle', color: 'text-info', bg: 'bg-info/20' }
        };
        
        const config = typeConfig[type] || typeConfig.info;
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.style.zIndex = '9999';
        
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4 animate-fade-in">
                <div class="flex items-center mb-4">
                    <div class="${config.bg} p-2 rounded-full mr-3">
                        <i class="fas ${config.icon} ${config.color} text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Information</h3>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
                <div class="flex justify-end">
                    <button id="closeBtn" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg transition-colors">
                        OK
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Gestion des √©v√©nements
        const closeModal = () => {
            modal.remove();
            if (typeof onClose === 'function') onClose();
        };
        
        modal.querySelector('#closeBtn').onclick = closeModal;
        
        // Fermer avec Escape
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Fermer en cliquant √† l'ext√©rieur
        modal.onclick = (e) => {
            if (e.target === modal) closeModal();
        };
    },
    
    /**
     * Affiche une modal de saisie
     * @param {string} message - Message de demande
     * @param {string} placeholder - Placeholder du champ de saisie
     * @param {Function} onSubmit - Callback avec la valeur saisie
     * @param {Function} onCancel - Callback d'annulation (optionnel)
     */
    showPrompt(message, placeholder = '', onSubmit, onCancel = null) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.style.zIndex = '9999';
        
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4 animate-fade-in">
                <div class="flex items-center mb-4">
                    <div class="bg-info/20 p-2 rounded-full mr-3">
                        <i class="fas fa-edit text-info text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Saisie requise</h3>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                <input type="text" id="promptInput" 
                       placeholder="${placeholder}" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent mb-6">
                <div class="flex justify-end space-x-3">
                    <button id="cancelBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        Annuler
                    </button>
                    <button id="submitBtn" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg transition-colors">
                        Valider
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const input = modal.querySelector('#promptInput');
        input.focus();
        
        // Gestion des √©v√©nements
        const submitValue = () => {
            const value = input.value.trim();
            modal.remove();
            if (typeof onSubmit === 'function') onSubmit(value);
        };
        
        const cancelPrompt = () => {
            modal.remove();
            if (typeof onCancel === 'function') onCancel();
        };
        
        modal.querySelector('#submitBtn').onclick = submitValue;
        modal.querySelector('#cancelBtn').onclick = cancelPrompt;
        
        // Submit avec Entr√©e
        input.onkeypress = (e) => {
            if (e.key === 'Enter') submitValue();
        };
        
        // Fermer avec Escape
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                cancelPrompt();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Fermer en cliquant √† l'ext√©rieur
        modal.onclick = (e) => {
            if (e.target === modal) cancelPrompt();
        };
    }
};

// CSS pour l'animation
if (!document.querySelector('#syscohada-modal-styles')) {
    const style = document.createElement('style');
    style.id = 'syscohada-modal-styles';
    style.textContent = `
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in {
            animation: fade-in 0.2s ease-out;
        }
    `;
    document.head.appendChild(style);
}

// üîß FONCTION DE CORRECTION AUTOMATIQUE - √Ä ex√©cuter une seule fois
function applyCorrectionsToCode() {
    console.log('üöÄ Application des corrections SYSCOHADA...');
    
    // Mapping des corrections √† appliquer
    const corrections = {
        "safeExecute('generateBilan')": "safeExecute('generateBilanSYSCOHADA')",
        "safeExecute('generateTafire')": "safeExecute('generateTafireSYSCOHADA')",
        "safeExecute('generateCompteResultat')": "safeExecute('generateCompteResultatSYSCOHADA')",
        "safeExecute('generateGrandLivre')": "safeExecute('generateGrandLivreSYSCOHADA')",
        "safeExecute('generateBalance')": "safeExecute('generateBalanceSYSCOHADA')",
        "safeExecute('generateJournal')": "safeExecute('generateJournalSYSCOHADA')",
        "safeExecute('generateJournalReport')": "safeExecute('generateJournalReportSYSCOHADA')"
    };
    
    let correctionsApplied = 0;
    
    // Parcourir tous les scripts de la page
    document.querySelectorAll('script').forEach(script => {
        if (script.innerHTML.trim()) {
            let originalCode = script.innerHTML;
            let modifiedCode = originalCode;
            
            // Appliquer chaque correction
            Object.entries(corrections).forEach(([ancien, nouveau]) => {
                if (modifiedCode.includes(ancien)) {
                    modifiedCode = modifiedCode.replace(new RegExp(ancien.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), nouveau);
                    correctionsApplied++;
                    console.log(`‚úÖ Correction appliqu√©e: ${ancien} ‚Üí ${nouveau}`);
                }
            });
            
            // Remplacer le contenu du script si modifi√©
            if (originalCode !== modifiedCode) {
                script.innerHTML = modifiedCode;
            }
        }
    });
    
    console.log(`üéØ Total: ${correctionsApplied} corrections appliqu√©es avec succ√®s!`);
    console.log('üí° Actualisez la page pour voir les changements pris en compte.');
    
    // Marquer les corrections comme appliqu√©es
    localStorage.setItem('syscohada_corrections_applied', 'true');
}

// Auto-ex√©cution au chargement si pas encore appliqu√©es
if (!localStorage.getItem('syscohada_corrections_applied')) {
    // Attendre que le DOM soit charg√©
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyCorrectionsToCode);
    } else {
        applyCorrectionsToCode();
    }
}
    </script>     
</body>
</html>
