<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOUK√à Compta Pro - Syst√®me Comptable SYSCOHADA Int√©gr√©</title>

    <!-- ========================================= -->
    <!-- RESSOURCES EXTERNES                      -->
    <!-- ========================================= -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    
    <!-- ========================================= -->
    <!-- MODULES DE L'APPLICATION                 -->
    <!-- ========================================= -->
    <script src="auth.js" defer></script>
    <script src="financial-reports.js" defer></script>

    <!-- ========================================= -->
    <!-- CONFIGURATION TAILWIND                   -->
    <!-- ========================================= -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-light': '#8B8BF0',
                        'primary-dark': '#1E40AF',
                        secondary: '#1D4ED8',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        info: '#3B82F6'
                    }
                }
            }
        }
    </script>

    <!-- ========================================= -->
    <!-- STYLES PERSONNALIS√âS                     -->
    <!-- ========================================= -->
    <style>
        /* Animations */
        .fade-in { 
            animation: fadeIn 0.3s ease-in-out; 
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* Loading Spinner */
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #5D5CDE;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .error-state {
            border: 1px solid #EF4444;
            background-color: #FEF2F2;
        }
        
        .error-state.dark {
            background-color: #7F1D1D;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Modales */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-backdrop.show { 
            opacity: 1; 
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 1000;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        .modal.show { 
            transform: translate(-50%, -50%) scale(1); 
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .modal {
                max-width: 95vw;
                max-height: 95vh;
            }
        }
    </style>

    <!-- ========================================= -->
    <!-- GESTIONNAIRE D'√âTAT GLOBAL               -->
    <!-- ========================================= -->
    <script>
        // =============================================================================
        // üöÄ DOUK√à MODULE MANAGER - Hub Central de l'Application
        // =============================================================================
        
        console.log('üöÄ Initialisation DOUK√à Compta Pro v3.1...');

        // √âtat global de l'application
        window.app = {
            // Donn√©es principales
            accounts: [],
            companies: [],
            users: [],
            entries: [],
            cashRegisters: [],
            
            // √âtat de l'utilisateur
            currentUser: null,
            currentProfile: null,
            currentCompanyId: null,
            
            // Cache des donn√©es filtr√©es
            filteredData: {
                entries: [],
                accounts: [],
                reports: [],
                cashRegisters: [],
                users: [],
                lastUpdate: null,
                companyId: null
            },
            
            // Configuration
            isProduction: false,
            backendEnabled: false,
            lastSync: null,
            syncCount: 0,
            
            // Modules charg√©s
            modules: {
                auth: null,
                financialReports: null,
                core: null
            }
        };

        // Gestionnaire de communication inter-modules
        class ModuleCommunicator {
            constructor() {
                this.events = new Map();
                this.modules = new Map();
                console.log('üì° Module Communicator initialis√©');
            }

            // Enregistrer un module
            registerModule(name, module) {
                this.modules.set(name, module);
                console.log(`üì¶ Module "${name}" enregistr√©`);
                
                // D√©clencher l'√©v√©nement de module charg√©
                this.emit('moduleLoaded', { name, module });
            }

            // √âmettre un √©v√©nement
            emit(eventName, data = {}) {
                if (this.events.has(eventName)) {
                    this.events.get(eventName).forEach(callback => {
                        try {
                            callback(data);
                        } catch (error) {
                            console.error(`Erreur dans l'√©v√©nement ${eventName}:`, error);
                        }
                    });
                }
            }

            // √âcouter un √©v√©nement
            on(eventName, callback) {
                if (!this.events.has(eventName)) {
                    this.events.set(eventName, []);
                }
                this.events.get(eventName).push(callback);
            }

            // Obtenir un module
            getModule(name) {
                return this.modules.get(name);
            }

            // Appel s√©curis√© de fonction inter-modules
            safeCall(moduleName, functionName, ...args) {
                const module = this.modules.get(moduleName);
                if (module && typeof module[functionName] === 'function') {
                    try {
                        return module[functionName](...args);
                    } catch (error) {
                        console.error(`Erreur dans ${moduleName}.${functionName}:`, error);
                        throw error;
                    }
                } else {
                    throw new Error(`Fonction ${moduleName}.${functionName} introuvable`);
                }
            }
        }

        // Instance globale du communicateur
        window.moduleCommunicator = new ModuleCommunicator();

        // Wrapper de s√©curit√© pour toutes les fonctions
        window.safeExecute = function(functionName, ...args) {
            console.log(`üîç Ex√©cution s√©curis√©e: ${functionName}`, args);
            try {
                // 1. Chercher dans les modules
                for (const [moduleName, module] of window.moduleCommunicator.modules) {
                    if (module && typeof module[functionName] === 'function') {
                        return module[functionName](...args);
                    }
                }
                
                // 2. Chercher dans window
                if (typeof window[functionName] === 'function') {
                    return window[functionName](...args);
                }
                
                // 3. Fonction non trouv√©e
                console.error(`‚ùå Fonction ${functionName} introuvable`);
                if (window.app.modules.core && window.app.modules.core.notificationManager) {
                    window.app.modules.core.notificationManager.show('error', 'Erreur Fonction', `Fonction ${functionName} non disponible`);
                }
            } catch (error) {
                console.error(`‚ùå Erreur dans ${functionName}:`, error);
                if (window.app.modules.core && window.app.modules.core.notificationManager) {
                    window.app.modules.core.notificationManager.show('error', 'Erreur Syst√®me', error.message);
                }
            }
        };

        console.log('‚úÖ Hub central initialis√©');
    </script>

    <!-- ========================================= -->
    <!-- GESTIONNAIRE DE TH√àME                    -->
    <!-- ========================================= -->
    <script>
        const themeManager = {
            current: 'system',
            
            init() {
                if (localStorage.getItem('theme') === 'dark' ||
                    (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    this.current = 'dark';
                } else if (localStorage.getItem('theme') === 'light') {
                    document.documentElement.classList.remove('dark');
                    this.current = 'light';
                } else {
                    this.current = 'system';
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (this.current === 'system') {
                        if (event.matches) {
                            document.documentElement.classList.add('dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                        }
                    }
                });
            },
            
            setTheme(theme) {
                this.current = theme;
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else if (theme === 'light') {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    localStorage.removeItem('theme');
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            }
        };
        
        themeManager.init();
        
        // Fonctions globales de th√®me
        function toggleThemeMenu() {
            const menu = document.getElementById('themeMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        function setTheme(theme) {
            try {
                themeManager.setTheme(theme);
                document.getElementById('themeMenu').classList.add('hidden');
                if (window.app.modules.core && window.app.modules.core.notificationManager) {
                    window.app.modules.core.notificationManager.show('success', 'Th√®me modifi√©', `Th√®me ${theme} appliqu√© avec succ√®s`);
                }
            } catch (error) {
                console.error('Erreur changement th√®me:', error);
            }
        }
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <!-- ========================================= -->
    <!-- CONTENEURS SYST√àME                       -->
    <!-- ========================================= -->
    <div id="notificationsContainer"></div>
    <div id="modalContainer"></div>
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center space-x-4">
            <div class="loading-spinner"></div>
            <span class="text-gray-700 dark:text-gray-300">Chargement...</span>
        </div>
    </div>
    
    <!-- ========================================= -->
    <!-- INTERFACE DE CONNEXION                   -->
    <!-- ========================================= -->
    <div id="loginInterface" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary to-primary-light">
        <!-- L'interface de connexion sera charg√©e par auth.js -->
    </div>

    <!-- ========================================= -->
    <!-- INTERFACE PRINCIPALE                     -->
    <!-- ========================================= -->
    <div id="mainApp" class="hidden h-screen overflow-hidden">
        <div class="flex h-screen overflow-hidden">
            
            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg transform transition-transform duration-300 ease-in-out lg:translate-x-0 -translate-x-full fixed lg:static z-30 h-full">
                <!-- La sidebar sera g√©n√©r√©e par les modules -->
            </div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                
                <!-- Header -->
                <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
                    <!-- Le header sera g√©n√©r√© par les modules -->
                </header>

                <!-- Main Content Area -->
                <main class="flex-1 overflow-y-auto p-6">
                    <div id="mainContent">
                        <!-- Le contenu sera charg√© dynamiquement -->
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- INITIALISATION PRINCIPALE                -->
    <!-- ========================================= -->
    <script>
        // =============================================================================
        // INITIALISATION AU CHARGEMENT DE LA PAGE
        // =============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM charg√© - Initialisation des modules...');
            
            try {
                // Attendre que tous les modules soient charg√©s
                let modulesCharged = 0;
                const totalModules = 2; // auth.js et financial-reports.js
                
                window.moduleCommunicator.on('moduleLoaded', ({ name }) => {
                    modulesCharged++;
                    console.log(`üì¶ Module ${name} charg√© (${modulesCharged}/${totalModules})`);
                    
                    if (modulesCharged >= totalModules) {
                        initializeApplication();
                    }
                });
                
                // Timeout de s√©curit√©
                setTimeout(() => {
                    if (modulesCharged < totalModules) {
                        console.warn('‚ö†Ô∏è Timeout - Initialisation forc√©e');
                        initializeApplication();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('‚ùå Erreur au d√©marrage:', error);
                // Interface de secours
                document.body.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-red-50">
                        <div class="text-center p-8">
                            <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
                            <h1 class="text-2xl font-bold text-red-800 mb-2">Erreur de Chargement</h1>
                            <p class="text-red-600">Veuillez recharger la page ou contacter le support.</p>
                            <button onclick="location.reload()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                Recharger la page
                            </button>
                        </div>
                    </div>
                `;
            }
        });

        function initializeApplication() {
            console.log('üéØ Initialisation de l\'application principale...');
            
            try {
                // V√©rifier que les modules essentiels sont charg√©s
                const authModule = window.moduleCommunicator.getModule('auth');
                const financialModule = window.moduleCommunicator.getModule('financial-reports');
                
                if (authModule) {
                    console.log('‚úÖ Module d\'authentification pr√™t');
                    authModule.initialize();
                } else {
                    console.error('‚ùå Module d\'authentification non trouv√©');
                }
                
                if (financialModule) {
                    console.log('‚úÖ Module d\'√©tats financiers pr√™t');
                    financialModule.initialize();
                } else {
                    console.error('‚ùå Module d\'√©tats financiers non trouv√©');
                }

                // Gestion des √©v√©nements globaux
                setupGlobalEventHandlers();
                
                console.log('üéâ Application initialis√©e avec succ√®s !');
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
            }
        }

        function setupGlobalEventHandlers() {
            // Gestion du toggle sidebar mobile
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.toggle('-translate-x-full');
                    }
                });
            }
            
            // Fermeture des menus au clic ext√©rieur
            document.addEventListener('click', function(e) {
                const themeMenu = document.getElementById('themeMenu');
                const themeButton = e.target.closest('[onclick*="toggleThemeMenu"]');
                if (themeMenu && !themeMenu.contains(e.target) && !themeButton) {
                    themeMenu.classList.add('hidden');
                }
            });
            
            console.log('üéõÔ∏è Gestionnaires d\'√©v√©nements globaux configur√©s');
        }

        // Protection globale contre les erreurs
        window.addEventListener('error', function(e) {
            console.error('‚ùå Erreur globale captur√©e:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('‚ùå Promesse rejet√©e:', e.reason);
        });

        console.log('üéâ DOUK√à Compta Pro - Hub principal charg√© avec succ√®s');
    </script>
</body>
</html>







