// 1. Configuration du Client
generator client {
  provider = "prisma-client-js"
}

// 2. Configuration de la Base de Données
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================================
// ÉNUMÉRATIONS (Pour la cohérence des données)
// =========================================================================

enum Role {
  ADMIN
  COLLABORATEUR
  USER
  CAISSIER
}

enum SystemeComptable {
  NORMAL
  SMT
}

enum StatutEcriture {
  BROUILLON // Utilisé par le Caissier
  EN_ATTENTE // Saisi par User, en attente de validation
  VALIDE     // Validé par Admin ou Collaborateur
}

// =========================================================================
// MODÈLES DE DONNÉES
// =========================================================================

model User {
  id                    String    @id @default(cuid())
  utilisateurNom        String
  email                 String    @unique
  password              String
  utilisateurRole       Role      @default(USER)
  
  // --- GOUVERNANCE ---
  entrepriseContextId   String?   // ID de l'entreprise actuellement active
  
  // Relation avec les accès affectés par l'ADMIN (Multi-entreprises pour COLLABORATEUR)
  affectations          UserCompanyAccess[]
  
  // Pour le profil USER (Lien strict 1:1 géré par la logique métier)
  // entreprisesAccessibles est maintenu pour la compatibilité avec votre code actuel
  entreprisesAccessibles String[] 
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("users")
}

// Table pivot pour l'affectation des entreprises par l'ADMIN
model UserCompanyAccess {
  id          String   @id @default(cuid())
  userId      String
  companyId   String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedAt  DateTime @default(now())

  @@unique([userId, companyId])
  @@map("user_company_access")
}

model Company {
  id                String           @id @default(cuid())
  nom               String           @unique
  
  // --- PARAMÉTRAGE SYSCOHADA (Post-création) ---
  systemeComptable  SystemeComptable @default(NORMAL)
  dateDebutExercice DateTime
  exerciceCloture   Boolean          @default(false)
  
  devise            String           @default("XOF")
  statut            String           @default("Actif")
  administrateurId  String

  // Relations
  accounts          Account[]
  entries           Entry[]
  caisses           Caisse[]
  collaborateurs    UserCompanyAccess[]
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@map("companies")
}

model Account {
  id                 String   @id @default(cuid())
  numero             Int
  intitule           String
  classe             Int
  soldeInitialDebit  Float    @default(0)
  soldeInitialCredit Float    @default(0)

  // Relation avec Company
  companyId          String
  company            Company  @relation(fields: [companyId], references: [id])
  
  // Pour le profil CAISSIER : indique si ce compte est éligible à la liste auto-défilante
  isCashAccount      Boolean  @default(false)

  @@unique([companyId, numero], name: "compte_unique_par_entreprise")
  @@map("accounts")
}

model Caisse {
  id        String   @id @default(cuid())
  nom       String   // ex: "Caisse Principale", "Caisse Menue Fretin"
  code      String   // ex: "CAI01"
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  
  // Une caisse appartient à une entreprise, mais peut avoir plusieurs écritures
  entries   Entry[]

  @@map("caisses")
}

model Entry {
  id          String         @id @default(cuid())
  journalCode String
  date        DateTime
  pieceRef    String?
  status      StatutEcriture @default(EN_ATTENTE)
  
  // --- TRAÇABILITÉ ---
  companyId   String
  company     Company        @relation(fields: [companyId], references: [id])
  
  caisseId    String?        // Si l'écriture vient d'un CAISSIER
  caisse      Caisse?        @relation(fields: [caisseId], references: [id])

  lignes      Json           // Détails Débit/Crédit
  
  createdBy   String         // ID de l'utilisateur (Admin, Collaborateur, User ou Caissier)
  validatedBy String?        // ID de l'Admin ou Collaborateur qui a validé
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("entries")
}
