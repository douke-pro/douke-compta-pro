// Fichier : prisma/schema.prisma

// 1. Configuration du Client (pour l'API)
generator client {
  provider = "prisma-client-js"
}

// 2. Configuration de la Base de Données (PostgreSQL)
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================================
// MODÈLES DE DONNÉES (Remplacement des fichiers Mongoose)
// =========================================================================

// Modèle User
model User {
  id                     String   @id @default(cuid()) 
  utilisateurNom         String
  email                  String   @unique // Contrainte d'unicité
  password               String   // Hash (stocké en tant que string)
  utilisateurRole        String   @default("USER")
  entrepriseContextId    String? 
  // Dans PostgreSQL, les listes sont gérées par des tableaux de chaînes
  entreprisesAccessibles String[] 
  multiEntreprise        Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("users") // Nom de la table dans la DB
}

// Modèle Company (Entreprise)
model Company {
  id                     String   @id @default(cuid()) 
  nom                    String   @unique
  systemeComptable       String   @default("normal")
  devise                 String   @default("XOF")
  dateDebutExercice      DateTime
  statut                 String   @default("Actif")
  administrateurId       String 

  // Relations futures pour l'isolation (Plan Comptable, Écritures)
  accounts               Account[]
  entries                Entry[]
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("companies")
}

// Modèle Account (Plan Comptable)
model Account {
  id                    String   @id @default(cuid()) 
  // CORRECTION : Suppression de l'attribut @unique(name: "...") invalide. 
  // La contrainte combinée est définie en bas du bloc.
  numero                Int     
  intitule              String
  classe                Int
  soldeInitialDebit     Float    @default(0)
  soldeInitialCredit    Float    @default(0)

  // Relation avec Company
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id])
  
  // Clé unique composée : le numéro de compte doit être unique PAR entreprise.
  @@unique([companyId, numero], name: "compte_unique_par_entreprise")
  @@map("accounts")
}

// Modèle Entry (Écriture Journal)
model Entry {
  id                    String   @id @default(cuid()) 
  journalCode           String
  date                  DateTime
  pieceRef              String?
  status                String   @default("en attente")
  
  // Relation avec Company
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id])

  // Lignes d'écriture (JSON pour simplifier les lignes Débit/Crédit)
  lignes                Json
  
  createdBy             String
  validatedBy           String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("entries")
}
