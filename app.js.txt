// =============================================================================
// DOUK√à COMPTA PRO - APPLICATION PRINCIPALE
// =============================================================================

// Application State - √âTAT ORIGINAL COMPLET
const app = {
    currentProfile: null,
    currentCompany: null,
    currentUser: null,
    isAuthenticated: false,
    accounts: [],
    entries: [],
    companies: [],
    users: [],
    cashRegisters: [],
    companyLogo: null,
    notifications: [],
    deadlines: []
};

// Theme management - FONCTION ORIGINALE COMPL√àTE
const themeManager = {
    current: 'system',

    init() {
        // Detect initial theme
        if (localStorage.getItem('theme') === 'dark' ||
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            this.current = 'dark';
        } else if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
            this.current = 'light';
        } else {
            this.current = 'system';
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (this.current === 'system') {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
        });
    },

    setTheme(theme) {
        this.current = theme;
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else if (theme === 'light') {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        } else {
            localStorage.removeItem('theme');
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
    }
};

// THEME MANAGEMENT - FONCTION ORIGINALE COMPL√àTE
function toggleThemeMenu() {
    const menu = document.getElementById('themeMenu');
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

function setTheme(theme) {
    try {
        themeManager.setTheme(theme);
        document.getElementById('themeMenu').classList.add('hidden');
        showSuccessMessage('‚úÖ Th√®me modifi√© : ' + theme);
    } catch (error) {
        console.error('Erreur changement th√®me:', error);
    }
}

// EVENT LISTENERS & INITIALIZATION
function bindEventListeners() {
    try {
        // Company selector
        setTimeout(() => {
            const companySelect = document.getElementById('activeCompanySelect');
            if (companySelect) {
                companySelect.addEventListener('change', function(e) {
                    app.currentCompany = e.target.value;
                    updateSelectedCompanyInfo();
                    console.log('‚úÖ Entreprise s√©lectionn√©e:', app.currentCompany);
                });
            }
        }, 100);

        // Sidebar toggle
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.toggle('-translate-x-full');
                }
            });
        }

        // Login form
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
        }

        // Close sidebar on outside click (mobile)
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');

            if (window.innerWidth < 1024 && sidebar && sidebarToggle && !sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                sidebar.classList.add('-translate-x-full');
            }
        });
    } catch (error) {
        console.error('Erreur bindEventListeners:', error);
    }
}

function initializeApp() {
    try {
        console.log('üîÑ Initialisation de l\'application...');

        initializeData();
        loadNavigationMenu();
        updateUserInfo();
        loadDashboard();
        bindEventListeners();

        console.log('‚úÖ DOUK√à Compta Pro initialis√© avec succ√®s !');
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        showErrorMessage('Erreur lors de l\'initialisation de l\'application');
    }
}

// Close theme menu when clicking outside
document.addEventListener('click', function(e) {
    const menu = document.getElementById('themeMenu');
    const button = e.target.closest('[onclick="toggleThemeMenu()"]');
    if (menu && !menu.contains(e.target) && !button) {
        menu.classList.add('hidden');
    }

    // Close notifications panel when clicking outside
    const notifPanel = document.getElementById('notificationsPanel');
    const notifButton = e.target.closest('[onclick="toggleNotificationsPanel()"]');
    if (notifPanel && !notifPanel.contains(e.target) && !notifButton) {
        notifPanel.classList.add('hidden');
    }
});

// APPLICATION START
document.addEventListener('DOMContentLoaded', function() {
    try {
        themeManager.init();
        setTimeout(() => {
            bindEventListeners();
            console.log('üöÄ DOUK√à Compta Pro - Application d√©marr√©e avec toutes les fonctionnalit√©s restaur√©es');
        }, 100);
    } catch (error) {
        console.error('‚ùå Erreur au d√©marrage:', error);
    }
});

// Protection globale contre les erreurs
window.addEventListener('error', function(e) {
    console.error('‚ùå Erreur globale captur√©e:', e.error);
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('‚ùå Promesse rejet√©e:', e.reason);
});